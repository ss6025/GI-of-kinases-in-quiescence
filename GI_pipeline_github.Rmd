---
pdf_document: default
author: "Siyu Sun"
date: "6/12/2019"
output:
  html_notebook: default
  pdf_document: default
title: "R Notebook for GI-quiescent paper"
html_notebook: default
---

###Install necessary packages.
```{r include = F}
#source("https://bioconductor.org/biocLite.R")
#biocLite("qvalue")
#install_github("tidyverse/broom")
#install.packages("SuperExactTest")
library(DESeq2)
library(pheatmap)
library(reshape2)
library(cowplot) 
library(ggrepel)
library(tidyr)
library(dplyr)
library(readr)
library(tidyverse)
library(scales)
library(dplyr)
library(broom)
library(vegan)
library(gplots) 
library(magrittr)
library(devtools)
library(modelr)
library(GGally)
library(ggcorrplot)
library(qvalue)
library(ggpubr)
library(gridExtra)
library(matrixStats)
#source("https://bioconductor.org/biocLite.R")
#biocLite("vsn")
#install_github('sinhrks/ggfortify')
library(ggfortify)
library(devtools)
library(ggplot2)
library(vsn)
if (!requireNamespace("BiocManager", quietly = TRUE))
install.packages("BiocManager")
#BiocManager::install("clusterProfiler", version = "3.8")
library(clusterProfiler)
```

###A probability model for seeing 0 out of knowing genotype frequency ranging from 10-6 to 1 (According to reviewer #1's comments)
```{r}
table <- data_frame()
for (genotypefreq in seq(10^-6,1e-3,0.00000001)){
  p <- pbinom(0, size=1000000, prob=genotypefreq)
  df <- tibble(genotypefreq, p)
  table <- rbind(table,df)
  }

#probabilty of losing the genotype becomes too close to 0 when the genotype frequency is higher than 0.0007
write_csv(table, "./GI_quiescence/sum/reviewer/probability of barcode being zero.csv")

table<-read_csv("./GI_quiescence/sum/reviewer/probability of barcode being zero.csv")
#First subst the data and add the coordinates to make it shade to y = 0
#shade <- rbind(c(1e-6, 0), subset(table, genotypefreq < 4e-6), c(4e-6,0))
x <- 4e-6
y <- 0.01831549
coord <- paste(x,y,sep=",")

ggplot(table, aes(x=genotypefreq,y=p))+ 
  geom_line(aes(x=genotypefreq, y=p), size = 1) +
  #geom_bar(stat = "identity") +
  scale_x_log10() +
  #ylim(0,0)+
  ylab("Probability of losing the genotype") +
  xlab("Genotype frequency")+
  #Then use this new data.frame with geom_polygon
  #geom_polygon(data = shade, aes(genotypefreq, p*100), fill = "#CCCCCC") +
  #geom_vline(xintercept = 2e-04, col = "#CC0000", linetype = "dashed") +
  geom_segment(aes(x=4e-6, y=0, xend=4e-6, yend=0.01831549), linetype = "dashed", col = "blue") +
  geom_segment(aes(x=0, y=0.01831549, xend=4e-6, yend=0.01831549), linetype = "dashed", col = "blue") +
  #geom_label(aes(4.6e-6, 2, label=coord))+
  theme_bw()


ggsave("./GI_quiescence/sum/plot/Appendix/Appendix_reviewers/FigS1F.pdf", width = 6, height = 5)
```

###Read in counts files mapped by BARNONE and experiment annotation files
```{r}
#read in files for genenames and features
YtoGene <- read.table("./sum/data/YORFtoGENE_2018")
colnames(YtoGene)<-c("Strain","Common")
#this file can be read in later for gene name and systematic name converting

#set working directory:could be where you have download the package
datadir <- "./GI_quiescence/Raw data/"
#read in the colData after adding the new rows for N-lim ho, rim15, pho85 rerun on Mar 2019
index_file <- read_csv("./sum/data/GeneInter.csv")

index_c <- read_csv(paste0(datadir, "C-lim-4mutants/GeneInter_C_lim.csv"))

index_n <- read_csv(paste0(datadir, "N-lim-4mutants/GeneInter_N_lim.csv"))

index_n_new <- read_csv(paste0(datadir, "N-lim-3mutants/GeneInter_N_lim.csv"))

index_p <- read_csv(paste0(datadir, "P-lim-4mutants/GeneInter_P_lim.csv"))
#read in counts files out of Barnone with the pretested mismatches (2MM)
ct <-  read.table(paste0(datadir,"C-lim-4mutants/C_lim.barnone.2MM.counts.txt"), sep="\t", header = TRUE)
nt <-  read.table(paste0(datadir,"N-lim-4mutants/N_lim.barnone.2MM.counts.txt"), sep="\t", header = TRUE)
nt_new <-  read.table(paste0(datadir,"N-lim-3mutants/N_lim.barnone.2MM.counts.txt"), sep="\t", header = TRUE)
pt <-  read.table(paste0(datadir,"P-lim-4mutants/P_lim.barnone.2MM.counts.txt"), sep="\t", header = TRUE)
```

##Data transformation and filtering 
###filter out libraries with size smaller than 100,000 
```{r}
failed_lib_filtering <-  function(barnone_output,  nutrient) {
  ct_no0 = barnone_output
  
  #use first column Strain names as row names 
  rownames(ct_no0) <- ct_no0[,1]
  #remove the first column
  ct_no0_mt <- ct_no0[,-1]
  #add one more row for the sum 
  lib_size <- colSums(ct_no0_mt)
  
  #plot the distribution
  plot(density(log10(lib_size)), main=paste0("Library size distribution of ", nutrient))
  
  #save the libsize information into a data frame with corresponding growth conditions: carbon, nitrogen or phospahte
  lib_size <- as.data.frame(lib_size)
  lib_size[,ncol(lib_size)+1:2] <- c(rownames(lib_size), rep(nutrient, nrow(lib_size)))
  colnames(lib_size)[c(2,3)]<-c("lib_name","nutrient")
  #filtering the libraries the predefined size: 1e5
  pass_lib <- lib_size %>% dplyr::filter(lib_size > 100000)  
  ct_no0_df <- as.data.frame(t(ct_no0_mt))
  #add an extra column for adding infor of lib_names
  ct_no0_df[,ncol(ct_no0_df)+1] <- rownames(ct_no0_df)
  colnames(ct_no0_df)[ncol(ct_no0_df)] <- "lib_name"
  pass_lib <- dplyr::left_join(pass_lib, ct_no0_df, by = "lib_name")
  pass_lib <- pass_lib %>%
    unite(libname, lib_name, nutrient) %>%
    dplyr::select(-lib_size)
  rownames(pass_lib) <- pass_lib$libname
  pass_lib <- t(pass_lib[,-1])
  #add one column with the strain info
    #need to convert into dataframe first
  pass_lib <- as.data.frame(pass_lib)
  pass_lib[,ncol(pass_lib)+1] <- rownames(pass_lib)
  colnames(pass_lib)[ncol(pass_lib)] <- "Strain"
  return (pass_lib)
}

#set working directory
filtered_libs <- pmap(list(barnone_output=list(ct, nt, pt, nt_new),
                      nutrient=list('carbon','nitrogen','phosphate',"nitrogen.new")),
                  failed_lib_filtering)

filtered_libs_all <- left_join(left_join(filtered_libs[[1]], left_join(filtered_libs[[2]],filtered_libs[[3]], by = "Strain"), by = "Strain"), filtered_libs[[4]], by = "Strain")

write.csv(filtered_libs_all, file = "./GI_quiescence/sum/tables/filtered_raw_counts.csv")
```

##Counts merging for passed filter libraries (Up Tag + Down Tag)
```{r}
#read in the output of filtered libraries
filtered_libs_all<-read.csv("./GI_quiescence/sum/tables/filtered_raw_counts.csv")[,-1]
#split into UP and DOWN tag matrix for normalization
##reshape the dataframe
melt_filtered_file <- reshape2::melt(filtered_libs_all, id.vars="Strain", value.name="Counts")
#split the variable column into mutiple
melt_filtered_file[, ncol(melt_filtered_file)+1:3] <- reshape2::colsplit(melt_filtered_file$variable,"_", c("SampleNum","Tag","nutrient"))
#seperate into up and down frames

up_filtered <- melt_filtered_file %>%
  dplyr::select(-variable) %>%
  dplyr::filter(Tag == "UP") %>%
  dplyr::select(-Tag) %>%
  unite(variable, SampleNum, nutrient) %>%
  spread(key = variable, value = Counts)

dn_filtered <- melt_filtered_file %>%
  dplyr::select(-variable) %>%
  dplyr::filter(Tag == "DOWN") %>%
  dplyr::select(-Tag) %>%
  unite(variable, SampleNum, nutrient) %>%
  spread(key = variable, value = Counts)

#merge up and down tag counts together before normalization
add_filter <- inner_join(melt_filtered_file %>%
  dplyr::select(-variable) %>%
  dplyr::filter(Tag == "UP") %>%
  dplyr::select(-Tag) %>%
  unite(variable, SampleNum, nutrient), melt_filtered_file %>%
  dplyr::select(-variable) %>%
  dplyr::filter(Tag == "DOWN") %>%
  dplyr::select(-Tag) %>%
  unite(variable, SampleNum, nutrient), by=c('variable','Strain')) %>%
  mutate(Counts=Counts.x+Counts.y) %>%
  dplyr::select(-c(Counts.x, Counts.y)) %>%
  spread(key = variable, value = Counts)

write.csv(up_filtered, "./GI_quiescence/sum/tables/filtered_raw_counts_UPTAG.csv")
write.csv(dn_filtered, "./GI_quiescence/sum/tables/filtered_raw_counts_DNTAG.csv")
write.csv(add_filter, "./GI_quiescence/sum/tables/filtered_raw_counts_merged.csv")
```

##Counts normalization and variable stabilization transformation for all libraries after 1st filtering
##Figure 1B & Appendix figures 
###heatmaps & PCAs
```{r}
add_filter<-read.csv("./sum/tables/filtered_raw_counts_merged.csv")[,-1]

#assign the first column as row names
rownames(add_filter) <- add_filter$Strain

countdata <- add_filter %>%
  dplyr::select(-Strain) 

#add one for pseudocounts for log transformation.
countdata <- countdata+1

#save filtered countdata
write_csv(countdata, "./GI_quiescence/sum/tables/QC_countdata.csv")

countdata <- read_csv("./sum/tables/QC_countdata.csv")
#editing the index_file first to get the common columns representing the same information
index <- index_file %>%
  unite(Condition, SampleNum, nutrient)#, Replicate)
coldata <-index[,c(2,1,3,4,5)]

#matching the countdata and coldata
coldata <- subset(coldata, coldata$Condition %in% colnames(countdata))

# construct the DESeqDataSet object from the matrix of counts and the sample information table:
ddsMat <- DESeqDataSetFromMatrix(countData = countdata,
                                  colData = coldata, design = ~ LibraryName)
#prefiltering
keep <- rowSums(counts(ddsMat) > 4) >= 200
dds <- ddsMat[keep,]

#check how many mutants are left after filtering
nrow(dds) 
dds <- estimateSizeFactors(dds)

#vst transformation of the dataframe
vsd_local<-varianceStabilizingTransformation(dds, blind = FALSE, fitType = "local")

####deal with new vsd
vsd_local_df <- assay(vsd_local)
vsd_local_df <- data.frame(vsd_local_df)
df<-vsd_local_df

#QC plots after vst transformation
meanSdPlot(t(df))
barplot(log10(colSums(df)), ylab = "vsd library size")
barplot(log10(colMeans(df)), ylab = "log10(mean counts/library)")
barplot(log10(colSds(as.matrix(df))), ylab = "log10(mean counts/library)")

########
df[,ncol(df)+1] <- rownames(df)
colnames(df)[ncol(df)]<-"Strain"
vsd_melt_local <- reshape2::melt(df, id.vars="Strain", value.name="Counts")
colnames(vsd_melt_local)[2]<-"Condition"
colnames(vsd_melt_local)[1]<-"Strain"

#add info to normalized counts data that merged after VST transformation  
vsd_melt_in_local <- dplyr::left_join(vsd_melt_local, index, by="Condition") %>% 
      separate(Condition, c("SampleNum", "nutrient"), "_")

# dynamics of relative counts normalized to wildtype his3
tmp_vst<-left_join(vsd_melt_in_local, vsd_melt_in_local %>%
  dplyr::filter(Strain == "YOR202W"), by=c("LibraryName","SamplingTime","SampleNum","nutrient","scaled_time","GrowStage","Replicate"), suffix = c(".x",".his3")) %>%
  dplyr::mutate(Rela2WT= Counts.x/Counts.his3) %>%
  dplyr::select(-c(Strain.his3, Counts.his3)) %>%
  dplyr::rename(Counts = Counts.x, Strain = Strain.x)

colnames(YtoGene) <- c("Strain","Common")
VST_normalized<-left_join(tmp_vst, YtoGene, by = "Strain")

#rename new runs for ho, pho85 and rim15 
VST_normalized$Replicate[VST_normalized$Replicate =="1" & VST_normalized$nutrient == "nitrogen.new"] <- "4"
VST_normalized$Replicate[VST_normalized$Replicate =="2" & VST_normalized$nutrient == "nitrogen.new"] <- "5"
VST_normalized$Replicate[VST_normalized$Replicate =="3" & VST_normalized$nutrient == "nitrogen.new"] <- "6"

#replace nitrogen.new with nitrogen
VST_normalized$nutrient[VST_normalized$nutrient == "nitrogen.new"] <- "nitrogen"

###fitness caculation by linear regression modeling for each replicate during prolonged starvation
VST_lm_prolonged_rep_wtNormalized <- VST_normalized %>%
  dplyr::filter(SamplingTime %in% c("0","24","32","48","96","186","348")) %>%
  mutate(Days = SamplingTime/24) %>%
  dplyr::group_by(nutrient, Strain, LibraryName, Replicate) %>%
  drop_na() %>%
  do(tidy(lm(Rela2WT ~ Days, .))) %>% 
  ungroup() %>%
  dplyr::filter(term == "Days", !is.na(p.value)) %>%
  dplyr::mutate(q.value = qvalue(p.value, fdr.level=0.05, pi0.method="bootstrap")$qvalues)

write_csv(VST_lm_prolonged_rep_wtNormalized, "./sum/tables/Tableforfig1B.csv")
#plot PCA and heatmap function
#plot EV1D
input_table <-VST_lm_prolonged_rep_wtNormalized
  #reshapte the table for correlation caculation and visulization
  lm_wt_nutrient_corr <- input_table %>% 
    dplyr::select(nutrient, Strain, LibraryName, Replicate, estimate) %>%
    spread(key = nutrient, value = estimate) 

#replace the NA values in nitrogen new TOR1 library with the old nitrogen data
  fit_carbon <- lm_wt_nutrient_corr %>% 
    dplyr::select(-c(nitrogen, phosphate)) %>%
    drop_na() %>%
    unite(sample, LibraryName, Replicate, sep="_") %>%
    spread(key = sample, value = carbon) %>%
    drop_na()
  colnames(fit_carbon)[2:length(fit_carbon[,])] <- paste("carbon", colnames(fit_carbon)[2:length(fit_carbon[,])], sep = "_")

  fit_nitrogen_new <- lm_wt_nutrient_corr %>% 
    dplyr::select(-c(carbon, phosphate)) %>%
    drop_na() %>%
    unite(sample, LibraryName, Replicate, sep="_") %>%
    spread(key = sample, value = nitrogen) 
  colnames(fit_nitrogen_new)[2:length(fit_nitrogen_new[,])] <- paste("nitrogen", colnames(fit_nitrogen_new)[2:length(fit_nitrogen_new[,])], sep = "_")

  fit_phosphate <- lm_wt_nutrient_corr %>% 
    dplyr::select(-c(carbon, nitrogen)) %>%
    drop_na() %>%
    unite(sample, LibraryName, Replicate, sep="_") %>%
    spread(key = sample, value = phosphate) 
  colnames(fit_phosphate)[2:length(fit_phosphate[,])] <- paste("phosphate", colnames(fit_phosphate)[2:length(fit_phosphate[,])], sep = "_")

  fit_all<-left_join(left_join(fit_carbon, fit_nitrogen_new, 
                    by = "Strain"), fit_phosphate, by = "Strain") %>%
    drop_na()

#the column number here is determined by the conditions + replicates + mutant libraries
  dz <- data.frame(t(fit_all[,2:length(fit_all[,])]))
  dz[,ncol(dz)+1] <- rownames(dz)
  colnames(dz)[ncol(dz)] <- "condition"
  dz <- dz %>% 
    separate(condition, c("nutrient", "library", "rep"), sep = "_")

  dim(dz)

  l<-length(dz)-3
  
pdf("./GI_quiescence/sum/plot/Appendix_Figure1.pdf",width=7,height=5)
#the numbers in the range here is subject to the strains left after pre-filtering steps
autoplot(prcomp(dz[,c(1:l)]), data = dz, colour ='library') +
  xlim(c(-0.6,0.6)) +
  scale_color_manual(values=c("#ABC0F4" ,"#94ead1","#f4b8e6", "#fff388")) +
  scale_fill_manual(values=c("#ABC0F4","#94ead1","#f4b8e6",  "#fff388")) +
  ggtitle("OVERALL")

autoplot(prcomp(dz[c(1:12), c(1:l)]), data = dz[c(1:12),], colour ='library') +
  #xlim(c(-0.6,0.6)) +
  scale_color_manual(values=c("#ABC0F4" ,"#94ead1","#f4b8e6", "#fff388")) +
  scale_fill_manual(values=c("#ABC0F4","#94ead1","#f4b8e6",  "#fff388")) +
  ggtitle("Carbon")

autoplot(prcomp(dz[c(13:27),c(1:l)]), data = dz[c(13:27),], colour ='library') +
  #xlim(c(-0.6,0.6)) +
  scale_color_manual(values=c("#ABC0F4" ,"#94ead1","#f4b8e6", "#fff388")) +
  scale_fill_manual(values=c("#ABC0F4","#94ead1","#f4b8e6",  "#fff388")) +
  ggtitle("nitrogen")

autoplot(prcomp(dz[c(28:39),c(1:l)]), data = dz[c(28:39),], colour ='library') +
  #xlim(c(-0.6,0.6)) +
  scale_color_manual(values=c("#ABC0F4" ,"#94ead1","#f4b8e6", "#fff388")) +
  scale_fill_manual(values=c("#ABC0F4","#94ead1","#f4b8e6",  "#fff388")) +
  ggtitle("phosphorous")
dev.off()

#the numbers in the range here is subject to the strains left after pre-filtering steps 
  autoplot(prcomp(dz[,c(1:l)]), data = dz, colour ='library', shape = 'nutrient', size = 4) +
    #geom_text(hjust = 0, nudge_x = 0.05, label = rownames(dz))+
    #xlim(c(-0.6,0.6)) +
    scale_color_manual(values=c("#ABC0F4" ,"#94ead1","#f4b8e6", "#fff388")) +
    scale_fill_manual(values=c("#ABC0F4","#94ead1","#f4b8e6",  "#fff388")) +
    ggtitle("OVERALL") +
    theme_classic2()
 ggsave("./GI_quiescence/sum/plot/FigEV1D.pdf", width = 7, height = 5, useDingbats=FALSE)
 
#overall
#save filtered countdata
countdata <- read_csv("./GI_quiescence/sum/tables/QC_countdata.csv")
#read in the colData after adding the new rows for N-lim ho, rim15, pho85 rerun on Mar 2019
index_file <- read_csv("./GI_quiescence/sum/data/GeneInter.csv")
#editing the index_file first to get the common columns representing the same information
index <- index_file %>%
  unite(Condition, SampleNum, nutrient)#, Replicate)
  coldata <-index[,c(2,1,3,4,5)]

#matching the countdata and coldata
  coldata <- subset(coldata, coldata$Condition %in% colnames(countdata))

#rename new runs for pho85 and rim15 
  annotation_1 <- coldata %>% 
    separate(Condition, c("Sample_Num","nutrient"), sep = "_")

  annotation_1$Replicate[annotation_1$Replicate =="1" & annotation_1$nutrient == "nitrogen.new"] <- "4"
  annotation_1$Replicate[annotation_1$Replicate =="2" & annotation_1$nutrient == "nitrogen.new"] <- "5"
  annotation_1$Replicate[annotation_1$Replicate =="3" & annotation_1$nutrient == "nitrogen.new"] <- "6"

#replace nitrogen.new with nitrogen
  annotation_1$nutrient[annotation_1$nutrient == "nitrogen.new"] <- "nitrogen"

  annotation <- annotation_1 %>% # the coldata here is from previous Chunck ###read in pre-processed files and run DESeq2 normalization and vst transformation with local####
    unite(cond, nutrient, LibraryName, Replicate, remove = F) 

  annotation <- data.frame(unique(annotation$cond)) %>%
    separate(unique.annotation.cond., c("nutrient", "Library", "replicate"), sep = "_", remove = F)  

  rownames(annotation) <- annotation$unique.annotation.cond.

#remove the unnecessary coloumns
  annotation_col <- annotation %>% dplyr::select(nutrient, Library)
  
#remove nitrogen_HO_1,2,3[,14:16] & nitrogen_pho85_2[,21] & nitrogen_pho85_4[,23] &  nitrogen_rim15_1[,26] & phosphate_ho1[,35]
  breaksList = seq(-0.07, 0.07, by = 0.0001)

library_col<- c("#E5C494","#8DA0CB","#E78AC3","#66C2A5")
names(library_col) <- c("HO","TOR1","RIM15","PHO85")
nutrient_col <- c("#FFA500", "#7ACE0D", "#A564F9")
names(nutrient_col) <- c("carbon","nitrogen","phosphate")
anno_colors <- list(nutrient = nutrient_col, Library = library_col)
library(RColorBrewer)
pdf("./GI_quiescence/sum/plot/Fig1B.pdf")
  pheatmap(fit_all[,c(2:13,17:20,22,24:25,27:length(fit_all[,]))], 
           color = colorRampPalette(rev(brewer.pal(n =10, name = "RdYlBu")))(length(breaksList)), 
           annotation_col = annotation[,2:3], annotation_colors = anno_colors)
dev.off()

pdf("./GI_quiescence/sum/plot/Appendix_Figure2.pdf")
#cut by nutrient
#carbon
pheatmap(as.matrix(fit_all[,c(2:13)]), annotation_col = annotation[,2:3], color = colorRampPalette(rev(brewer.pal(n =10, name = "RdYlBu")))(length(breaksList)),annotation_colors = anno_colors, show_colnames = F)
#nitrogen
pheatmap(as.matrix(fit_all[,c(14:28)]), annotation_col = annotation[,2:3], color = colorRampPalette(rev(brewer.pal(n =10, name = "RdYlBu")))(length(breaksList)),annotation_colors = anno_colors, show_colnames = F)
#phosphate
pheatmap(as.matrix(fit_all[,c(29:length(fit_all[,]))]), annotation_col = annotation[,2:3], color = colorRampPalette(rev(brewer.pal(n =10, name = "RdYlBu")))(length(breaksList)),annotation_colors = anno_colors, show_colnames = F)

#cut by library
#HO
pheatmap(as.matrix(fit_all[,c(2:4,14:16,29:31)]),annotation_col = annotation[,2:3], color = colorRampPalette(rev(brewer.pal(n =10, name = "RdYlBu")))(length(breaksList)),annotation_colors = anno_colors, show_colnames = F)
#TOR1
pheatmap(as.matrix(fit_all[,c(11:13,26:28,38:40)]),annotation_col = annotation[,2:3], color = colorRampPalette(rev(brewer.pal(n =10, name = "RdYlBu")))(length(breaksList)),annotation_colors = anno_colors, show_colnames = F)
#RIM15
pheatmap(as.matrix(fit_all[,c(8:10,21:25,35:37)]),annotation_col = annotation[,2:3], color = colorRampPalette(rev(brewer.pal(n =10, name = "RdYlBu")))(length(breaksList)),annotation_colors = anno_colors, show_colnames = F)
#PHO85
pheatmap(as.matrix(fit_all[,c(5:7,17:19,32:34)]),annotation_col = annotation[,2:3], color = colorRampPalette(rev(brewer.pal(n =10, name = "RdYlBu")))(length(breaksList)),annotation_colors = anno_colors, show_colnames = F)
dev.off()
```

###remove poorly clusterd replicates then do counts normalization and variable stabilization transformation
##Fitness and survival estimation by linear regression modeling
#1. fitness estimation for whole growth stage for each replicates (Table S4)
```{r}
add_filter<-read.csv("./sum/tables/filtered_raw_counts_merged.csv")[,-1]

#assign the first column as row names
rownames(add_filter) <- add_filter$Strain

#remove list for removing N-rim15-1, N0-ho-2 , N-new-pho85-1 & N-pho85-2
remove_list_ho <- index_n %>% 
  unite(condition, SampleNum, nutrient) %>% 
  dplyr::filter(LibraryName == "HO" & Replicate %in% c("1","2","3")) %>% 
  dplyr::select(condition) %>%
  unlist() %>%
  as.vector()

remove_list_rim15 <- index_n %>% 
  unite(condition, SampleNum, nutrient) %>% 
  filter(LibraryName == "RIM15" & Replicate == 1) %>% 
  dplyr::select(condition) %>%
  unlist() %>%
  as.vector()

remove_list_pho85 <- index_n_new %>% 
  unite(condition, SampleNum, nutrient) %>% 
  filter(LibraryName == "PHO85" & Replicate == 1) %>% 
  dplyr::select(condition) %>%
  unlist() %>%
  as.vector()

remove_list_pho85_old <- index_n %>% 
  unite(condition, SampleNum, nutrient) %>% 
  filter(LibraryName == "PHO85" & Replicate == 2) %>% 
  dplyr::select(condition) %>%
  unlist() %>%
  as.vector()

remove_list <- c(remove_list_ho, remove_list_rim15, remove_list_pho85,remove_list_pho85_old)
maintain_list <- setdiff(names(add_filter)[-1],remove_list)

countdata <- add_filter %>%
  dplyr::select(-Strain) %>%
  #only selece the libraries that has passed the filtering 
  dplyr::select(one_of(maintain_list))

#add one for pseudocounts to eleminate the troubles when doing log transformation.
countdata <- countdata+1
#save filtered countdata
write_csv(countdata, "./sum/tables/countdata.csv")

#countdata <- read_csv("./sum/tables/countdata.csv")
#editing the index_file first to get the common columns representing the same information
index <- index_file %>%
  unite(Condition, SampleNum, nutrient)#, Replicate)
coldata <-index[,c(2,1,3,4,5)]

#matching the countdata and coldata
coldata <- subset(coldata, coldata$Condition %in% colnames(countdata))

# construct the DESeqDataSet object from the matrix of counts and the sample information table:
ddsMat <- DESeqDataSetFromMatrix(countData = countdata,
                                  colData = coldata, design = ~ LibraryName)

#prefiltering
keep <- rowSums(counts(ddsMat) >= 4) >= 200
dds <- ddsMat[keep,]

#check how many mutants are left after filtering
nrow(dds) 
dds <- estimateSizeFactors(dds)

#vst transformation of the dataframe
vsd_local<-varianceStabilizingTransformation(dds, blind = FALSE, fitType = "local")

####deal with new vsd
vsd_local_df <- assay(vsd_local)
vsd_local_df <- data.frame(vsd_local_df)
df<-vsd_local_df

#QC plots after vst transformation
meanSdPlot(t(df))
barplot(log10(colSums(df)), ylab = "vsd library size")
barplot(log10(colMeans(df)), ylab = "log10(mean counts/library)")
barplot(log10(colSds(as.matrix(df))), ylab = "log10(mean counts/library)")

########
df[,ncol(df)+1] <- rownames(df)
colnames(df)[ncol(df)]<-"Strain"
vsd_melt_local <- reshape2::melt(df, id.vars="Strain", value.name="Counts")
colnames(vsd_melt_local)[2]<-"Condition"
colnames(vsd_melt_local)[1]<-"Strain"

#add info to normalized counts data that merged after VST transformation  
vsd_melt_in_local <- left_join(vsd_melt_local, index, by="Condition") %>% 
    
vsd_melt_in_local <- vsd_melt_in_local %>% separate(Condition, c("SampleNum", "nutrient"), "_")

# dynamics of relative counts normalized to wildtype his3
tmp_vst<-left_join(vsd_melt_in_local, vsd_melt_in_local %>%
  dplyr::filter(Strain == "YOR202W"), by=c("LibraryName","SamplingTime","SampleNum","nutrient","scaled_time","GrowStage","Replicate"), suffix = c(".x",".his3")) %>%
  dplyr::mutate(Rela2WT= Counts.x/Counts.his3) %>%
  dplyr::select(-c(Strain.his3, Counts.his3)) %>%
  dplyr::rename(Counts = Counts.x, Strain = Strain.x)

colnames(YtoGene) <- c("Strain","Common")
VST_normalized_filtered<-left_join(tmp_vst, YtoGene, by = "Strain")

#rename new runs for ho, pho85 and rim15 
VST_normalized_filtered$Replicate[VST_normalized_filtered$Replicate =="1" & VST_normalized_filtered$nutrient == "nitrogen.new"] <- "4"
VST_normalized_filtered$Replicate[VST_normalized_filtered$Replicate =="2" & VST_normalized_filtered$nutrient == "nitrogen.new"] <- "5"
VST_normalized_filtered$Replicate[VST_normalized_filtered$Replicate =="3" & VST_normalized_filtered$nutrient == "nitrogen.new"] <- "6"

#replace nitrogen.new with nitrogen
VST_normalized_filtered$nutrient[VST_normalized_filtered$nutrient == "nitrogen.new"] <- "nitrogen"

#save normalized table as TableS3
write_csv(VST_normalized_filtered, "./sum/tables/TableS3.csv")

###fitness caculation by linear regression modeling for each replicate during prolonged starvation
VST_lm_prolonged_rep_wtNormalized_filtered <- VST_normalized_filtered %>%
  dplyr::filter(SamplingTime %in% c("0","24","32","48","96","186","348")) %>%
  mutate(Days = SamplingTime/24) %>%
  dplyr::group_by(nutrient, Strain, LibraryName, Replicate) %>%
  drop_na() %>%
  do(tidy(lm(Rela2WT ~ Days, .))) %>% 
  ungroup() %>%
  dplyr::filter(term == "Days", !is.na(p.value)) %>%
  dplyr::mutate(q.value = qvalue(p.value, fdr.level=0.05, pi0.method="bootstrap")$qvalues)

#save the file with modeling data
write.csv(VST_lm_prolonged_rep_wtNormalized_filtered, "./sum/tables/TableS4.csv")

#VST_lm_prolonged_rep_wtNormalized_filtered <- read_csv("./sum/tables/TableS4.csv")

#plot PCA and heatmap function
#plot EV1D
input_table <-VST_lm_prolonged_rep_wtNormalized_filtered
  #reshapte the table for correlation caculation and visulization
  lm_wt_nutrient_corr <- input_table %>% 
    dplyr::select(nutrient, Strain, LibraryName, Replicate, Rela2WT) %>%
    spread(key = nutrient, value = Rela2WT) 

#replace the NA values in nitrogen new TOR1 library with the old nitrogen data
  fit_carbon <- lm_wt_nutrient_corr %>% 
    dplyr::select(-c(nitrogen, phosphate)) %>%
    drop_na() %>%
    unite(sample, LibraryName, Replicate, sep="_") %>%
    spread(key = sample, value = carbon) %>%
    drop_na()
  colnames(fit_carbon)[2:length(fit_carbon[,])] <- paste("carbon", colnames(fit_carbon)[2:length(fit_carbon[,])], sep = "_")

  fit_nitrogen_new <- lm_wt_nutrient_corr %>% 
    dplyr::select(-c(carbon, phosphate)) %>%
    drop_na() %>%
    unite(sample, LibraryName, Replicate, sep="_") %>%
    spread(key = sample, value = nitrogen) 
  colnames(fit_nitrogen_new)[2:length(fit_nitrogen_new[,])] <- paste("nitrogen", colnames(fit_nitrogen_new)[2:length(fit_nitrogen_new[,])], sep = "_")

  fit_phosphate <- lm_wt_nutrient_corr %>% 
    dplyr::select(-c(carbon, nitrogen)) %>%
    drop_na() %>%
    unite(sample, LibraryName, Replicate, sep="_") %>%
    spread(key = sample, value = phosphate) 
  colnames(fit_phosphate)[2:length(fit_phosphate[,])] <- paste("phosphate", colnames(fit_phosphate)[2:length(fit_phosphate[,])], sep = "_")

  fit_all<-left_join(left_join(fit_carbon, fit_nitrogen_new, 
                    by = "Strain"), fit_phosphate, by = "Strain") %>%
    drop_na()

#the column number here is determined by the conditions + replicates + mutant libraries
  dz <- data.frame(t(fit_all[,2:length(fit_all[,])]))
  dz[,ncol(dz)+1] <- rownames(dz)
  colnames(dz)[ncol(dz)] <- "condition"
  dz <- dz %>% 
    separate(condition, c("nutrient", "library", "rep"), sep = "_")

  dim(dz)

  l<-length(dz)-3
  
pdf("./GI_quiescence/sum/plot/Appendix_Figure1.pdf",width=7,height=5)
#the numbers in the range here is subject to the strains left after pre-filtering steps
autoplot(prcomp(dz[,c(1:l)]), data = dz, colour ='library') +
  xlim(c(-0.6,0.6)) +
  scale_color_manual(values=c("#ABC0F4" ,"#94ead1","#f4b8e6", "#fff388")) +
  scale_fill_manual(values=c("#ABC0F4","#94ead1","#f4b8e6",  "#fff388")) +
  ggtitle("OVERALL")

autoplot(prcomp(dz[c(1:12), c(1:l)]), data = dz[c(1:12),], colour ='library') +
  #xlim(c(-0.6,0.6)) +
  scale_color_manual(values=c("#ABC0F4" ,"#94ead1","#f4b8e6", "#fff388")) +
  scale_fill_manual(values=c("#ABC0F4","#94ead1","#f4b8e6",  "#fff388")) +
  ggtitle("Carbon")

autoplot(prcomp(dz[c(13:27),c(1:l)]), data = dz[c(13:27),], colour ='library') +
  #xlim(c(-0.6,0.6)) +
  scale_color_manual(values=c("#ABC0F4" ,"#94ead1","#f4b8e6", "#fff388")) +
  scale_fill_manual(values=c("#ABC0F4","#94ead1","#f4b8e6",  "#fff388")) +
  ggtitle("nitrogen")

autoplot(prcomp(dz[c(28:39),c(1:l)]), data = dz[c(28:39),], colour ='library') +
  #xlim(c(-0.6,0.6)) +
  scale_color_manual(values=c("#ABC0F4" ,"#94ead1","#f4b8e6", "#fff388")) +
  scale_fill_manual(values=c("#ABC0F4","#94ead1","#f4b8e6",  "#fff388")) +
  ggtitle("phosphorous")
dev.off()

#the numbers in the range here is subject to the strains left after pre-filtering steps 
  autoplot(prcomp(dz[,c(1:l)]), data = dz, colour ='library', shape = 'nutrient', size = 4) +
    #geom_text(hjust = 0, nudge_x = 0.05, label = rownames(dz))+
    #xlim(c(-0.6,0.6)) +
    scale_color_manual(values=c("#ABC0F4" ,"#94ead1","#f4b8e6", "#fff388")) +
    scale_fill_manual(values=c("#ABC0F4","#94ead1","#f4b8e6",  "#fff388")) +
    ggtitle("OVERALL") +
    theme_classic2()
 ggsave("./GI_quiescence/sum/plot/FigEV1D.pdf", width = 7, height = 5, useDingbats=FALSE)
 
#overall
#save filtered countdata
countdata <- read_csv("./GI_quiescence/sum/tables/countdata.csv")
#read in the colData after adding the new rows for N-lim ho, rim15, pho85 rerun on Mar 2019
index_file <- read_csv("./GI_quiescence/sum/data/GeneInter.csv")
#editing the index_file first to get the common columns representing the same information
index <- index_file %>%
  unite(Condition, SampleNum, nutrient)#, Replicate)
  coldata <-index[,c(2,1,3,4,5)]

#matching the countdata and coldata
  coldata <- subset(coldata, coldata$Condition %in% colnames(countdata))

#rename new runs for pho85 and rim15 
  annotation_1 <- coldata %>% 
    separate(Condition, c("Sample_Num","nutrient"), sep = "_")

  annotation_1$Replicate[annotation_1$Replicate =="1" & annotation_1$nutrient == "nitrogen.new"] <- "4"
  annotation_1$Replicate[annotation_1$Replicate =="2" & annotation_1$nutrient == "nitrogen.new"] <- "5"
  annotation_1$Replicate[annotation_1$Replicate =="3" & annotation_1$nutrient == "nitrogen.new"] <- "6"

#replace nitrogen.new with nitrogen
  annotation_1$nutrient[annotation_1$nutrient == "nitrogen.new"] <- "nitrogen"

  annotation <- annotation_1 %>% # the coldata here is from previous Chunck ###read in pre-processed files and run DESeq2 normalization and vst transformation with local####
    unite(cond, nutrient, LibraryName, Replicate, remove = F) 

  annotation <- data.frame(unique(annotation$cond)) %>%
    separate(unique.annotation.cond., c("nutrient", "Library", "replicate"), sep = "_", remove = F)  

  rownames(annotation) <- annotation$unique.annotation.cond.

#remove the unnecessary coloumns
  annotation_col <- annotation %>% dplyr::select(nutrient, Library)
  
#remove nitrogen_HO_1,2,3[,14:16] & nitrogen_pho85_2[,21] & nitrogen_pho85_4[,23] &  nitrogen_rim15_1[,26] & phosphate_ho1[,35]
breaksList = seq(-0.07, 0.07, by = 0.0001)
library_col<- c("#E5C494","#8DA0CB","#E78AC3","#66C2A5")
names(library_col) <- c("HO","TOR1","RIM15","PHO85")
nutrient_col <- c("#FFA500", "#7ACE0D", "#A564F9")
names(nutrient_col) <- c("carbon","nitrogen","phosphate")
anno_colors <- list(nutrient = nutrient_col, Library = library_col)
library(RColorBrewer)
pdf("./GI_quiescence/sum/plot/Fig1B.pdf")
  pheatmap(fit_all[,2:length(fit_all[,])], 
           color = colorRampPalette(rev(brewer.pal(n =10, name = "RdYlBu")))(length(breaksList)), 
           annotation_col = annotation[,2:3], annotation_colors = anno_colors)
dev.off()

pdf("./GI_quiescence/sum/plot/Appendix_Figure2.pdf")
#cut by nutrient
#carbon
pheatmap(as.matrix(fit_all[,c(2:13)]), annotation_col = annotation[,2:3], color = colorRampPalette(rev(brewer.pal(n =10, name = "RdYlBu")))(length(breaksList)),annotation_colors = anno_colors, show_colnames = F)
#nitrogen
pheatmap(as.matrix(fit_all[,c(14:28)]), annotation_col = annotation[,2:3], color = colorRampPalette(rev(brewer.pal(n =10, name = "RdYlBu")))(length(breaksList)),annotation_colors = anno_colors, show_colnames = F)
#phosphate
pheatmap(as.matrix(fit_all[,c(29:length(fit_all[,]))]), annotation_col = annotation[,2:3], color = colorRampPalette(rev(brewer.pal(n =10, name = "RdYlBu")))(length(breaksList)),annotation_colors = anno_colors, show_colnames = F)

#cut by library
#HO
pheatmap(as.matrix(fit_all[,c(2:4,14:16,29:31)]),annotation_col = annotation[,2:3], color = colorRampPalette(rev(brewer.pal(n =10, name = "RdYlBu")))(length(breaksList)),annotation_colors = anno_colors, show_colnames = F)
#TOR1
pheatmap(as.matrix(fit_all[,c(11:13,26:28,38:40)]),annotation_col = annotation[,2:3], color = colorRampPalette(rev(brewer.pal(n =10, name = "RdYlBu")))(length(breaksList)),annotation_colors = anno_colors, show_colnames = F)
#RIM15
pheatmap(as.matrix(fit_all[,c(8:10,21:25,35:37)]),annotation_col = annotation[,2:3], color = colorRampPalette(rev(brewer.pal(n =10, name = "RdYlBu")))(length(breaksList)),annotation_colors = anno_colors, show_colnames = F)
#PHO85
pheatmap(as.matrix(fit_all[,c(5:7,17:19,32:34)]),annotation_col = annotation[,2:3], color = colorRampPalette(rev(brewer.pal(n =10, name = "RdYlBu")))(length(breaksList)),annotation_colors = anno_colors, show_colnames = F)
dev.off()
```

#2. fitness estimation for whole growth stage across all replicates (Table S5)
```{r, include = F}
#save the files with relabed replicates 
VST_normalized_filtered <- read_csv("./GI_quiescence/sum/tables/TableS3.csv")

##fitness estimation for prolonged starvation across all replicates 
VST_lm_prolonged_wtNormalized <- VST_normalized_filtered %>%
  dplyr::filter(SamplingTime %in% c("0","24","32","48","96","186","348")) %>%
  mutate(Days = SamplingTime/24) %>%
  dplyr::group_by(nutrient, Strain, LibraryName) %>%
  drop_na() %>%
  do(tidy(lm(Rela2WT ~ Days, .))) %>% 
  ungroup() %>%
  dplyr::filter(term == "Days", !is.na(p.value)) %>%
  dplyr::mutate(q.value = qvalue(p.value, fdr.level=0.05, pi0.method="bootstrap")$qvalues)

VST_lm_prolonged_wtNormalized <- left_join(VST_lm_prolonged_wtNormalized, YtoGene, by ="Strain")

#save the file
write.csv(VST_lm_prolonged_wtNormalized, "./GI_quiescence/sum/tables/TableS5.csv")
```

##Figure 1C: 
###caculate the fitness based on all replicates for individual mutant
```{r, echo =F}
VST_normalized_filtered <- read_csv("./sum/tables/TableS3.csv")[,-1]
VST_lm_prolonged_wtNormalized <- read_csv("./GI_quiescence/sum/tables/TableS5csv")[,-1]
#function to plot individual mutant's fitness changes over time 
individual_plot <- function(df, gene, fitness){
  p1 <- df %>%
    filter(LibraryName == "HO", Common == gene) %>% 
    ggplot(aes(x=SamplingTime, y=Counts, group=nutrient, color=nutrient)) +
    geom_point(aes(shape = nutrient))+
    geom_smooth(method = "lm", aes(fill=nutrient), se = FALSE)+
    ggtitle(gene)+  
    xlab("Hours post inoculation")+
    ylab("Normalized counts")+
    scale_color_manual(values=c("#FFA500", "#7ACE0D", "#A564F9"))+
    scale_fill_manual(values=c("#FFA500", "#7ACE0D", "#A564F9"))+
    theme(axis.text.x=element_text(angle=0),legend.position="bottom")+
    theme_classic()
  
#rela
  p2 <- df %>%
    filter(LibraryName == "HO", Common == gene)%>%
    filter(SamplingTime %in% c("0","24","32","48","96","186","348")) %>%
    ggplot(aes(x=SamplingTime, y=Rela2WT, group=nutrient, color=nutrient)) +
    geom_point(aes(shape = nutrient))+
    geom_smooth(method = "lm", aes(fill=nutrient))+#, se = FALSE)+
    ggtitle(paste0(gene, " relative"))+  
    xlab("Hours post inoculation")+
    ylab("Relative frequency to wild-type")+
    scale_color_manual(values=c("#FFA500", "#7ACE0D", "#A564F9"))+
    scale_fill_manual(values=c("#FFA500", "#7ACE0D", "#A564F9"))+
    theme(axis.text.x=element_text(angle=0),legend.position="right")+
    theme_classic()
  
  p3 <- df %>%
    filter(LibraryName == "HO", Common == gene)%>%
    ggplot(aes(x=SamplingTime, y=Rela2WT, group=nutrient, color=nutrient)) +
    geom_point(aes(shape = nutrient))+
    geom_smooth(method = "lm", aes(fill=nutrient))+
    ggtitle(paste0(gene, " relative"))+  
    xlab("Hours post inoculation")+
    ylab("Relative frequency to wild-type")+
    scale_color_manual(values=c("#FFA500", "#7ACE0D", "#A564F9"))+
    scale_fill_manual(values=c("#FFA500", "#7ACE0D", "#A564F9"))+
    facet_wrap(~GrowStage, scales = "free_x") +
    theme(axis.text.x=element_text(angle=0),legend.position="bottom")+
    theme_classic()

    p4 <- df %>%
    filter(LibraryName == "HO", Common == gene)%>%
    ggplot(aes(x=SamplingTime, y=Counts, group=nutrient, color=nutrient)) +
    geom_point(aes(shape = nutrient))+
    geom_smooth(method = "lm", aes(fill=nutrient))+
    ggtitle(paste0(gene, "Counts"))+  
    xlab("Hours post inoculation")+
    ylab("Normalized counts")+
    scale_color_manual(values=c("#FFA500", "#7ACE0D", "#A564F9"))+
    scale_fill_manual(values=c("#FFA500", "#7ACE0D", "#A564F9"))+
    facet_grid(~GrowStage, scales = "free") +
    theme(axis.text.x=element_text(angle=0),legend.position="bottom")+
      theme_classic()
  if (fitness == "counts") {
    print(p1)
  }
  if (fitness == "rela"){
    print(p2)
  }
  if (fitness == "counts_stage") {
    print(p4)
  }
  if (fitness == "rela_stage") {
    print(p3)
  }
}

individual_plot(VST_normalized_filtered, "ATG3","rela")
ggsave("./GI_quiescence/sum/plot/Fig1C_left.pdf", width = 7, height = 5)

#caculate the confidence interval for individual gene slopes 
individual_dotplot <- function(gene){
  c <- VST_normalized_filtered %>%
    filter(SamplingTime %in% c("0","24","32","48","96","186","348")) %>%
    filter(LibraryName == "HO" & Common == gene & nutrient =="carbon") %>%
    mutate(Days = SamplingTime/24) %>%
    group_by(nutrient, LibraryName, Strain) %>%
    lm(Rela2WT ~ Days, .)

 n <-VST_normalized_filtered %>%
   filter(SamplingTime %in% c("0","24","32","48","96","186","348")) %>%
   filter(LibraryName == "HO" & Common == gene & nutrient =="nitrogen") %>%
   mutate(Days = SamplingTime/24) %>%
   group_by(nutrient, LibraryName, Strain) %>%
   lm(Rela2WT ~ Days, .)

 p <-VST_normalized_filtered %>%
   filter(SamplingTime %in% c("0","24","32","48","96","186","348")) %>%
   filter( LibraryName == "HO" & Common == gene & nutrient =="phosphate") %>%
   mutate(Days = SamplingTime/24) %>%
   group_by(nutrient, LibraryName, Strain) %>%
   lm(Rela2WT ~ Days, .)

#caculate the 95% confidence interval
 low_c<-confint(c,level=0.95)[2,1]
 high_c<-confint(c,level=0.95)[2,2]

 low_n<-confint(n,level=0.95)[2,1]
 high_n<-confint(n,level=0.95)[2,2]

 low_p<-confint(p,level=0.95)[2,1]
 high_p<-confint(p,level=0.95)[2,2]

#put all data into one dataframe
 df<-VST_lm_prolonged_wtNormalized %>% 
   dplyr::filter(LibraryName == "HO" & Common == gene) %>%
   dplyr::mutate(low_CI = c(low_c, low_n, low_p), high_CI = c(high_c, high_n, high_p)) 

#extract the fitness for TOR1 in ho and barplot it

 p <- ggplot(df, aes(x=nutrient, y=estimate, fill=nutrient)) +
   ggtitle(paste0(gene,"single KO")) +
   geom_hline(yintercept=0, col="grey", linetype = "dashed") +
   geom_point(aes(col = nutrient, size=1))+
   geom_errorbar(aes(ymin = low_CI, ymax = high_CI, col = nutrient), width = 0.2)+
   scale_color_manual(values=c("#FFA500", "#7ACE0D", "#A564F9")) +
   scale_fill_manual(values=c("#FFA500", "#7ACE0D", "#A564F9"))+
   ylab("Fitness")+
   theme_classic()
  print(p)
  
  ggsave(plot=p, file = "./GI_quiescence/sum/plot/Fig1C_right.pdf",width=7,height=5)
}

individual_dotplot("ATG3")
```

#3. fitness estimation for proliferation and queiscence stage separatly for each replicates (Table S6)
```{r}
##############################################################################################
# read in the dataframe after filtered out HO rep2 and RIM15 rep2
VST_normalized_filtered <- read_csv("./GI_quiescence/sum/tables/TableS3.csv")[,-1]

# change HO library in nitrogen sample replicates from 4,5,6 into 1,2,3
VST_normalized_filtered$Replicate[VST_normalized_filtered$nutrient == "nitrogen" & VST_normalized_filtered$LibraryName == "HO" & VST_normalized_filtered$Replicate == "4"] <- "1"
VST_normalized_filtered$Replicate[VST_normalized_filtered$nutrient == "nitrogen" & VST_normalized_filtered$LibraryName == "HO" & VST_normalized_filtered$Replicate == "5"] <- "2"
VST_normalized_filtered$Replicate[VST_normalized_filtered$nutrient == "nitrogen" & VST_normalized_filtered$LibraryName == "HO" & VST_normalized_filtered$Replicate == "6"] <- "3"

# change RIM15 library in nitrogen sample replicates from 2,3,4,5,6 to 1,2,3,4,5
VST_normalized_filtered$Replicate[VST_normalized_filtered$nutrient == "nitrogen" & VST_normalized_filtered$LibraryName == "RIM15" & VST_normalized_filtered$Replicate == "6"] <- "1"

# change PHO85 library in nitrogen sample replicates from 1,3,5,6 to 1,2,3,4
VST_normalized_filtered$Replicate[VST_normalized_filtered$nutrient == "nitrogen" & VST_normalized_filtered$LibraryName == "PHO85" & VST_normalized_filtered$Replicate == "5"] <- "2"
VST_normalized_filtered$Replicate[VST_normalized_filtered$nutrient == "nitrogen" & VST_normalized_filtered$LibraryName == "PHO85" & VST_normalized_filtered$Replicate == "6"] <- "4"

##save the files with relabed replicates after removing poor quality libraries.
write_csv(VST_normalized_filtered, "./GI_quiescence/sum/tables/TableS3.csv")[,-1]

#fitness for different stages
VST_lm_stages_wtNormalized_rep <- VST_normalized_filtered %>%
      group_by(nutrient, Strain, LibraryName, GrowStage, Replicate) %>%
      do(tidy(lm(Rela2WT ~ scaled_time, .))) %>%
      filter(term == "scaled_time") %>%
      ungroup() %>%
      filter(term == "scaled_time", !is.na(p.value)) %>%
      mutate(q.value = qvalue(p.value, fdr.level=0.05, pi0.method="bootstrap")$qvalues)

##################################save files 
write.csv(VST_lm_stages_wtNormalized_rep, "./GI_quiescence/sum/tables/TableS6.csv")
```

#4. fitness estimation for proliferation and quiescence stage separatly across all replicates (Table S7)
```{r}
VST_normalized_filtered<-read_csv("./GI_quiescence/sum/tables/TableS3.csv")
#fitness for different stages
VST_lm_stages_wtNormalized <- VST_normalized_filtered %>%
      group_by(nutrient, Strain, LibraryName, GrowStage) %>%
      do(tidy(lm(Rela2WT ~ scaled_time, .))) %>%
      filter(term == "scaled_time") %>%
      ungroup() %>%
      filter(term == "scaled_time", !is.na(p.value)) %>%
      mutate(q.value = qvalue(p.value, fdr.level=0.05, pi0.method="bootstrap")$qvalues)

##################################save files 
write.csv(VST_lm_stages_wtNormalized, "./GI_quiescence/sum/tables/TableS7.csv")
```

###Figure 1B_reviewer & Appendix figures 20191107
```{r}
VST_lm_stage_wtNormalized_filtered <- read_csv("./sum/tables/TableS7.csv")[,-1]

VST_lm_stage_wtNormalized_filtered %>% 
  ggplot(aes(x=estimate, col= GrowStage, fill=GrowStage)) +
  theme_bw(base_size=6) +
  theme(axis.text.x=element_text(angle=90, size=6), panel.grid.major = element_blank()) +
  ggtitle("Fitness Distribution") +
  geom_vline(xintercept=0, col="grey", linetype="dashed") +
  ylab("Frequency") +
  xlab("Fitness") +
  geom_density(alpha = 0.1) +
  facet_grid(LibraryName~nutrient) +
  scale_color_manual(values=c("#E5C494","#8DA0CB","#E78AC3","#66C2A5"))+
  scale_fill_manual(values=c("#E5C494","#8DA0CB","#E78AC3","#66C2A5"))

#reshapte the table for correlation caculation and visulization
lm_wt_nutrient_corr <- VST_lm_stage_wtNormalized_filtered %>% 
    dplyr::select(nutrient, Strain, LibraryName, GrowStage, estimate) %>%
    spread(key = nutrient, value = estimate) 

#replace the NA values in nitrogen new TOR1 library with the old nitrogen data
fit_carbon <- lm_wt_nutrient_corr %>% 
  dplyr::select(-c(nitrogen, phosphate)) %>%
  drop_na() %>%
  unite(sample, LibraryName, GrowStage, sep="_") %>%
  spread(key = sample, value = carbon) %>%
  drop_na()
colnames(fit_carbon)[2:length(fit_carbon[,])] <- paste("carbon", colnames(fit_carbon)[2:length(fit_carbon[,])], sep = "_")

fit_nitrogen_new <- lm_wt_nutrient_corr %>% 
  dplyr::select(-c(carbon, phosphate)) %>%
  drop_na() %>%
  unite(sample, LibraryName, GrowStage, sep="_") %>%
  spread(key = sample, value = nitrogen) 
colnames(fit_nitrogen_new)[2:length(fit_nitrogen_new[,])] <- paste("nitrogen", colnames(fit_nitrogen_new)[2:length(fit_nitrogen_new[,])], sep = "_")

fit_phosphate <- lm_wt_nutrient_corr %>% 
  dplyr::select(-c(carbon, nitrogen)) %>%
  drop_na() %>%
  unite(sample, LibraryName, GrowStage, sep="_") %>%
  spread(key = sample, value = phosphate) 
colnames(fit_phosphate)[2:length(fit_phosphate[,])] <- paste("phosphate", colnames(fit_phosphate)[2:length(fit_phosphate[,])], sep = "_")

fit_all<-left_join(left_join(fit_carbon, fit_nitrogen_new, 
                    by = "Strain"), fit_phosphate, by = "Strain") %>%
  drop_na()

#the column number here is determined by the conditions + replicates + mutant libraries
dz <- data.frame(t(fit_all[,2:length(fit_all[,])]))
dz[,ncol(dz)+1] <- rownames(dz)
colnames(dz)[ncol(dz)] <- "condition"
dz <- dz %>% 
  separate(condition, c("nutrient", "library", "growstage"), sep = "_")

dim(dz)

l <- ncol(dz) -3 # remove the last three annotation columns: nutrient, library, rep

#the numbers in the range here is subject to the strains left after pre-filtering steps 
autoplot(prcomp(dz[,c(1:l)]), data = dz, colour ='library', shape = 'nutrient', size = 4) +
  xlim(c(-0.6,0.6)) +
  scale_color_manual(values=c("#E5C494","#8DA0CB","#E78AC3","#66C2A5")) +
  scale_fill_manual(values=c("#E5C494","#8DA0CB","#E78AC3","#66C2A5")) +
  ggtitle("OVERALL") +
  theme_classic2()

annotation <- data.frame(names(fit_all)[-1])
rownames(annotation) <- annotation[,1]
annotation <- annotation %>% separate(names.fit_all...1., c("nutrient", "library", "growstage"), sep = "_")
#change color scale
breaksList = seq(-0.07, 0.07, by = 0.0001)
#customize annotation color
library_col <- c("#E5C494","#8DA0CB","#E78AC3","#66C2A5")
names(library_col) <- c("HO","TOR1","RIM15","PHO85")
nutrient_col <- c("#FFA500", "#7ACE0D", "#A564F9")
names(nutrient_col) <- c("carbon","nitrogen","phosphate")
growstage_col <-c("#cccccc","#0c0a0a")
names(growstage_col) <- c("Pro","Qui")
anno_colors <- list(nutrient = nutrient_col, Library = library_col, growstage =growstage_col)
#replace nitrogen.new with nitrogen
pheatmap(as.matrix(fit_all[,c(2:length(fit_all[,]))]), annotation_col = annotation, annotation_colors = anno_colors)#,

cormat_fitness <- round(cor(as.matrix(fit_all[,c(2,4,6,8,10,12,14,16,18,20,22,24,3,5,7,9,11,13,15,17,19,21,23,25)])),2)

cormat_fitness_pro <- round(cor(as.matrix(fit_all[,c(2,4,6,8,10,12,14,16,18,20,22,24)])),2)

cormat_fitness_qui <- round(cor(as.matrix(fit_all[,c(3,5,7,9,11,13,15,17,19,21,23,25)])),2)

write.csv(cormat_fitness, "./sum/tables/TableEV5.csv")
# Print the correlation heatmap
ggcorrplot(cormat_fitness_pro,  method = "square", hc.method = "complete",  show.diag = TRUE, lab = TRUE, lab_size = 3,
           hc.order = FALSE, outline.col = "white", type = "upper")+
  scale_fill_gradient2(low = "#FF9933", high = "#0066CC", mid = "white", 
   midpoint = 0, limit = c(-1,1), space = "Lab", 
    name="Pearson\nCorrelation") +
theme(
  axis.text.x = element_text(color = "grey20", size = 10),
  axis.text.y = element_text(color = "grey20", size = 10),
  axis.title.x = element_blank(),
  axis.title.y = element_blank(),
  panel.grid.major = element_blank(),
  panel.border = element_blank(),
  panel.background = element_blank(),
  axis.ticks = element_blank(),
  legend.justification = c(1, 0),
  legend.position = c(1, 0.1),
  legend.direction = "horizontal")+
  guides(fill = guide_colorbar(barwidth = 7, barheight = 1,
                title.position = "bottom", title.hjust = 0.5))
ggsave("./sum/reviewer/Fig1E_pro.pdf", width = 6, height = 6)

ggcorrplot(cormat_fitness_qui,  method = "square", hc.method = "complete",  show.diag = TRUE, lab = TRUE, lab_size = 3,
           hc.order = FALSE, outline.col = "white", type = "lower")+
  scale_fill_gradient2(low = "#FF9933", high = "#0066CC", mid = "white", 
   midpoint = 0, limit = c(-1,1), space = "Lab", 
    name="Pearson\nCorrelation") +
theme(
  axis.text.x = element_text(color = "grey20", size = 10),
  axis.text.y = element_text(color = "grey20", size = 10),
  axis.title.x = element_blank(),
  axis.title.y = element_blank(),
  panel.grid.major = element_blank(),
  panel.border = element_blank(),
  panel.background = element_blank(),
  axis.ticks = element_blank(),
  legend.justification = c(1, 0),
  legend.position = c(0.6, 0.7),
  legend.direction = "horizontal")+
  guides(fill = guide_colorbar(barwidth = 7, barheight = 1,
                title.position = "top", title.hjust = 0.5))
ggsave("./sum/reviewer/Fig1E_qui.pdf", width = 6, height = 6)

#col1 <- colorRampPalette(c("#7F0000", "red", "#FF7F00", "yellow", "white","cyan", "#007FFF", "blue","#00007F"))
col2 <- colorRampPalette(c("#67001F", "#B2182B", "#D6604D", "#F4A582","#FDDBC7", "#FFFFFF", "#D1E5F0", "#92C5DE", "#4393C3", "#2166AC", "#053061"))
#col4 <- colorRampPalette(c("#7F0000", "red", "#FF7F00", "yellow", "#7FFF7F","cyan", "#007FFF", "blue", "#00007F"))

pdf("./sum/reviewer/Fig1E_new.pdf", width = 11, height = 11, useDingbats=FALSE)
corrplot(cormat_fitness, type = "full",
         tl.col = "black", tl.srt = 45, col = col2(10))
dev.off()

pdf("./sum/reviewer/Fig1E_pro_new.pdf", width = 8, height = 6, useDingbats=FALSE)
corrplot(cormat_fitness_pro, type = "lower",
         tl.col = "black", tl.srt = 45,col = col2(10))
dev.off()

pdf("./sum/reviewer/Fig1E_qui_new.pdf", width = 8, height = 6, useDingbats=FALSE)
corrplot(cormat_fitness_qui, type = "upper",
         tl.col = "black", tl.srt = 45,col = col2(10))
dev.off()

#####negative correlation examples
##GI profiels differ between cell types
names(fit_all) <- c("Starin","HO_Pro(-C)","HO_Qui(-C)","PHO85_Pro(-C)","PHO85_Qui(-C)","RIM15_Pro(-C)","RIM15_Qui(-C)","TOR1_Pro(-C)","TOR1_Qui(-C)","HO_Pro(-N)","HO_Qui(-N)","PHO85_Pro(-N)","PHO85_Qui(-N)","RIM15_Pro(-N)","RIM15_Qui(-N)","TOR1_Pro(-N)","TOR1_Qui(-N)","HO_Pro(-P)","HO_Qui(-P)","PHO85_Pro(-P)","PHO85_Qui(-P)","RIM15_Pro(-P)","RIM15_Qui(-P)","TOR1_Pro(-P)","TOR1_Qui(-P)")
pdf("./sum/reviewer/FigEV2A_new.pdf", width = 20, height = 20)
ggpairs(as.matrix(fit_all[,c(2,4,6,8,10,12,14,16,18,20,22,24,3,5,7,9,11,13,15,17,19,21,23,25)]),
        mapping = ggplot2::aes(),
        #params=list(corSize=12),
        upper = list(continuous = wrap("cor", alpha = 1), combo = "box_no_facet"),
        lower = list(continuous = wrap("points", alpha = 0.3), combo = wrap("dot_no_facet", alpha = 0.2, size = 0.5, col = "pink"))
        #title = "GI profile comparison for quiescent cells starved fro phosphate"
        )+
  theme(text=element_text(size=9))
dev.off()

pdf("./sum/reviewer/FigEV2A_new_pro.pdf", width = 10, height = 10)
ggpairs(as.matrix(fit_all[,c(2,4,6,8,10,12,14,16,18,20,22,24)]),
        mapping = ggplot2::aes(),
        #params=list(corSize=12),
        upper = list(continuous = wrap("cor", alpha = 1), combo = "box_no_facet"),
        lower = list(continuous = wrap("points", alpha = 0.3), combo = wrap("dot_no_facet", alpha = 0.2, size = 0.5, col = "pink")))+
  theme(text=element_text(size=9))
dev.off()

pdf("./sum/reviewer/FigEV2A_new_qui.pdf", width = 10, height = 10)
ggpairs(as.matrix(fit_all[,c(3,5,7,9,11,13,15,17,19,21,23,25)]),
        mapping = ggplot2::aes(),
        #params=list(corSize=12),
        upper = list(continuous = wrap("cor", alpha = 1), combo = "box_no_facet"),
        lower = list(continuous = wrap("points", alpha = 0.3), combo = wrap("dot_no_facet", alpha = 0.2, size = 0.5, col = "pink")))+
  theme(text=element_text(size=9))
dev.off()
```

#make scatter plot to support the claim that fitness profiles in mutant libraries are more distinct to nitrgoen and phosphorous
```{r}
VST_lm_wtNormalized_filtered <- read_csv("./GI_quiescence/sum/tables/TableS5.csv")[,-1]
melt_tb <- VST_lm_wtNormalized_filtered %>% 
  dplyr::select(nutrient, Strain, LibraryName, estimate) %>%
  spread(key = "nutrient", value = "estimate")

#scatter plot fitness in different nutrient starvations
ggscatter(melt_tb, x = "carbon", y = "nitrogen", alpha = 0.2, size=1.2, 
          cor.coef.size = 0.3, col= "LibraryName", shape = "LibraryName", fill = "LibraryName")+
  xlab("Fitness during carbon starvation") +
  ylab("Fitness during nitrogen starvation") +
  facet_grid(~LibraryName, scale = "free")+
  geom_smooth(aes(col = LibraryName), method = "lm", se = FALSE, size = 0.7)+
  stat_cor(aes(col = LibraryName), method = "pearson", label.x.npc = "left", label.y.npc = "top", size=4) +
  xlim(-0.05,0.05)+
  ylim(-0.05,0.05)+
  scale_color_manual(values=c("#E5C494","#8DA0CB","#E78AC3","#66C2A5"))+
  scale_fill_manual(values=c("#E5C494","#8DA0CB","#E78AC3","#66C2A5"))+
  theme(axis.text=element_text(size=12), axis.text.x=element_text(angle=0),
        axis.title=element_text(size=12,face="bold"),legend.position="none") 
ggsave("./GI_quiescence/sum/plot/FigEV1E.pdf" , width =10, height = 3)

ggscatter(melt_tb, x = "carbon", y = "phosphate", alpha = 0.2, size=1.2, 
          cor.coef.size = 0.3, col= "LibraryName", shape = "LibraryName", fill = "LibraryName")+
  xlab("Fitness during carbon starvation") +
  ylab("Fitness during phosphate starvation") +
  facet_grid(~LibraryName, scale = "free")+
  geom_smooth(aes(col = LibraryName), method = "lm", se = FALSE, size = 0.7)+
  stat_cor(aes(col = LibraryName), method = "pearson", label.x.npc = "left", label.y.npc = "top", size=4) +
  xlim(-0.05,0.05)+
  ylim(-0.05,0.05)+
  scale_color_manual(values=c("#E5C494","#8DA0CB","#E78AC3","#66C2A5"))+
  scale_fill_manual(values=c("#E5C494","#8DA0CB","#E78AC3","#66C2A5"))+
  theme(axis.text=element_text(size=12), axis.text.x=element_text(angle=0),
        axis.title=element_text(size=12,face="bold"),legend.position="none") 
ggsave("./GI_quiescence/sum/plot/FigEV1F.pdf" , width = 10, height = 3)

ggscatter(melt_tb, x = "nitrogen", y = "phosphate", alpha = 0.2, size=1.2, 
          cor.coef.size = 0.3, col= "LibraryName", shape = "LibraryName", fill = "LibraryName")+
  xlab("Fitness during nitrogen starvation") +
  ylab("Fitness during phosphate starvation") +
  facet_grid(~LibraryName, scale = "free")+
  geom_smooth(aes(col = LibraryName), method = "lm", se = FALSE, size = 0.7)+
  stat_cor(aes(col = LibraryName), method = "pearson", label.x.npc = "left", label.y.npc = "top", size=4) +
  xlim(-0.05,0.05)+
  ylim(-0.05,0.05)+
  scale_color_manual(values=c("#E5C494","#8DA0CB","#E78AC3","#66C2A5"))+
  scale_fill_manual(values=c("#E5C494","#8DA0CB","#E78AC3","#66C2A5"))+
  theme(axis.text=element_text(size=12), axis.text.x=element_text(angle=0),
        axis.title=element_text(size=12,face="bold"),legend.position="none") 
ggsave("./GI_quiescence/sum/plot/FigEV1G.pdf" , width = 10, height = 3)
```

###Fitness and survival phenotypic difference quantification by ANCOVA
```{r}
VST_normalized_filtered <- read_csv("./GI_quiescence/sum/tables/TableS3.csv")
###########################################################################################
###########################ANCOVA fitness difference modeling start########################
###########################################################################################
#Use ANCOVA to test for slope (fitness) difference between growing and starving stages
grow_df <- VST_normalized_filtered %>% dplyr::select(-SampleNum) %>% filter(GrowStage == "Pro") %>% drop_na()
starved_df <- VST_normalized_filtered %>% dplyr::select(-SampleNum) %>% filter(GrowStage == "Qui") %>% drop_na()

tmp <- inner_join(grow_df, starved_df, 
                  by = c("Strain", "LibraryName", "nutrient",
                         "Replicate","Common"), suffix = c(".G",".S"))
grow_df <- tmp %>%
      dplyr::select(Strain, nutrient, Counts.G, LibraryName, GrowStage.G,
             Replicate, SamplingTime.G, Rela2WT.G, scaled_time.G, Common) %>%
      dplyr::rename(SamplingTime = SamplingTime.G, GrowStage = GrowStage.G, 
             Counts = Counts.G, Rela2WT = Rela2WT.G, scaled_time = scaled_time.G) 
  
starved_df <- tmp %>%
      dplyr::select(Strain, nutrient, Counts.S, LibraryName, GrowStage.S,
             Replicate, SamplingTime.S, Rela2WT.S, scaled_time.S, Common) %>%
      dplyr::rename(SamplingTime = SamplingTime.S, GrowStage = GrowStage.S, 
             Counts = Counts.S, Rela2WT = Rela2WT.S, scaled_time = scaled_time.S)

gs_df<- bind_rows(grow_df, starved_df)

fitness_diff_QC_HO_wtNormalized <- gs_df %>%
      filter(LibraryName == "HO") %>%
      group_by(nutrient, LibraryName, Strain, Common) %>%
      do(tidy(lm(Rela2WT ~ scaled_time * GrowStage, .))) %>% 
      filter(term == "scaled_time:GrowStageQui") %>%
      ungroup() %>% filter(term == "scaled_time:GrowStageQui", !is.na(p.value)) %>%
      mutate(q.value = qvalue(p.value, fdr.level=0.05, pi0.method="bootstrap")$qvalues)

###########################################################################################
###########################ANCOVA fitness difference modeling end##########################
###########################################################################################
#save for TableS8: Phenotypic difference between quiescence and proliferation quantified by ANCOVA.
write.csv(fitness_diff_QC_HO_wtNormalized, "./GI_quiescence/sum/tables/TableS8.csv")
```

##Figure2A
```{r}
VST_normalized_filtered <- read_csv("./GI_quiescence/sum/tables/TableS3.csv")
#function to plot individual mutant's fitness changes over time 
individual_plot <- function(df, gene, fitness){
  p1 <- df %>%
    filter(LibraryName == "HO", Common == gene) %>% 
    ggplot(aes(x=SamplingTime, y=Counts, group=nutrient, color=nutrient)) +
    geom_point(aes(shape = nutrient))+
    geom_smooth(method = "lm", aes(fill=nutrient), se = FALSE)+
    ggtitle(gene)+  
    xlab("Hours post inoculation")+
    ylab("Normalized counts")+
    scale_color_manual(values=c("#FFA500", "#7ACE0D", "#A564F9"))+
    scale_fill_manual(values=c("#FFA500", "#7ACE0D", "#A564F9"))+
    theme(axis.text.x=element_text(angle=0),legend.position="bottom")
  
#rela
  p2 <- df %>%
    filter(LibraryName == "HO", Common == gene)%>%
    filter(SamplingTime %in% c("0","24","32","48","96","186","348")) %>%
    ggplot(aes(x=SamplingTime, y=Rela2WT, group=nutrient, color=nutrient)) +
    geom_point(aes(shape = nutrient))+
    geom_smooth(method = "lm", aes(fill=nutrient))+#, se = FALSE)+
    ggtitle(paste0(gene, " relative"))+  
    xlab("Hours post inoculation")+
    ylab("Relative frequency to wild-type")+
    scale_color_manual(values=c("#FFA500", "#7ACE0D", "#A564F9"))+
    scale_fill_manual(values=c("#FFA500", "#7ACE0D", "#A564F9"))+
    theme(axis.text.x=element_text(angle=0),legend.position="right")
  
  p3 <- df %>%
    filter(LibraryName == "HO", Common == gene)%>%
    ggplot(aes(x=SamplingTime, y=Rela2WT, group=nutrient, color=nutrient)) +
    geom_point(aes(shape = nutrient))+
    geom_smooth(method = "lm", aes(fill=nutrient))+
    ggtitle(paste0(gene, " relative"))+  
    xlab("Hours post inoculation")+
    ylab("Relative frequency to wild-type")+
    scale_color_manual(values=c("#FFA500", "#7ACE0D", "#A564F9"))+
    scale_fill_manual(values=c("#FFA500", "#7ACE0D", "#A564F9"))+
    facet_wrap(~GrowStage, scales = "free_x") +
    theme(axis.text.x=element_text(angle=0),legend.position="bottom") +
    theme_classic()

    p4 <- df %>%
    filter(LibraryName == "HO", Common == gene)%>%
    ggplot(aes(x=SamplingTime, y=Counts, group=nutrient, color=nutrient)) +
    geom_point(aes(shape = nutrient))+
    geom_smooth(method = "lm", aes(fill=nutrient))+
    ggtitle(paste0(gene, "Counts"))+  
    xlab("Hours post inoculation")+
    ylab("Normalized counts")+
    scale_color_manual(values=c("#FFA500", "#7ACE0D", "#A564F9"))+
    scale_fill_manual(values=c("#FFA500", "#7ACE0D", "#A564F9"))+
    facet_grid(~GrowStage, scales = "free") +
    theme(axis.text.x=element_text(angle=0),legend.position="bottom") +
    theme_classic()
  if (fitness == "counts") {
    print(p1)
  }
  if (fitness == "rela"){
    print(p2)
  }
  if (fitness == "counts_stage") {
    print(p4)
  }
  if (fitness == "rela_stage") {
    print(p3)
  }
}

individual_plot(VST_normalized_filtered, "ATG3","rela_stage")
ggsave("./GI_quiescence/sum/plot/Fig2A.pdf", width = 7, height = 4)
```

##Figure2B & Figure S2B&S2C
```{r}
YtoGene <- read.table("./sum/data/YORFtoGENE_2018")
colnames(YtoGene) <- c("Strain","Common")

VST_lm_stages<-read_csv("./sum/tables/TableS7.csv")[,-1]
VST_lm_stages<-left_join(VST_lm_stages, YtoGene, by = "Strain")

fitness_diff_QC_HO <- read_csv("./GI_quiescence/sum/tables/TableS8.csv")[,-1]

fitness_diff_QC_HO <- fitness_diff_QC_HO %>% mutate(GrowStage = "Qui-Pro")

#seperate fitness based on stages
fitness_growing_HO <- VST_lm_stages %>%
  dplyr::filter(LibraryName == "HO"  & GrowStage == "Pro") %>%
  dplyr::select(-c(LibraryName, term, std.error, statistic))

fitness_starved_HO <- VST_lm_stages %>%
  dplyr::filter(LibraryName == "HO"  & GrowStage == "Qui") %>%
  dplyr::select(-c(LibraryName, term, std.error, statistic))

#combine the ANCOVA and seperated lm for HO library
fitness_G_S_diff_HO_byCol <- left_join(fitness_diff_QC_HO %>% dplyr::select(-c(LibraryName, term, std.error, statistic))
, inner_join(fitness_growing_HO, fitness_starved_HO, by =c("nutrient","Strain","Common"), suffix = c(".g",".s")),  by =c("nutrient","Strain","Common")) %>%
  dplyr::rename(Systematic = Strain)

#look at the distribution of fitness fit for different stages
fitness_G_S_diff_HO_byRow <- bind_rows(fitness_growing_HO, fitness_starved_HO, fitness_diff_QC_HO %>% dplyr::select(-c(LibraryName, term, std.error, statistic))) %>%
  dplyr::rename(Systematic = Strain) %>% drop_na()

#save tables for fitness estimation in proliferation, survival in quiescence and phenotypic difference between proliferation and quiescecne.
#TableS9: Fitness/survival and phenotypic difference in one same table. Original table for FigS2C.
write_csv(fitness_G_S_diff_HO_byRow, "./sum/tables/TableS9.csv")

#Figure 2SC
#violen plot for fitness distribution
fitness_G_S_diff_HO_byRow %>%
  ggplot(aes(x=GrowStage, y=estimate, fill = nutrient, col=nutrient)) +
  facet_grid(~nutrient) +
  geom_violin(trim = F, alpha = 0.3) +
  geom_boxplot(width=0.07, fill="white", outlier.size = 0, alpha = 0.7)+
  #geom_point(data=GO_terms, aes(label=COMMON), col = "black", size = 1, alpha = 0.3) +
  ylim(-0.5,0.5)+
  ggtitle("EV1B")+
  scale_color_manual(values=c("#FFA500", "#7ACE0D", "#A564F9")) +
  scale_fill_manual(values=c("#FFA500", "#7ACE0D", "#A564F9")) +
  ylab("Relative fitness to wild type")+
  theme(axis.text.x=element_text(angle=0),legend.position="none") 

#Figure S2B - barplot
tmp<-fitness_G_S_diff_HO_byRow %>%
  filter(GrowStage != "Qui-Pro") %>%
  mutate(type = case_when(
     estimate < 0 & q.value < 0.05 ~ "worse than wt", 
     estimate > 0 & q.value < 0.05 ~ "bettter than wt",
     q.value > 0.05 ~ "no difference than wt")) %>%
  group_by(GrowStage, nutrient,type) %>%
  tally() %>%
  drop_na()
sum <- fitness_G_S_diff_HO_byRow %>%
  filter(GrowStage != "Qui-Pro") %>%
  mutate(type = case_when(
     estimate < 0 & q.value < 0.05 ~ "worse than wt", 
     estimate > 0 & q.value < 0.05 ~ "bettter than wt",
     q.value > 0.05 ~ "no difference than wt")) %>%
  group_by(GrowStage, nutrient,type) %>%
  tally() %>%
  drop_na() %>%
  group_by(GrowStage, nutrient) %>%
  tally(n)
  
tmp <- left_join(tmp, sum, by = c("GrowStage", "nutrient"))

tmp %>% 
  mutate(fraction = n.x/n.y) %>%
  mutate(Frequency = paste0(round(100 * fraction, 0), "%")) %>%
  ggplot(aes(x=GrowStage, y=fraction, fill = type, col=type)) +
  geom_bar(stat="identity") +
  geom_text(aes(label=Frequency), position=position_fill(vjust=0.5), col = "black") +
  facet_grid(~nutrient) +
  ggtitle("EV2B")+
  scale_fill_brewer(palette="Reds") +
  scale_color_brewer(palette="Reds") +
  theme_classic2()
  
ggsave("./sum/plot/FigS2B.pdf", width = 9, height = 7)

#genes for entering, maintaining, exiting from Quiescence 
#opt2:#lm and ancova's pval is cutted at 0.05,with either positive or negative fitness selection
min_growth <- fitness_G_S_diff_HO_byCol %>% dplyr::filter(q.value.g < 0.05 & estimate.g < 0) %>% dplyr::select(estimate.g) %>% max()

QC_required <- fitness_G_S_diff_HO_byCol %>%
  #select the genes with a quiescence defects and then do GSEA on with defected quiescnece
  filter(q.value.s < 0.05 & estimate.s < 0 & q.value < 0.05 & estimate < 0 & estimate.g > min_growth)

QC_required_fig2 <- QC_required %>%
  dplyr::rename(Change_slope = estimate, Growing_slope = estimate.g, Starved_slope = estimate.s) %>%
  dplyr::select(nutrient, Systematic, Growing_slope, Starved_slope, Change_slope)

#Save file for genes that are required for maintaining viability in quiescence under different conditions. 
#Table10: Quiescent specific genes across different conditions. Original data for Fig2C
write_csv(QC_required_fig2, "./sum/tables/TableS10.csv")


carbon_qc_required <- QC_required_fig2 %>% filter(nutrient == "carbon") %>% dplyr::select (Systematic) 
nitrogen_qc_required<-QC_required_fig2 %>% filter(nutrient == "nitrogen") %>% dplyr::select (Systematic)  
phosphate_qc_required<-QC_required_fig2 %>% filter(nutrient == "phosphate") %>% dplyr::select (Systematic)

write_csv(carbon_qc_required, "./sum/tables/TableEV8a.csv")
write_csv(nitrogen_qc_required, "./sum/tables/TableEV8b.csv")
write_csv(phosphate_qc_required, "./sum/tables/TableEV8c.csv")

#hypergeometric test
#Exact Test of Multi-Set Intersections
library("SuperExactTest")

cnp_qc_required_list<-list(c(carbon_qc_required$Systematic),c(nitrogen_qc_required$Systematic),c(phosphate_qc_required$Systematic))

Result=supertest(cnp_qc_required_list, n=5000)
summary(Result)

cn_qc_required<-intersect(carbon_qc_required$Systematic, nitrogen_qc_required$Systematic)
cp_qc_required<-intersect(carbon_qc_required$Systematic, phosphate_qc_required$Systematic)
np_qc_required<-intersect(phosphate_qc_required$Systematic, nitrogen_qc_required$Systematic)
cnp_qc_required <-intersect(carbon_qc_required$Systematic, intersect(phosphate_qc_required$Systematic, nitrogen_qc_required$Systematic))

print(paste0("QS genes in each condition and across conditions: carbon-",length(carbon_qc_required$Systematic),"; nitrogen-", length(nitrogen_qc_required$Systematic), "; phosphate-", length(phosphate_qc_required$Systematic), "; carbon&nitrogen-",length(cn_qc_required), "; carbon&phosphate-", length(cp_qc_required), "; nitrogen&phosphate-",length(np_qc_required), "; carbon&nitrogen&phosphate-", length(cnp_qc_required)))

#draw a venn diagram
library(VennDiagram)

pdf("./sum/plot/Fig2D_raw.pdf")
grid.newpage()
draw.triple.venn(area1 = length(carbon_qc_required$Systematic), area2 = length(nitrogen_qc_required$Systematic), area3 = length(phosphate_qc_required$Systematic), n12 = length(cn_qc_required), n13 =length(cp_qc_required), n23 = length(np_qc_required), n123 = length(cnp_qc_required), euler.d = TRUE, category = c("Carbon", "Nitrogen", "Phosphate"), lty = "blank", fill = c("skyblue", "pink1", "mediumorchid"))
dev.off()
#figure 2D is generated using a published shiny app online: http://eulerr.co/ 

#save QS genes for core quiescent genes
#QS genes
QS <- fitness_G_S_diff_HO_byRow %>% filter(Systematic %in% cnp_qc_required)
#TableS11: Original data for FigS2D
write_csv(QS, "./sum/tables/TableS11.csv")
```

##FigureS2E
```{r}
#select the essential part for heatmap & save in a dataframe
core_set <- read_csv("./sum/tables/TableS11.csv")

common_genes <- core_set %>%
  filter(GrowStage %in% c("Qui","Pro")) %>%
  dplyr::select(nutrient, Common, estimate, GrowStage) %>%
  unite(condition, nutrient, GrowStage) %>%
  spread(key = condition, value = estimate) %>%
  as.data.frame()

#prepare for making a dataframe
rownames(common_genes) <- common_genes$Common
common_genes<-common_genes[,-1]

#add column and row annotation for heatmap
my_sample_col <- data.frame(sample = c(rep("Proliferation",3), rep("Quiescence", 3)))
row.names(my_sample_col) <- colnames(common_genes[,c(1,3,5,2,4,6)])

#core
my_gene_row <- core_set %>% filter(nutrient =="carbon" & GrowStage == "Pro") %>% dplyr::select(Common) %>% as.data.frame()

#my_gene_row <- data.frame(my_gene_row$Common[order(my_gene_row$group)])

row.names(my_gene_row) <- rownames(common_genes)

library(pheatmap)
pdf("./GI_quiescence/sum/plot/FigS2D.pdf")
pheatmap(common_genes[,c(1,3,5,2,4,6)],  annotation_col = my_sample_col, cluster_rows = FALSE, cluster_cols = FALSE)
dev.off()
```

##Function analysis
###Install necessary libraries & read in related files for functional analysis
Here, we read in a few tables. These were downloaded from SGD,
so the GO slim terms are from 
[https://downloads.yeastgenome.org/curation/literature/go_slim_mapping.tab](
https://downloads.yeastgenome.org/curation/literature/go_slim_mapping.tab)
and the rest are likely from 
[http://www.geneontology.org/page/download-go-annotations](
http://www.geneontology.org/page/download-go-annotations).
Then, I make a tibble that is handy for later mappings.
```{r,libs,cache=F,warning=F,message=F}
#biocLite("org.Sc.sgd.db")
library(org.Sc.sgd.db)
keytypes(org.Sc.sgd.db)

#read in related files
# GOSlim annotation table
read_tsv("./sum/data/sgd_go_slim_171013.txt",col_names=FALSE,
  comment="!") -> SGDGOSlim

# Full GO annotation table
read_tsv("./sum/data/sgd_go_full_171013.txt",col_names=FALSE,
  comment="!") -> SGDGOFull

# Go terms look up table
read_tsv("./sum/data/sgd_go_terms_171013.txt",col_names=FALSE,
  comment="!") %>%
  mutate(GOID=str_c("GO:"
    ,str_pad(string=X1,width=7,side="left",pad="0"))
    ) -> SGDGOTerms

# This is a handy table for mapping systematic names to SGD ID
SystematicToSGDIDmapper <- SGDGOSlim%>%
  dplyr::select(X1,X3)%>%
  dplyr::rename(Systematic=X1,SGDID=X3)%>%
  unique()
```

##Gene Set Enrichment Analysis of gene list ranked by phenotypic different between starvation and proliferation
```{r eval = FALSE}
fitness_diff_QC_HO <- read_csv("./GI_quiescence/sum/tables/TableS8.csv")[,-1]
fitness_diff_QC_HO <- left_join(fitness_diff_QC_HO, YtoGene, by = "Strain")

#reshapte and select the data for GSEA analysis of fitness different genes between proliferation and quiescence
fitness_diff_QC_HO <- fitness_diff_QC_HO %>%
  mutate(GrowStage = "Qui-Pro") %>%
  dplyr::select(nutrient, GrowStage, Strain, estimate, p.value) %>%
  left_join(YtoGene, by = "Strain") 

fitness_diff_HO_c <- fitness_diff_QC_HO %>%
  dplyr::filter(nutrient == "carbon") %>%
  dplyr::select(-c(p.value,nutrient))

fitness_diff_HO_n <- fitness_diff_QC_HO %>%
  dplyr::filter(nutrient == "nitrogen") %>%
  dplyr::select(-c(p.value,nutrient))

fitness_diff_HO_p <- fitness_diff_QC_HO %>%
  dplyr::filter(nutrient == "phosphate") %>%
  dplyr::select(-c(p.value,nutrient))

#combine the ANCOVA and seperated lm for HO library
fitness_diff_HO_by_nutrient <- left_join(fitness_diff_HO_c, left_join(fitness_diff_HO_n, fitness_diff_HO_p, by =c("GrowStage","Strain"), suffix = c(".n",".p")),  by =c("GrowStage","Strain"))

fitness_diff_HO_by_nutrient <- fitness_diff_HO_by_nutrient %>%
  dplyr::rename(Systematic = Strain, Carbon_fit = estimate, Nitrogen_fit = estimate.n, Phosphate_fit = estimate.p) %>%
  dplyr::select(Systematic, GrowStage, Carbon_fit, Nitrogen_fit, Phosphate_fit)

#fitness_diff_HO_by_nutrient <- left_join(fitness_diff_HO_by_nutrient, YtoGene, by="Systematic")

datar <- fitness_diff_HO_by_nutrient

nPermutations <- 1e6

for (i in c("ALL","BP","CC","MF")) {
# A list for results holding
  #i="BP"
  gseGO <- list()
  gseGOResults <- list() 

  for (varz in c("Carbon_fit","Nitrogen_fit","Phosphate_fit")) {
    #varz = "Carbon_fit"
    message(varz)
    message(" took ... ")
    print(system.time(
      {
      gene_list <- datar[order(datar[[varz]],decreasing=T),] %>%
        left_join(SystematicToSGDIDmapper, by="Systematic")%>%
        {clusterProfiler::bitr(.$SGDID, fromType="SGD",toType="ENTREZID"
                               ,OrgDb=org.Sc.sgd.db::org.Sc.sgd.db)}
    
      gene_data <- datar[order(datar[[varz]],decreasing=T),] %>%
        left_join(SystematicToSGDIDmapper, by="Systematic") %>%
        dplyr::select(varz, SGDID) %>%
        dplyr::rename(SGD = SGDID)
    
      this_gene_list <- left_join(gene_list, gene_data, by = "SGD") %>%
        dplyr::select(-SGD)
    
      rownames(this_gene_list) <- this_gene_list$ENTREZID
    
      gene_list<- this_gene_list %>% dplyr::select (-ENTREZID)

      gene_list<-data.matrix(gene_list, rownames.force = NA) [-1,]
    
      gseGO[[varz]] <- clusterProfiler::gseGO(
        geneList=gene_list, keyType = "ENTREZID",
        OrgDb = org.Sc.sgd.db::org.Sc.sgd.db,
        ont = i, 
        minGSSize=3,maxGSSize=800,
        pAdjustMethod="fdr",
        pvalueCutoff=0.05, seed="seedy",
        nPerm=nPermutations
        )
      
      gseGOResults[[varz]] <- gseGO[[varz]]@result %>% 
        as_tibble() %>% 
        mutate(Variable=varz)
      }
    ))
    }
  gseGOtable <- bind_rows(gseGOResults) %>% as_tibble %>% 
    # First we bind rows and make it a tibble
    dplyr::select(Variable,ID,Description, setSize, enrichmentScore, NES, p.adjust,rank, pvalue, core_enrichment) %>%
    # Then we pick the variables we want
    arrange(Variable,-enrichmentScore)
  gseGOtable %>% write_csv(path=paste0("./GI_quiescence/sum/GO_term/TableS10_gseGO_changed_",i,".csv"), append=T, col_names = T)
}
```

##Gene Set Enrichment Analysis of gene list ranked by fitness and survival in different nutritional starvations
```{r}
#load minima theme as the default theme
theme_set(theme_minimal())

VST_lm_stages<-read_csv("./sum/tables/TableS7.csv")[,-1]
VST_lm_stages<-left_join(VST_lm_stages, YtoGene, by = "Strain")

#select HO mutant library and constuct the matrix for applying GSEA
datar <- VST_lm_stages %>%
  filter(LibraryName == "HO") %>%
  dplyr::select(nutrient, Strain, GrowStage, estimate) %>%
  dplyr::rename(Systematic = Strain) %>%
  unite(cond, nutrient, GrowStage) %>%
  spread(key = cond,value = estimate) 

# SET THE DESIRED ORGANISM HERE
#BiocManager::install(organism, character.only = TRUE)
#library("org.Sc.sgd.db", character.only = TRUE)

# A list for results holding
gseGOResults <- list() 
gseGOtable <- ""
  for (varz in c("carbon_Pro","carbon_Qui","nitrogen_Pro","nitrogen_Qui","phosphate_Pro","phosphate_Qui")) {
    # we want the fitness and suvival rate
    original_gene_list <- datar %>% pull(varz)
    # name the vector
    names(original_gene_list) <- datar$Systematic
    # omit any NA values 
    gene_list<-na.omit(original_gene_list)
    # sort the list in decreasing order (required for clusterProfiler)
    gene_list = sort(gene_list, decreasing = TRUE)
    tmp <- clusterProfiler::gseGO(geneList=gene_list, 
             ont ="MF", 
             keyType = "ENSEMBL", 
             nPerm = 1000, 
             minGSSize = 5, 
             maxGSSize = 800, 
             pvalueCutoff = 0.05, 
             verbose = TRUE, 
             OrgDb = "org.Sc.sgd.db", 
             pAdjustMethod = "none")
    
    tmp2 <- simplify(tmp, cutoff=0.4, by="p.adjust", select_fun=min)
    
    gseGOResults[[varz]] <- tmp2@result %>% 
      as_tibble() %>% 
      mutate(Variable=varz)
      }
  gseGOtable <- bind_rows(gseGOResults) %>% as_tibble %>% 
    # First we bind rows and make it a tibble
    dplyr::select(Variable,ID,Description, setSize, enrichmentScore, NES, p.adjust,rank, pvalue, core_enrichment) %>%
    # Then we pick the variables we want
    arrange(Variable,-enrichmentScore)
  
gseGOtable %>% write_csv(path=paste0("./sum/reviewer/gseGO_fitness_survival_MF.csv"), append=T, col_names = T)
  
gseGOtable <- read_csv("./sum/reviewer/gseGO_fitness_survival_MF.csv")
  gseGOtable %>%
  filter(p.adjust < 0.01) %>%
  ggplot(aes(x = Variable, y =  reorder(Description, enrichmentScore), color = enrichmentScore, size =  setSize)) +
  geom_point(aes(size = setSize)) +
  scale_size_continuous(range = c(4, 10)) + 
    theme(text = element_text(size = 15)) +
  ggtitle("Molecular Function (pvalue<0.01)")+
  xlab("")+
  ylab("")+
  scale_colour_gradient2(low = "blue", mid = "white", high = "red") +
  theme(axis.text = element_text(face = "bold", color = "black", size = 30))+
  theme(text = element_text(size=45),axis.text.x=element_text(angle=90),legend.position="right") +
  theme_minimal()
  ggsave("./sum/reviewer/GSEA_fitness_survival_MF.pdf",useDingbats=FALSE, width = 7, height= 6)
```

##Figure 2C
```{r}
dir<-"./GI_quiescence/sum/GO_term/"
BP <- read_csv(paste0(dir,"TableS9_gseGO_changed_BP.csv"))
c <- read_csv(paste0(dir,"REVIGO_carbon_simplified(0.4)_BP.csv"))
n <- read_csv(paste0(dir,"REVIGO_nitrogen_simplified(0.4)_BP.csv"))
p <- read_csv(paste0(dir,"REVIGO_phosphate_simplified(0.4)_BP.csv"))

c_removed <- c %>% filter(plot_X != 'null') %>%
  mutate(Variable = "Carbon_fit")
n_removed <- n %>% filter(plot_X != 'null') %>%
  mutate(Variable = "Nitrogen_fit")
p_removed <- p %>% filter(plot_X != 'null') %>%
  mutate(Variable = "Phosphate_fit")

BP_filtered <- bind_rows(left_join(c_removed %>% dplyr::select (term_ID, Variable, uniqueness), BP %>% dplyr::rename(term_ID = ID), by = c("term_ID","Variable")), 
                         left_join(n_removed %>% dplyr::select (term_ID, Variable, uniqueness), BP %>% dplyr::rename(term_ID = ID), by = c("term_ID","Variable")),
                         left_join(p_removed %>% dplyr::select (term_ID, Variable, uniqueness), BP %>% dplyr::rename(term_ID = ID), by = c("term_ID","Variable"))) %>%
  filter(setSize < 400 & setSize > 5)
  
#save file
#TableS12: GSEA for QS genes in three different conditions. Original data for Fig2C
write_csv(BP_filtered, "./GI_quiescence/sum/tables/TableS12.csv")

#read in simplfied GOs returned by REVIGO
changed_BP_RE_simplist <- read_csv(paste0(dir,"Fig2C_data.csv"))

changed_BP_RE_simplist$enrichmentScore <- as.numeric(changed_BP_RE_simplist$enrichmentScore)

changed_BP_RE_simplist %>%
  #filter(p.adjust < 0.04) %>%
  ggplot(aes(x = Variable, y =  reorder(Description, order), color = enrichmentScore, size =  setSize)) +
  geom_point(aes(size = setSize)) +
  scale_size_continuous(range = c(4, 10)) + 
  ggtitle("Biological Pathway (p.adj<0.05)")+
  xlab("")+
  ylab("")+
  scale_colour_gradient2(low = "blue", mid = "white", high = "red") +
  theme(axis.text = element_text(face = "bold", color = "black", size = 30))+
  #theme(text = element_text(size=45),axis.text.x=element_text(angle=90),legend.position="right") +
  theme_minimal()
#save the plot
ggsave(dpi=200, filename="./GI_quiescence/sum/plot/Fig2C.pdf", useDingbats=FALSE, height = 8, width = 7)
```

##Figrue 2B
```{r,warning=F,message=F}
gseGO_changed_BP_filtered <- read_csv("./GI_quiescence/sum/GO_term/Fig2C_data.csv")

C_specific_GH<-gseGO_changed_BP_filtered %>%
  filter(Variable == "Carbon_fit" & Description == "response to carbohydrate")
C_specific_GH <- clusterProfiler::bitr(unlist(strsplit(C_specific_GH$core_enrichment, "/")), fromType="ENTREZID", toType="COMMON", OrgDb=org.Sc.sgd.db::org.Sc.sgd.db)
#select unique genes
C_specific_GH_unique <- C_specific_GH %>% distinct(SGD, .keep_all = TRUE)

N_specific_NC<-gseGO_changed_BP_filtered %>%
  filter(Variable == "Nitrogen_fit" & Description == "post-translational protein modification")
N_specific_NC <- clusterProfiler::bitr(unlist(strsplit(N_specific_NC$core_enrichment, "/")), fromType="ENTREZID", toType="COMMON", OrgDb=org.Sc.sgd.db::org.Sc.sgd.db)
N_specific_NC_unique <- N_specific_NC %>% distinct(SGD, .keep_all = TRUE)

P_specific_GtoVT<-gseGO_changed_BP_filtered %>%
  filter(Variable == "Phosphate_fit" & Description == "response to pH")
P_specific_GtoVT <- clusterProfiler::bitr(unlist(strsplit(P_specific_GtoVT$core_enrichment, "/")), fromType="ENTREZID", toType="COMMON", OrgDb=org.Sc.sgd.db::org.Sc.sgd.db)
P_specific_GtoVT_unique <- P_specific_GtoVT %>% distinct(SGD, .keep_all = TRUE)

#Read in the Fitness difference table for violen plot
#fitness_G_S_diff_HO_byRow <- read_csv("./GI_quiescence/sum/fitness_G_S_diff_HO_byRow.csv")
SystoSGD <- left_join(fitness_G_S_diff_HO_byRow, SystematicToSGDIDmapper,by="Systematic")
SystoCom <- clusterProfiler::bitr(SystoSGD$SGDID, fromType="SGD", toType="COMMON", OrgDb=org.Sc.sgd.db::org.Sc.sgd.db)
fitness_G_S_diff_HO_byRow_Common <- left_join(SystoSGD, SystoCom %>% dplyr::rename(SGDID = SGD), by = "SGDID")

#specify mutants that is plot in the figure
GO_terms_c <- fitness_G_S_diff_HO_byRow_Common %>%
      filter(nutrient == "carbon" & COMMON %in% C_specific_GH_unique$COMMON)
GO_terms_n <- fitness_G_S_diff_HO_byRow_Common %>%
      filter(nutrient == "nitrogen" & COMMON %in% N_specific_NC_unique$COMMON)
GO_terms_p <- fitness_G_S_diff_HO_byRow_Common %>%
      filter(nutrient == "phosphate" & COMMON %in% P_specific_GtoVT_unique$COMMON)
GO_terms<-rbind(GO_terms_c,GO_terms_n,GO_terms_p) %>%
      filter(GrowStage != "Qui-Pro")

fitness_G_S_diff_HO_byRow %>%
  filter(GrowStage != "Qui-Pro") %>%
  ggplot(aes(x=GrowStage, y=estimate, fill = nutrient, col=nutrient)) +
  facet_grid(~nutrient) +
  geom_violin(trim = F, alpha = 0.3) +
  geom_boxplot(width=0.07, fill="white", outlier.size = 0, alpha = 0.7)+
  geom_point(data=GO_terms, aes(label=COMMON), col = "black", size = 1, alpha = 0.3) +
  ylim(-0.5,0.5)+
  scale_color_manual(values=c("#FFA500", "#7ACE0D", "#A564F9")) +
  scale_fill_manual(values=c("#FFA500", "#7ACE0D", "#A564F9")) +
  ylab("Relative fitness to wild type")+
  theme(axis.text.x=element_text(angle=0),legend.position="none") +
  geom_text_repel(data=GO_terms, aes(label=COMMON), col = "black", size=3) +
  geom_line(data=GO_terms, aes(group = COMMON, col=nutrient), alpha = 0.5, linetype = "dashed")+
  theme_classic()
ggsave("./GI_quiescence/sum/plot/Fig2B.pdf", width = 9, height = 6)
```

###FigureS2A
```{r}
#####correlatino bt nutrientional starvations under the same condition
VST_filtered_stages <- read_csv("./GI_quiescence/sum/tables/TableS7.csv")[,-1]

#distribution of std
VST_filtered_stages %>% 
  ggplot(aes(x=std.error, col= LibraryName, fill=LibraryName))+
  theme_bw(base_size=6)+
  theme(axis.text.x=element_text(angle=90, size=6), panel.grid.major = element_blank())+
  #ggtitle("std Distribution (VST_lm)_rela")+
  geom_vline(xintercept=0.1, col="grey", linetype="dashed") +
  ylab("Frequency")+
  xlab("std.error Distribution")+
  geom_density(alpha = 0.1)+
  facet_grid(GrowStage~nutrient)

#distribution of statistic
VST_filtered_stages %>% 
  ggplot(aes(x=statistic, col= LibraryName, fill=LibraryName))+
  theme_bw(base_size=6)+
  theme(axis.text.x=element_text(angle=90, size=6), panel.grid.major = element_blank())+
  geom_vline(xintercept=0, col="grey", linetype="dashed") +
  ylab("Frequency")+
  xlab("Statistic Distribution")+
  geom_density(alpha = 0.1)+
  facet_grid(GrowStage~nutrient)

#filter out the bad fittted modles and reshape the table for correlation scatter plot
lm_wt_growstage_corr <- VST_filtered_stages %>% 
    filter(LibraryName == "HO") %>%
    dplyr::select(nutrient, Strain, estimate, GrowStage) %>%
    spread(key = GrowStage, value = estimate) %>%
    #remove rows with na 
    na.omit()

#caculate the mean and sd for each group using ddply
library(plyr)
pdf("./GI_quiescence/sum/plot/FigS2A.pdf",width=5, height=7)
# Main plot
pmain <- ggscatter(lm_wt_growstage_corr, x = "Pro", y = "Qui", alpha = 0.5, size=0.5, cor.coef.size = 0.3, col= "nutrient")+
  stat_cor(aes(col = nutrient), method = "pearson", label.x.npc = "left", label.y.npc = "bottom", size = 3) +
  geom_vline(xintercept = 0, linetype = "dashed", size=0.3) +
  geom_hline(yintercept = 0, linetype = "dashed", size=0.3) +
  xlim(-0.5,0.5)+
  ylim(-0.5,0.5)+
  xlab("Fitness in proliferation") +
  ylab("Survival rate in quiescence") +
  coord_fixed(ratio = 0.7)+
  theme(axis.text=element_text(size=12), axis.title=element_text(size=12,face="bold"))+
  scale_color_manual(values=c("#FFA500", "#7ACE0D", "#A564F9"))+
  scale_fill_manual(values=c("#FFA500", "#7ACE0D", "#A564F9"))

# Marginal densities along x axis
xdens <- axis_canvas(pmain, axis = "x")+
  geom_density(data = lm_wt_growstage_corr, aes(x = Pro, fill = nutrient),
              alpha = 0.7, size = 0.2)+
  scale_color_manual(values=c("#FFA500", "#7ACE0D", "#A564F9"))+
  scale_fill_manual(values=c("#FFA500", "#7ACE0D", "#A564F9"))

# Marginal densities along y axis
# Need to set coord_flip = TRUE, if you plan to use coord_flip()
ydens <- axis_canvas(pmain, axis = "y", coord_flip = TRUE)+
  geom_density(data = lm_wt_growstage_corr, aes(x = Qui, fill = nutrient),
                alpha = 0.7, size = 0.2)+
  coord_flip()+
  scale_color_manual(values=c("#FFA500", "#7ACE0D", "#A564F9"))+
  scale_fill_manual(values=c("#FFA500", "#7ACE0D", "#A564F9"))

p1 <- insert_xaxis_grob(pmain, xdens, grid::unit(.2, "null"), position = "top")
p2<- insert_yaxis_grob(p1, ydens, grid::unit(.2, "null"), position = "right")
ggdraw(p2)
dev.off()
```

##GI (ANCOVA) analysis for mutants in different growth stages
```{r include=FALSE}
# read in the dataframe after filtered out HO rep2 and RIM15 rep2 and renamed the replicates number
VST_normalized_filtered <- read_csv("./sum/tables/TableS3.csv")

#save fitness and interaction score generated by ANCOVA for each strain within the same file
sub_libraries_GI<-function (master_df, ddf){
  #reshape the table and select for the mutants conditions that are both existing in single and double mutant library
  double_df <- master_df %>% dplyr::filter(LibraryName == ddf) %>% dplyr::select(-SampleNum) %>% drop_na()
  single_df <- master_df %>% dplyr::filter(LibraryName == "HO") %>% dplyr::select(-SampleNum) %>% drop_na()
  tmp <- left_join(double_df, single_df,
                    by = c("Strain", "SamplingTime", "Replicate", "scaled_time", "GrowStage", "nutrient","Common"), 
                   suffix = c(".double",".single"))
  double_df <- tmp %>% 
    dplyr::select(Strain, LibraryName.double, SamplingTime, GrowStage, scaled_time, nutrient, Counts.double, Rela2WT.double, Replicate) %>%
    dplyr::rename(LibraryName = LibraryName.double, Counts = Counts.double, Rela2WT = Rela2WT.double) %>%
    drop_na()
  
  single_df <-tmp %>% 
    dplyr::select(Strain, LibraryName.single, SamplingTime, GrowStage, scaled_time, nutrient, Counts.single, Rela2WT.single, Replicate) %>%
    dplyr::rename(LibraryName = LibraryName.single, Counts = Counts.single, Rela2WT = Rela2WT.single) %>%
    drop_na()
  
  ds_df<- rbind(double_df, single_df)

  lm_interaction_wtNormed <- ds_df %>%
      group_by(nutrient, Strain, GrowStage) %>%
      do(tidy(lm(Rela2WT ~ scaled_time * LibraryName, .))) %>% 
      filter(term == paste0("scaled_time:LibraryName",ddf)) %>%
      ungroup() %>%
      filter(!is.na(p.value)) %>%
      mutate(q.value = qvalue(p.value, fdr.level=0.05, pi0.method="bootstrap")$qvalues) %>%
      mutate(LibraryName = ddf)
  output = lm_interaction_wtNormed
  return(output)
}

GI_VST <- pmap(list(master_df=list(VST_normalized_filtered, VST_normalized_filtered, VST_normalized_filtered), ddf=list("RIM15","PHO85","TOR1")), sub_libraries_GI)

GI_VST_all_wtNormed <- bind_rows(GI_VST[[1]], GI_VST[[2]], GI_VST[[3]])

#save files 
#TableS13: Genetic interaction quantification by ANCOVA using different phenotypic readout for proliferation and quiescence. 
write.csv(GI_VST_all_wtNormed, "./GI_quiescence/sum/tables/TableS13.csv")
```


##GI (ANCOVA) analysis for mutants during whole growth stages
```{r include=FALSE}
# read in the dataframe after filtered out HO rep2 and RIM15 rep2 and renamed the replicates number
#VST_normalized_filtered <- read_csv("./GI_quiescence/sum/tables/TableS3.csv")

#save fitness and interaction score generated by ANCOVA for each strain within the same file
sub_libraries_GI_prolong<-function (master_df, ddf){
  #reshape the table and select for the mutants conditions that are both existing in single and double mutant library
  double_df <- master_df %>% filter(LibraryName == ddf) %>% dplyr::select(-SampleNum) %>% drop_na()
  single_df <- master_df %>% filter(LibraryName == "HO") %>% dplyr::select(-SampleNum) %>% drop_na()
  tmp <- left_join(double_df, single_df,
                    by = c("Strain", "SamplingTime", "Replicate", "scaled_time", "GrowStage", "nutrient","Common"), 
                   suffix = c(".double",".single"))
  double_df <- tmp %>% 
    dplyr::select(Strain, LibraryName.double, SamplingTime, GrowStage, scaled_time, nutrient, Counts.double, Rela2WT.double, Replicate) %>%
    dplyr::rename(LibraryName = LibraryName.double, Counts = Counts.double, Rela2WT = Rela2WT.double) %>%
    drop_na()
  
  single_df <-tmp %>% 
    dplyr::select(Strain, LibraryName.single, SamplingTime, GrowStage, scaled_time, nutrient, Counts.single, Rela2WT.single, Replicate) %>%
    dplyr::rename(LibraryName = LibraryName.single, Counts = Counts.single, Rela2WT = Rela2WT.single) %>%
    drop_na()
  
  ds_df<- rbind(double_df, single_df)

  lm_interaction_wtNormed <- ds_df %>%
    dplyr::filter(SamplingTime %in% c("0","24","32","48","96","186","348")) %>%
  mutate(Days = SamplingTime/24) %>%
      group_by(nutrient, Strain) %>%
      do(tidy(lm(Rela2WT ~ Days * LibraryName, .))) %>% 
      filter(term == paste0("Days:LibraryName",ddf)) %>%
      ungroup() %>%
      filter(!is.na(p.value)) %>%
      mutate(q.value = qvalue(p.value, fdr.level=0.05, pi0.method="bootstrap")$qvalues) %>%
      mutate(LibraryName = ddf)
  output = lm_interaction_wtNormed
  return(output)
}

GI_VST_prolong <- pmap(list(master_df=list(VST_normalized_filtered, VST_normalized_filtered, VST_normalized_filtered), ddf=list("RIM15","PHO85","TOR1")), sub_libraries_GI_prolong)

GI_VST_all_wtNormed_prolong <- bind_rows(GI_VST_prolong[[1]], GI_VST_prolong[[2]], GI_VST_prolong[[3]])

#save files 
#TableS14: Genetic interaction quantification by ANCOVA using different phenotypic readout for proliferation and quiescence. 
write.csv(GI_VST_all_wtNormed_prolong, "./GI_quiescence/sum/tables/TableS14.csv")
```

##Figure 3A & 3B
```{r}
#read in DEseq2 normalized counts table for all libraries
VST_normalized_filtered <- read_csv("./GI_quiescence/sum/tables/TableS3.csv")[,-1]

path = "./GI_quiescence/sum/plot/"
gene = "ATG7"
VST_normalized_filtered %>%
  filter(Common %in% gene) %>%
  filter(SamplingTime %in% c("32","48","96","186","348")) %>%
  filter(!(Common == gene & LibraryName == gene)) %>%
  ggplot(aes(x=SamplingTime, y=Rela2WT, group=LibraryName, color=LibraryName)) +
  geom_point(aes(shape = LibraryName))+
  geom_smooth(method = "lm",aes(fill = LibraryName))+
  ggtitle(paste0(gene, " relative"))+  
  xlab("Hours post inoculation")+
  ylab("Relative frequency to query mutant")+
  scale_color_manual(values=c("#E5C494","#8DA0CB","#E78AC3","#66C2A5"))+
  scale_fill_manual(values=c("#E5C494","#8DA0CB","#E78AC3","#66C2A5"))+
  facet_grid(~nutrient, scales = "free") +
  theme(legend.position="bottom") +
  theme_classic()
ggsave(paste0(path,"Fig3A.pdf"), width=12,height=5)

#caculate the confidence interval for ATG7 slopes
atg7_df <- data.frame()
for (n in sort(unique(VST_normalized_filtered$nutrient))){
  for (i in unique(VST_normalized_filtered$LibraryName)){
    tmp <- 
      VST_normalized_filtered %>%
      filter(SamplingTime %in% c("32","48","96","186","348")) %>%
      filter(LibraryName == i, Common == "ATG7" & nutrient == n) %>%
      group_by(nutrient, LibraryName, Common) %>%
      lm(Rela2WT ~ SamplingTime, .) 
    
    coef <- summary(tmp)
    #caculate the 95% confidence interval
    coef <- coef$coefficients[2,1] 
    low_ci <- confint(tmp, level=0.95)[2,1]
    high_ci <- confint(tmp, level=0.95)[2,2]
    
    df <- data.frame(n, i, coef, low_ci, high_ci)
    atg7_df <- rbind(atg7_df,df)
  }
}

colnames(atg7_df)<-c("nutrient","LibraryName","fitness","low_ci","high_ci")
library(ggsignif)
##dot plot of slopes with 95% confidenc interval
atg7_df$LibraryName <- factor(atg7_df$LibraryName, levels = c("HO","TOR1","RIM15","PHO85"))

ggplot(atg7_df, aes(x=LibraryName, y=fitness, fill=LibraryName)) +
  geom_hline(yintercept=0, col="grey", linetype = "dashed") +
  geom_point(aes(col = LibraryName, size=1.2))+
  geom_errorbar(aes(ymin = low_ci, ymax = high_ci, col = LibraryName), width = 0.2)+
  scale_color_manual(values=c("#E5C494", "#66C2A5","#E78AC3","#8DA0CB")) +
    scale_fill_manual(values=c("#E5C494","#66C2A5","#E78AC3","#8DA0CB"))+
  facet_wrap(~nutrient)+
  #ylim(-0.0022, 0.0018) +
  geom_signif(comparisons=list(c("TOR1", "HO")), annotations="***",
              y_position = 0.0020, tip_length = 0.04, vjust=0.4)+
  geom_signif(comparisons=list(c("RIM15", "HO")), annotations="n.s.",
              y_position = 0.0017, tip_length = 0.04, vjust=0.4)+
  geom_signif(comparisons=list(c("PHO85", "HO")), annotations="n.s.",
              y_position = 0.0014, tip_length = 0.04, vjust=0.4)+
  ylab("Survival rate") +
  theme_classic()
ggsave(paste0(path,"Fig3B.pdf"),width=12,height=4)
```

##GIS quantification method comparison: ANCOVA VS classic mutiplicative model
###Figure 3C & FigureS3B & appendix_Figures associated with Figure 3 --- RIM15
```{r}
#####################################Comparison for stage starvation##############################################
GI_VST_all_wtNormed <- read_csv ("./sum/tables/TableS13.csv")[,-1]
VST_lm_stage_wtNormed <- read_csv("./sum/tables/TableS7.csv")[,-1]

#RIM15: select rim15 from HO library and caculate the expected fitness based on additive model: fitness of rim15 + all the other single mutants in ho library
ho_rim15 <- inner_join(
  #selecting _rim15 fitness and bind to the original ho pool as a inividual column
  VST_lm_stage_wtNormed %>% dplyr::filter(LibraryName == "HO") %>% dplyr::select(-term), VST_lm_stage_wtNormed %>% 
  dplyr::filter(LibraryName == "HO" & Strain == "YFL033C") %>% dplyr::select(-term), by = c("nutrient","LibraryName","GrowStage"), suffix = c(".single",".rim15")) %>%
  #caculate the expected fitness based on additive model and propogate errors
  dplyr::mutate(add.exp = estimate.rim15+estimate.single, 
                std.error.add.exp = std.error.single*std.error.single+std.error.rim15*std.error.rim15) %>%
  dplyr::rename(Strain = Strain.single) %>% 
  dplyr::select(-LibraryName)

#get the fitness of the real double mutant from RIM15 library
real_rim15<-VST_lm_stage_wtNormed %>%
  dplyr::filter(LibraryName == "RIM15") %>%
  dplyr::select(nutrient, Strain, estimate, std.error, p.value, q.value, GrowStage) %>%
  dplyr::rename(estimate.double = estimate, std.error.double = std.error, p.value.double = p.value, q.value.double = q.value) %>%
  drop_na()

#joing the expected double fitness (additive model), real double fitness into the same dataframe 
RIM15 <- inner_join(ho_rim15, real_rim15 , by = c("nutrient","Strain","GrowStage")) %>%
  #caculate the GI for additive model 
  dplyr::mutate(add.gis = exp(estimate.double) - exp(add.exp), 
                std.error.add.gis = std.error.double^2+std.error.add.exp^2)

#extract the GI identified in ANCOVA
ANCOVA_GI_rim15 <- GI_VST_all_wtNormed %>%
  dplyr::filter(LibraryName == "RIM15") %>%
  dplyr::select(-term) %>% drop_na() %>%
  dplyr::rename(ancova.gis = estimate, std.error.ancova = std.error, p.value.ancova = p.value, q.value.ancova = q.value)

#join the expected fitness and ANCOVA estimated GI into the same dataframe
rim15_comparison <- inner_join(ANCOVA_GI_rim15, RIM15, by = c("nutrient" , "Strain", "GrowStage"))

colnames(YtoGene) <- c("Strain","Common")
#classify the significant positive and negative interactions in add those annotation as an additional column in its own dataframe
RIM15 <- left_join(rim15_comparison, YtoGene, by = "Strain") %>%
   mutate(type.ancova = case_when(ancova.gis > 0 & q.value.ancova < 0.05 ~ "pos.sig in ancova", 
                                  ancova.gis < 0 & q.value.ancova < 0.05 ~ "neg.sig in ancova",
                                  q.value.ancova > 0.05 ~ "neutral in ancova"))

#TableS15: Genetic interaction data for Kinase RIM15. This table includes: single mutant fitness, double mutant fitness, expected double mutant fitness based on mutiplicative model, and the corresponding statistical values for each model.
write_csv(RIM15, "./sum/tables/TableS15.csv")

RIM15_Sig <- RIM15 %>%
   dplyr::filter(type.ancova %in% c("pos.sig in ancova", "neg.sig in ancova"))

#scatter plot of the ANCOVA analysed GI and additive model GI 
ggscatter(RIM15, x = "ancova.gis", y = "add.gis", alpha = 0.2, size=1.2, 
          cor.coef.size = 0.3, col= "nutrient", shape = "nutrient", fill = "nutrient")+
  xlab("GIS by ANCOVA") +
  ylab("GIS by multiplicative model") +
  ggtitle("RIM15") +
  facet_grid(~GrowStage, scale = "free")+
  geom_smooth(aes(col = nutrient), method = "lm", se = FALSE, size = 0.7)+
  stat_cor(aes(col = nutrient), method = "pearson", label.x.npc = "left", label.y.npc = "top", size=4) +
  xlim(-1,1)+
  ylim(-1,1)+
  scale_color_manual(values=c("#FFA500", "#7ACE0D", "#A564F9"))+
  scale_fill_manual(values=c("#FFA500", "#7ACE0D", "#A564F9"))+
  theme(axis.text=element_text(size=12), axis.text.x=element_text(angle=0),
        axis.title=element_text(size=12,face="bold")) 
ggsave("./sum/plot/Appendix_Figure3A.pdf" , width = 7, height = 5)

#scatter plot of the double and sigle mutant comparison
ggscatter(RIM15 %>% filter(nutrient == "phosphate"), x = "estimate.single", y = "estimate.double", alpha = 0.7, size=0.7, 
          cor.coef.size = 0.3, col= "type.ancova") +
  xlab("Fitness in single array mutant") +
  ylab("Fitness in double mutatn") +
  ggtitle("RIM15") +
  facet_grid(nutrient~GrowStage) +
  geom_abline(intercept = 0, slope = 1 , linetype = "dashed", col = "#333333") +
  ylim(-0.5,0.5) +
  xlim(-0.5,0.5) +
    stat_cor(col = "#333333",method = "pearson", label.x.npc = "left", label.y.npc = "top", size=4) +
  geom_smooth(col = "#333333", method = "lm", se = FALSE, size = 0.7)+
  facet_grid(nutrient~GrowStage, scale = "free") +
  scale_color_manual(values=c("#3399FF", "darkgrey", "#FFCC33")) +
  scale_fill_manual(values=c("#3399FF", "darkgrey", "#FFCC33")) +
  theme(axis.text=element_text(size=12), axis.text.x=element_text(angle=0), 
        axis.title=element_text(size=12,face="bold")) 
ggsave("./sum/plot/Fig3C.pdf", width = 8, height = 5)

#scatter plot of the double and sigle mutant comparison
ggscatter(RIM15, x = "estimate.single", y = "estimate.double", alpha = 0.7, size=0.7, 
          cor.coef.size = 0.3, col= "type.ancova") +
  xlab("Fitness in single array mutant") +
  ylab("Fitness in double mutatn") +
  ggtitle("RIM15") +
  facet_grid(nutrient~GrowStage) +
  geom_abline(intercept = 0, slope = 1 , linetype = "dashed", col = "#333333") +
  ylim(-0.5,0.5) +
  xlim(-0.5,0.5) +
    stat_cor(col = "#333333",method = "pearson", label.x.npc = "left", label.y.npc = "top", size=4) +
  geom_smooth(col = "#333333", method = "lm", se = FALSE, size = 0.7)+
  facet_grid(nutrient~GrowStage, scale = "free") +
  scale_color_manual(values=c("#3399FF", "darkgrey", "#FFCC33")) +
  scale_fill_manual(values=c("#3399FF", "darkgrey", "#FFCC33")) +
  theme(axis.text=element_text(size=12), axis.text.x=element_text(angle=0), 
        axis.title=element_text(size=12,face="bold")) 
ggsave("./sum/plot/FigS3B.pdf", width = 7, height = 7)

#check whether the significant positive ones have low single mutant fitness?
ggscatter(RIM15 %>%
            dplyr::filter (type.ancova == "pos.sig in ancova"), x = "estimate.single", y = "estimate.double", alpha = 0.7, size=0.7, 
          cor.coef.size = 0.3, col= "nutrient") +
  xlab("Fitness in single array mutant") +
  ylab("Fitness in double mutatn") +
  ggtitle("Genes show significant positive interaction with RIM15") +
  facet_grid(~GrowStage) +
  geom_vline(xintercept = 0, linetype="dotted", 
                color = "#333333", size=1) +
  ylim(-0.25,0.5) +
  xlim(-0.5,0.25) +
  facet_grid(~GrowStage, scale = "free") +
  scale_color_manual(values=c("#FFA500", "#7ACE0D", "#A564F9")) +
  scale_fill_manual(values=c("#FFA500", "#7ACE0D", "#A564F9")) +
  theme(axis.text=element_text(size=12), axis.text.x=element_text(angle=0), 
        axis.title=element_text(size=12,face="bold")) 

ggscatter(RIM15 %>%
            dplyr::filter (type.ancova == "neg.sig in ancova"), x = "estimate.single", y = "estimate.double", alpha = 0.7, size=0.7, 
          cor.coef.size = 0.3, col= "nutrient") +
  xlab("Fitness in single array mutant") +
  ylab("Fitness in double mutatn") +
  ggtitle("Genes show significant negative interaction with RIM15") +
  facet_grid(~GrowStage) +
  geom_vline(xintercept = 0, linetype="dotted", 
                color = "#333333", size=1) +
  ylim(-0.5,0.25) +
  xlim(-0.25,0.5) +
  facet_grid(~GrowStage, scale = "free") +
  scale_color_manual(values=c("#FFA500", "#7ACE0D", "#A564F9")) +
  scale_fill_manual(values=c("#FFA500", "#7ACE0D", "#A564F9")) +
  theme(axis.text=element_text(size=12), axis.text.x=element_text(angle=0), 
        axis.title=element_text(size=12,face="bold")) 

#scatter plot of the expected fitness and observed fitness in double mutant library
ggscatter(RIM15, x = "add.exp", y = "estimate.double", alpha = 0.2, size=1, cor.coef.size = 0.3, col= "nutrient") +
    xlab("Expected fitness by multiplicative model") +
    ylab("Observed fitness") +
    ggtitle("RIM15") +
    geom_smooth(aes(col = nutrient), method = "lm", se = FALSE, size = 0.7)+
    facet_grid(~GrowStage, scale = "free") +
  geom_hline(yintercept=0, linetype="dashed", col="darkgrey") +
  geom_vline(xintercept=0, linetype="dashed", col="darkgrey") +
  scale_color_manual(values=c("#3399FF", "grey", "#FFCC33")) +
  scale_fill_manual(values=c("#3399FF", "grey", "#FFCC33")) +
    theme(axis.text=element_text(size=12), axis.text.x=element_text(angle=90), axis.title=element_text(size=12,face="bold")) 

#comparision between single and GI
ggscatter(RIM15, x = "estimate.single", y = "ancova.gis", alpha = 0.7, size=0.7, 
          cor.coef.size = 0.3, col= "type.ancova") +
  xlab("Fitness in single array mutant") +
  ylab("GIS") +
  ggtitle("RIM15") +
  facet_grid(nutrient~GrowStage) +
  ylim(-0.5,0.5) +
  xlim(-0.5,0.5) +
  facet_grid(nutrient~GrowStage, scale = "free") +
  geom_hline(yintercept=0, linetype="dashed", col="darkgrey") +
  geom_vline(xintercept=0, linetype="dashed", col="darkgrey") +
  scale_color_manual(values=c("#3399FF", "grey", "#FFCC33")) +
  scale_fill_manual(values=c("#3399FF", "grey", "#FFCC33")) +
  theme(axis.text=element_text(size=12), axis.text.x=element_text(angle=0), 
        axis.title=element_text(size=12,face="bold")) 
ggsave("./sum/reviewer/FigEV4E_RIM15single_reviewer.pdf", width = 8, height = 5)

#comparision between single and GI
ggscatter(RIM15, x = "estimate.double", y = "ancova.gis", alpha = 0.7, size=0.7, 
          cor.coef.size = 0.3, col= "type.ancova") +
  xlab("Fitness in double mutant") +
  ylab("GIS by ANCOVA") +
  ggtitle("RIM15") +
  facet_grid(nutrient~GrowStage) +
  ylim(-0.5,0.5) +
  xlim(-0.5,0.5) +
  geom_hline(yintercept=0, linetype="dashed", col="darkgrey") +
  geom_vline(xintercept=0, linetype="dashed", col="darkgrey") +
  facet_grid(nutrient~GrowStage, scale = "free") +
  scale_color_manual(values=c("#3399FF", "grey", "#FFCC33")) +
  scale_fill_manual(values=c("#3399FF", "grey", "#FFCC33")) +
  theme(axis.text=element_text(size=12), axis.text.x=element_text(angle=0), 
        axis.title=element_text(size=12,face="bold")) 
ggsave("./sum/reviewer/FigEV4F_RIM15double_reviewer.pdf", width = 8, height = 5)

ggscatter 
```

#check whether the model has a larger variance as the fitness/slope becomes extrem
```{r}
VST_lm_stage_wtNormed <- read_csv("./sum/tables/TableS7.csv")[,-1]

#Overall "#3399FF", "darkgrey", "#FFCC33"
ggplot(VST_lm_stage_wtNormed, aes(estimate, std.error), group = "LibraryName", col = "LibraryName") +
  geom_point(data = filter(VST_lm_stage_wtNormed, q.value > 0.05), color ="darkgrey",alpha = 1/3, size = 0.5) +
  geom_point(data = filter(VST_lm_stage_wtNormed, q.value < 0.05, estimate > 0), color = ("#FFCC33"), alpha = 1/3, size = 0.5)+
  geom_point(data = filter(VST_lm_stage_wtNormed, q.value < 0.05, estimate < 0), color = ("#3399FF"), alpha = 1/3, size = 0.5)+
  theme_classic() +
  geom_smooth(col = "#333333", size = 0.4)+
  facet_grid(nutrient+LibraryName~GrowStage) +
  xlab(expression("Fitness or survival rate")) +
  ylab(expression("Standard error")) +
  theme(plot.title = element_text(hjust = 0.5, size = 4), axis.title = element_text(size = 8), axis.text = element_text(size = 8, colour = "black"), text = element_text(size=8))
ggsave("./sum/reviewer/FigEV6.pdf", width = 4, height = 6)
```

#check the relationship between pval and std
```{r}
VST_lm_stage_wtNormed <- read_csv("./sum/tables/TableS7.csv")[,-1]

ggplot(VST_lm_stage_wtNormed %>% filter(LibraryName == "HO"), aes(estimate, -log10(q.value))) +
  geom_point(data = filter(VST_lm_stage_wtNormed, q.value > 0.05), color ="grey",alpha = 1/4) +
  geom_point(data = filter(VST_lm_stage_wtNormed, q.value < 0.05), color = ("#E5C494"), alpha = 1/4)+
  theme_classic() +
    facet_grid(nutrient~GrowStage, scale = "free") +
  xlab(expression("Fitness or survival rate")) +
  ylab(expression(-Log[10]*adj.P)) +
  theme(plot.title = element_text(hjust = 0.5, size = 14), axis.title = element_text(size = 12), axis.text = element_text(size = 10, colour = "black"))

ggplot(VST_lm_stage_wtNormed %>% filter(LibraryName == "TOR1"), aes(estimate, -log10(q.value))) +
  geom_point(data = filter(VST_lm_stage_wtNormed, q.value > 0.05), color ="grey",alpha = 1/4) +
  geom_point(data = filter(VST_lm_stage_wtNormed, q.value < 0.05), color = ("#66C2A5"), alpha = 1/4)+
  theme_classic() +
    facet_grid(nutrient~GrowStage, scale = "free") +
  xlab(expression("Fitness or survival rate")) +
  ylab(expression(-Log[10]*adj.P)) +
  theme(plot.title = element_text(hjust = 0.5, size = 14), axis.title = element_text(size = 12), axis.text = element_text(size = 10, colour = "black"))

ggplot(VST_lm_stage_wtNormed %>% filter(LibraryName == "RIM15"), aes(estimate, -log10(q.value))) +
  geom_point(data = filter(VST_lm_stage_wtNormed, q.value > 0.05), color ="grey",alpha = 1/4) +
  geom_point(data = filter(VST_lm_stage_wtNormed, q.value < 0.05), color = ("#E78AC3"), alpha = 1/4)+
  theme_classic() +
    facet_grid(nutrient~GrowStage, scale = "free") +
  xlab(expression("Fitness or survival rate")) +
  ylab(expression(-Log[10]*adj.P)) +
  theme(plot.title = element_text(hjust = 0.5, size = 14), axis.title = element_text(size = 12), axis.text = element_text(size = 10, colour = "black"))

ggplot(VST_lm_stage_wtNormed %>% filter(LibraryName == "PHO85"), aes(estimate, -log10(q.value))) +
  geom_point(data = filter(VST_lm_stage_wtNormed, q.value > 0.05), color ="grey",alpha = 1/4) +
  geom_point(data = filter(VST_lm_stage_wtNormed, q.value < 0.05), color = ("#8DA0CB"), alpha = 1/4)+
  theme_classic() +
    facet_grid(nutrient~GrowStage, scale = "free") +
  xlab(expression("Fitness or survival rate")) +
  ylab(expression(-Log[10]*adj.P)) +
  theme(plot.title = element_text(hjust = 0.5, size = 14), axis.title = element_text(size = 12), axis.text = element_text(size = 10, colour = "black"))
```

###FigureS3A & appendix_Figures associated with Figure 3 --- TOR1
```{r}
#TOR1 select tor1 from ho library and caculate the expected fitness based on additive model: fitness of tor1 + all the other single mutants in ho library
ho_tor1 <- inner_join(
  #selecting _tor1 fitness and bind to the original ho pool as a inividual column
  VST_lm_stage_wtNormed %>% dplyr::filter(LibraryName == "HO"), VST_lm_stage_wtNormed %>% 
  dplyr::filter(LibraryName == "HO" & Strain == "YJR066W"), by = c("nutrient","LibraryName","term","GrowStage"), suffix = c(".single",".tor1")) %>%
  #caculate the expected fitness based on additive model and propogate errors
  dplyr::mutate(add.exp = estimate.tor1+estimate.single, std.error.add.exp = std.error.single*std.error.single+std.error.tor1*std.error.tor1) %>%
  dplyr::rename(Strain = Strain.single) %>% 
  dplyr::select(-LibraryName)

#get the fitness of the real double mutant from TOR1 library
real_tor1<-VST_lm_stage_wtNormed %>%
  dplyr::filter(LibraryName == "TOR1") %>%
  dplyr::select(nutrient, Strain, estimate, std.error, p.value, q.value, GrowStage) %>%
  dplyr::rename(estimate.double = estimate, std.error.double = std.error, p.value.double = p.value, q.value.double = q.value) %>%
  drop_na()

#joing the expected double fitness (additive model), real double fitness into the same dataframe 
TOR1 <- inner_join(ho_tor1 %>% dplyr::select(-term), real_tor1 , by = c("nutrient","Strain","GrowStage")) %>%
  #caculate the GI for additive model 
  dplyr::mutate(add.gis = exp(estimate.double) - exp(add.exp), std.error.add.gis = std.error.double^2+std.error.add.exp^2)

#extract the GI identified in ANCOVA
ANCOVA_GI_tor1 <- GI_VST_all_wtNormed %>%
  dplyr::filter(LibraryName == "TOR1") %>%
  dplyr::select(-term) %>% drop_na() %>%
  dplyr::rename(ancova.gis = estimate, std.error.ancova = std.error, p.value.ancova = p.value, q.value.ancova = q.value)

#join the expected fitness and ANCOVA estimated GI into the same dataframe
tor1_comparison <- inner_join(ANCOVA_GI_tor1, TOR1, by = c("nutrient" , "Strain", "GrowStage"))

#classify the significant positive and negative interactions in add those annotation as an additional column in its own dataframe
TOR1 <- left_join(tor1_comparison, YtoGene, by = "Strain") %>%
   mutate(type.ancova = case_when(ancova.gis > 0 & q.value.ancova < 0.05 ~ "pos.sig in ancova", 
                                  ancova.gis < 0 & q.value.ancova < 0.05 ~ "neg.sig in ancova",
                                  q.value.ancova > 0.05 ~ "neutral in ancova"))

#TableS16: Genetic interaction data for Kinase TOR1 This table includes: single mutant fitness, double mutant fitness, expected double mutant fitness based on mutiplicative model, and the corresponding statistical values for each model.
write_csv(TOR1, "./sum/tables/TableS16.csv")

TOR1_Sig <- TOR1 %>%
   dplyr::filter(type.ancova %in% c("pos.sig in ancova", "neg.sig in ancova"))

#scatter plot of the ANCOVA analysed GI and additive model GI 
ggscatter(TOR1, x = "ancova.gis", y = "add.gis", alpha = 0.2, size=1.2, 
          cor.coef.size = 0.3, col= "nutrient", shape = "nutrient", fill = "nutrient")+
  xlab("GIS by ANCOVA") +
  ylab("GIS by multiplicative model") +
  facet_grid(~GrowStage, scale = "free")+
  geom_smooth(aes(col = nutrient), method = "lm", se = FALSE, size = 0.7)+
  stat_cor(aes(col = nutrient), method = "pearson", label.x.npc = "left", label.y.npc = "top", size=4) +
  xlim(-0.6,0.6)+
  ylim(-0.6,0.6)+
  ggtitle("TOR1")+
  scale_color_manual(values=c("#FFA500", "#7ACE0D", "#A564F9"))+
  scale_fill_manual(values=c("#FFA500", "#7ACE0D", "#A564F9"))+
  theme(axis.text=element_text(size=12), axis.text.x=element_text(angle=0),
        axis.title=element_text(size=12,face="bold")) 
ggsave("./sum/plot/FigS3A.pdf", width = 7, height = 4.5)

#TOR1
ggscatter(TOR1 %>%
            dplyr::filter (type.ancova == "pos.sig in ancova"), x = "estimate.single", y = "estimate.double", alpha = 0.7, size=0.7, 
          cor.coef.size = 0.3, col= "nutrient") +
  xlab("Fitness in single array mutant") +
  ylab("Fitness in double mutatn") +
  ggtitle("TOR1") +
  facet_grid(~GrowStage) +
  geom_vline(xintercept = 0, linetype="dotted", 
                color = "#333333", size=1) +
  ylim(-0.5,0.5) +
  xlim(-0.5,0.5) +
  facet_grid(~GrowStage, scale = "free") +
  scale_color_manual(values=c("#FFA500", "#7ACE0D", "#A564F9")) +
  scale_fill_manual(values=c("#FFA500", "#7ACE0D", "#A564F9")) +
  theme(axis.text=element_text(size=12), axis.text.x=element_text(angle=0), 
        axis.title=element_text(size=12,face="bold")) 

#scatter plot of the double and sigle mutant comparison
ggscatter(TOR1, x = "estimate.single", y = "estimate.double", alpha = 0.5, size=1, 
          cor.coef.size = 0.3, col= "type.ancova") +
  xlab("Fitness in single array mutant") +
  ylab("Fitness in double mutant") +
  ggtitle("TOR1") +
  stat_cor(col = "#333333",method = "pearson", label.x.npc = "left", label.y.npc = "top", size=4) +
  geom_smooth(col = "#333333", method = "lm", se = FALSE, size = 0.7)+
  facet_grid(nutrient~GrowStage) +
  geom_abline(intercept = 0, slope = 1 , linetype = "dashed", col = "#333333", alpha = 0.5) +
  ylim(-0.4,0.4) +
  xlim(-0.4,0.4) +
  facet_grid(nutrient~GrowStage, scale = "free") +
  scale_color_manual(values=c("#3399FF", "darkgrey", "#FFCC33")) +
  scale_fill_manual(values=c("#3399FF", "darkgrey", "#FFCC33")) +
  theme(axis.text=element_text(size=12), axis.text.x=element_text(angle=0), 
        axis.title=element_text(size=12,face="bold")) 
ggsave("./sum/plot/Appendix_Figure3B.pdf", width = 7, height = 7)

#scatter plot of the expected fitness and observed fitness in double mutant library
ggscatter(TOR1, x = "add.exp", y = "estimate.double", alpha = 0.2, size=1, cor.coef.size = 0.3, col= "nutrient") +
    xlab("Expected fitness by multiplicative model") +
    ylab("Observed fitness") +
    ggtitle("TOR1") +
    geom_smooth(aes(col = nutrient), method = "lm", se = FALSE, size = 0.7)+
    facet_grid(~GrowStage, scale = "free") +
    stat_cor(aes(col = nutrient), method = "pearson", label.x.npc = "left", label.y.npc = "top", size=4) +
    scale_color_manual(values=c("#FFA500", "#7ACE0D", "#A564F9")) +
    scale_fill_manual(values=c("#FFA500", "#7ACE0D", "#A564F9")) +
    theme(axis.text=element_text(size=12), axis.text.x=element_text(angle=90), axis.title=element_text(size=12,face="bold")) 

#comparision between single and GI
ggscatter(TOR1, x = "estimate.single", y = "ancova.gis", alpha = 0.7, size=0.7, 
          cor.coef.size = 0.3, col= "type.ancova") +
  xlab("Fitness in single array mutant") +
  ylab("GIS") +
  ggtitle("TOR1") +
  facet_grid(nutrient~GrowStage) +
  ylim(-0.5,0.5) +
  xlim(-0.5,0.5) +
  facet_grid(nutrient~GrowStage, scale = "free") +
  geom_hline(yintercept=0, linetype="dashed", col="darkgrey") +
  geom_vline(xintercept=0, linetype="dashed", col="darkgrey") +
  scale_color_manual(values=c("#3399FF", "grey", "#FFCC33")) +
  scale_fill_manual(values=c("#3399FF", "grey", "#FFCC33")) +
  theme(axis.text=element_text(size=12), axis.text.x=element_text(angle=0), 
        axis.title=element_text(size=12,face="bold")) 
ggsave("./sum/reviewer/FigEV4_TOR1single_reviewer.pdf", width = 8, height = 5)

#comparision between single and GI
ggscatter(TOR1, x = "estimate.double", y = "ancova.gis", alpha = 0.7, size=0.7, 
          cor.coef.size = 0.3, col= "type.ancova") +
  xlab("Fitness in double mutant") +
  ylab("GIS") +
  ggtitle("TOR1") +
  facet_grid(nutrient~GrowStage) +
  ylim(-0.5,0.5) +
  xlim(-0.5,0.5) +
  facet_grid(nutrient~GrowStage, scale = "free") +
  geom_hline(yintercept=0, linetype="dashed", col="darkgrey") +
  geom_vline(xintercept=0, linetype="dashed", col="darkgrey") +
  scale_color_manual(values=c("#3399FF", "grey", "#FFCC33")) +
  scale_fill_manual(values=c("#3399FF", "grey", "#FFCC33")) +
  theme(axis.text=element_text(size=12), axis.text.x=element_text(angle=0), 
        axis.title=element_text(size=12,face="bold")) 
ggsave("./sum/reviewer/FigEV4_TOR1double_reviewer.pdf", width = 8, height = 5)
```

###FigureS3C & appendix_Figures associated with Figure 3 --- PHO85
```{r}
#PHO85 select PHO85 from ho library and caculate the expected fitness based on additive model: fitness of PHO85 + all the other single mutants in ho library
ho_pho85 <- left_join(
  #selecting _pho85 fitness and bind to the original ho pool as a inividual column
  VST_lm_stage_wtNormed %>% dplyr::filter(LibraryName == "HO"), VST_lm_stage_wtNormed %>% 
  dplyr::filter(LibraryName == "HO" & Strain == "YPL031C"), by = c("nutrient","LibraryName","term","GrowStage"), suffix = c(".single",".pho85")) %>%
  #caculate the expected fitness based on additive model and propogate errors
  dplyr::mutate(add.exp = estimate.pho85+estimate.single, std.error.add.exp = std.error.single*std.error.single+std.error.pho85*std.error.pho85) %>%
  dplyr::rename(Strain = Strain.single) %>% 
  dplyr::select(-LibraryName)

#get the fitness of the real double mutant from PHO85 library
real_pho85<-VST_lm_stage_wtNormed %>%
  dplyr::filter(LibraryName == "PHO85") %>%
  dplyr::select(nutrient, Strain, estimate, std.error, p.value, q.value, GrowStage) %>%
  dplyr::rename(estimate.double = estimate, std.error.double = std.error, p.value.double = p.value, q.value.double = q.value) %>%
  drop_na()

#joing the expected double fitness (additive model), real double fitness into the same dataframe 
PHO85 <- inner_join(ho_pho85 %>% dplyr::select(-term), real_pho85 , by = c("nutrient","Strain","GrowStage")) %>%
  #caculate the GI for additive model 
  dplyr::mutate(add.gis = exp(estimate.double) - exp(add.exp), std.error.add.gis = std.error.double^2+std.error.add.exp^2)

#extract the GI identified in ANCOVA
ANCOVA_GI_pho85 <- GI_VST_all_wtNormed %>%
  dplyr::filter(LibraryName == "PHO85") %>%
  dplyr::select(-term) %>% drop_na() %>%
  dplyr::rename(ancova.gis = estimate, std.error.ancova = std.error, p.value.ancova = p.value, q.value.ancova = q.value)

#join the expected fitness and ANCOVA estimated GI into the same dataframe
pho85_comparison <- inner_join(ANCOVA_GI_pho85, PHO85, by = c("nutrient" , "Strain", "GrowStage"))

#classify the significant positive and negative interactions in add those annotation as an additional column in its own dataframe
PHO85 <- left_join(pho85_comparison, YtoGene, by = "Strain") %>%
   mutate(type.ancova = case_when(ancova.gis > 0 & q.value.ancova < 0.05 ~ "pos.sig in ancova", 
                                  ancova.gis < 0 & q.value.ancova < 0.05 ~ "neg.sig in ancova",
                                  q.value.ancova > 0.05 ~ "neutral in ancova"))

#TableS17: Genetic interaction data for Kinase PHO85. This table includes: single mutant fitness, double mutant fitness, expected double mutant fitness based on mutiplicative model, and the corresponding statistical values for each model.
write_csv(PHO85, "./sum/tables/TableS17.csv")

PHO85_Sig <- PHO85 %>%
   dplyr::filter(type.ancova %in% c("pos.sig in ancova", "neg.sig in ancova"))

ggscatter(PHO85 %>%
            dplyr::filter (type.ancova == "pos.sig in ancova"), x = "estimate.single", y = "estimate.double", alpha = 0.7, size=0.7, 
          cor.coef.size = 0.3, col= "nutrient") +
  xlab("Fitness in single array mutant") +
  ylab("Fitness in double mutatn") +
  ggtitle("PHO85") +
  facet_grid(~GrowStage) +
  geom_vline(xintercept = 0, linetype="dotted", 
                color = "#333333", size=1) +
  ylim(-0.5,0.5) +
  xlim(-0.5,0.5) +
  facet_grid(~GrowStage, scale = "free") +
  scale_color_manual(values=c("#FFA500", "#7ACE0D", "#A564F9")) +
  scale_fill_manual(values=c("#FFA500", "#7ACE0D", "#A564F9")) +
  theme(axis.text=element_text(size=12), axis.text.x=element_text(angle=0), 
        axis.title=element_text(size=12,face="bold")) 

ggscatter(PHO85 %>%
            dplyr::filter (type.ancova == "neg.sig in ancova"), x = "estimate.single", y = "estimate.double", alpha = 0.7, size=0.7, 
          cor.coef.size = 0.3, col= "nutrient") +
  xlab("Fitness in single array mutant") +
  ylab("Fitness in double mutatn") +
  ggtitle("PHO85") +
  facet_grid(~GrowStage) +
  geom_vline(xintercept = 0, linetype="dotted", 
                color = "#333333", size=1) +
  ylim(-0.5,0.5) +
  xlim(-0.5,0.5) +
  facet_grid(~GrowStage, scale = "free") +
  scale_color_manual(values=c("#FFA500", "#7ACE0D", "#A564F9")) +
  scale_fill_manual(values=c("#FFA500", "#7ACE0D", "#A564F9")) +
  theme(axis.text=element_text(size=12), axis.text.x=element_text(angle=0), 
        axis.title=element_text(size=12,face="bold")) 

#scatter plot of the double and sigle mutant comparison
ggscatter(PHO85, x = "estimate.single", y = "estimate.double", alpha = 0.7, size=0.7, 
          cor.coef.size = 0.3, col= "type.ancova") +
  xlab("Fitness in single array mutant") +
  ylab("Fitness in double mutatn") +
  ggtitle("PHO85") +
  facet_grid(nutrient~GrowStage) +
  geom_abline(intercept = 0, slope = 1 , linetype = "dashed", col = "#333333") +
  ylim(-0.5,0.5) +
  xlim(-0.5,0.5) +
    stat_cor(col = "#333333",method = "pearson", label.x.npc = "left", label.y.npc = "top", size=4) +
  geom_smooth(col = "#333333", method = "lm", se = FALSE, size = 0.7)+
  facet_grid(nutrient~GrowStage, scale = "free") +
  scale_color_manual(values=c("#3399FF", "darkgrey", "#FFCC33")) +
  scale_fill_manual(values=c("#3399FF", "darkgrey", "#FFCC33")) +
  theme(axis.text=element_text(size=12), axis.text.x=element_text(angle=0), 
        axis.title=element_text(size=12,face="bold")) 
ggsave("./sum/plot/Appendix_Figure3C.pdf", width = 7, height = 7)

#comparision between single and GI
ggscatter(PHO85, x = "estimate.single", y = "ancova.gis", alpha = 0.7, size=0.7, 
          cor.coef.size = 0.3, col= "type.ancova") +
  xlab("Fitness in single array mutant") +
  ylab("GIS") +
  ggtitle("PHO85") +
  facet_grid(nutrient~GrowStage) +
  ylim(-0.5,0.5) +
  xlim(-0.5,0.5) +
  facet_grid(nutrient~GrowStage, scale = "free") +
  geom_hline(yintercept=0, linetype="dashed", col="darkgrey") +
  geom_vline(xintercept=0, linetype="dashed", col="darkgrey") +
  scale_color_manual(values=c("#3399FF", "grey", "#FFCC33")) +
  scale_fill_manual(values=c("#3399FF", "grey", "#FFCC33")) +
  theme(axis.text=element_text(size=12), axis.text.x=element_text(angle=0), 
        axis.title=element_text(size=12,face="bold")) 
ggsave("./sum/reviewer/FigEV4_PHO85single_reviewer.pdf", width = 8, height = 5)

#comparision between single and GI
ggscatter(PHO85, x = "estimate.double", y = "ancova.gis", alpha = 0.7, size=0.7, 
          cor.coef.size = 0.3, col= "type.ancova") +
  xlab("Fitness in double mutant") +
  ylab("GIS") +
  ggtitle("PHO85") +
  facet_grid(nutrient~GrowStage) +
  ylim(-0.5,0.5) +
  xlim(-0.5,0.5) +
  facet_grid(nutrient~GrowStage, scale = "free") +
  geom_hline(yintercept=0, linetype="dashed", col="darkgrey") +
  geom_vline(xintercept=0, linetype="dashed", col="darkgrey") +
  scale_color_manual(values=c("#3399FF", "grey", "#FFCC33")) +
  scale_fill_manual(values=c("#3399FF", "grey", "#FFCC33")) +
  theme(axis.text=element_text(size=12), axis.text.x=element_text(angle=0), 
        axis.title=element_text(size=12,face="bold")) 
ggsave("./sum/reviewer/FigEV4_PHO85double_reviewer.pdf", width = 8, height = 5)
```

#reply to Reviwer#1 02192020
##save data sets for SAFE analysis on Single, double mutant fitness and GIS-add
```{r}
#isolate and safe dataset for SAFE analysis on single, double and GIS-add
#Data preparation for SAFE annotation
path = "./sum/"

tmp<-bind_rows(RIM15, TOR1, PHO85)

#single mutant fitness a loop to save all files in each catagory
for (s in c("Pro", "Qui")){
  for (n in c("carbon","nitrogen","phosphate")){
    for (q in c("TOR1","RIM15","PHO85")){ 
      tmp %>% 
        filter(nutrient == n & LibraryName == q & GrowStage == s) %>%
        dplyr::select(Strain, estimate.single, p.value.single, q.value.single, LibraryName) %>%
        dplyr::rename(ORF = Strain, GIS = estimate.single, Query = LibraryName) %>%
        write.csv(.,file = paste0(path,"safe_single/",s,"/",n,"/",q,"_single.csv"), row.names = FALSE)
      
      tmp %>% 
        filter(nutrient == n & LibraryName == q & GrowStage == s) %>%
        dplyr::select(Strain, estimate.double, p.value.double, q.value.double, LibraryName) %>%
        dplyr::rename(ORF = Strain, GIS = estimate.double, Query = LibraryName) %>%
        write.csv(.,file = paste0(path,"safe_double/",s,"/",n,"/",q,"_double.csv"), row.names = FALSE)
      
      tmp %>% 
        filter(nutrient == n & LibraryName == q & GrowStage == s) %>%
        dplyr::select(Strain, add.gis, std.error.add.gis, LibraryName) %>%
        dplyr::rename(ORF = Strain, GIS = add.gis, Query = LibraryName) %>%
        write.csv(.,file = paste0(path,"safe_add_gis/",s,"/",n,"/",q,"_add_gis.csv"), row.names = FALSE)
      }
  }
}
```

#reply to Reviwer#1 02192020
##Only apply safe to the statistically significant interacting genes
```{r}
#isolate and safe dataset for SAFE analysis on single, double and GIS-add
#Data preparation for SAFE annotation
path = "./sum/"

#isolate the useful columns and change non significant GIS into 0, so that those insignificant ones will not be considered in SAFE analysis
RIM15_sig <- RIM15 %>% select(nutrient, Strain, GrowStage, ancova.gis, LibraryName, type.ancova) %>% mutate(ancova.gis = ifelse(type.ancova == "neutral in ancova",  0, ancova.gis))
  
TOR1_sig <- TOR1 %>% select(nutrient, Strain, GrowStage, ancova.gis, LibraryName, type.ancova) %>% mutate(ancova.gis = ifelse(type.ancova == "neutral in ancova",  0, ancova.gis))

PHO85_sig <- PHO85 %>% select(nutrient, Strain, GrowStage, ancova.gis, LibraryName, type.ancova) %>% mutate(ancova.gis = ifelse(type.ancova == "neutral in ancova",  0, ancova.gis))
  
tmp<-bind_rows(RIM15_sig, TOR1_sig, PHO85_sig)

#single mutant fitness a loop to save all files in each catagory
for (s in c("Pro", "Qui")){
  for (n in c("carbon","nitrogen","phosphate")){
    for (q in c("TOR1","RIM15","PHO85")){ 
      tmp %>% 
        filter(nutrient == n & LibraryName == q & GrowStage == s) %>%
        dplyr::select(Strain, ancova.gis, LibraryName) %>%
        dplyr::rename(ORF = Strain, GIS = ancova.gis, Query = LibraryName) %>%
        write.csv(.,file = paste0(path,"safe_sig/",s,"/",n,"/",q,"_sig_gis.csv"), row.names = FALSE)
      }
  }
}
```

#reply to Reviwer#1 11252019
###Gene Set Enrichment Analysis for GI profiles of TOR1,RIM15 caculated by different modeling.
```{r}
RIM15<-read_csv("./GI_quiescence/sum/tables/TableS15.csv")
TOR1<-read_csv("./GI_quiescence/sum/tables/TableS16.csv")

data_rim15 <- melt(RIM15 %>% dplyr::select(Strain, GrowStage, nutrient, ancova.gis, add.gis) %>% 
                     dplyr::rename(ancova = ancova.gis, add = add.gis, Systematic = Strain)) %>%
                     unite(cond, c("nutrient", "GrowStage","variable"), sep = "_") %>%
  spread(key = cond, value = value) %>%
  drop_na()

data_tor1 <-  melt(TOR1 %>% dplyr::select(Strain, GrowStage, nutrient, ancova.gis, add.gis) %>% 
                     dplyr::rename(ancova = ancova.gis, add = add.gis, Systematic = Strain)) %>%
                     unite(cond, c("nutrient", "GrowStage","variable"), sep = "_") %>%
  spread(key = cond, value = value) %>%
  drop_na()

cormat_fitness_rim15 <- round(cor(as.matrix(data_rim15[,-1])),2)

# Print the correlation heatmap
ggcorrplot(cormat_fitness_rim15,  method = "square", hc.method = "complete",  
           hc.order = FALSE, outline.col = "white",
           colors = c("#5959F7", "white", "#FF0000"), type = "full") +
  ggtitle("RIM15")
ggsave("./GI_quiescence/sum/reviewer/Model_comparison_rim15.pdf", width = 8, height = 8)

cormat_fitness_tor1 <- round(cor(as.matrix(data_tor1[,-1])),2)

write.csv(cormat_fitness_rim15, "./GI_quiescence/sum/tables/TableS12a.csv")
write.csv(cormat_fitness_tor1, "./GI_quiescence/sum/tables/TableS12b.csv")

# Print the correlation heatmap
ggcorrplot(cormat_fitness_tor1,  method = "square", hc.method = "complete",  
           hc.order = FALSE, outline.col = "white",
           colors = c("#5959F7", "white", "#FF0000"), type = "full") +
  ggtitle("TOR1")
ggsave("./GI_quiescence/sum/reviewer/Model_comparison_tor1.pdf", width = 8, height = 8)

YtoGene <- read.table("./GI_quiescence/sum/data/YORFtoGENE_2018")
names(YtoGene) <- c("Systematic","Common")
table <- left_join(bind_rows(melt(RIM15 %>% dplyr::select(Strain, GrowStage, nutrient, ancova.gis, add.gis) %>% 
                     dplyr::rename(ancova = ancova.gis, add = add.gis, Systematic = Strain)) %>% mutate(Library = "RIM15"), melt(TOR1 %>% dplyr::select(Strain, GrowStage, nutrient, ancova.gis, add.gis) %>% 
                     dplyr::rename(ancova = ancova.gis, add = add.gis, Systematic = Strain))
                     %>% mutate(Library = "TOR1")) %>%
  drop_na(),YtoGene, by = "Systematic")

d <- godata('org.Sc.sgd.db', ont="BP", computeIC=FALSE)
model_summary <- data_frame()
go<-list()
go_ancova<-list()
go_add<-list()

for (n in c("RIM15","TOR1")){
  for(i in c("Pro","Qui")) {
    for (j in c("carbon", "nitrogen", "phosphate")){
      gse <- list()
      gseResults <- list()
      for (k in c("ancova","add")){
        tmp <- table %>% filter(GrowStage == i & nutrient == j & variable == k) 
        original_gene_list <- tmp$value
        names(original_gene_list) <- tmp$Common
        gene_list<-na.omit(original_gene_list)
        gene_list = sort(gene_list, decreasing = TRUE)
        gse[[k]] <- gseGO(geneList=gene_list, 
                        ont ="BP", 
                        keyType = "GENENAME", 
                        nPerm = 10000, 
                        minGSSize = 5, 
                        maxGSSize = 800, 
                        pvalueCutoff = 0.05, 
                        verbose = TRUE, 
                        OrgDb = organism, 
                        pAdjustMethod = "none")
      
        gseGOResults[[k]] <- gse[[k]]@result %>% 
          as_tibble() %>% 
          mutate(Variable=varz)
      
        dotplot(gse[[k]], showCategory=30)
        ggsave(paste0("./GI_quiescence/sum/reviewer/",j,"_",i,"_",k,".pdf"), width = 8, height = 7)
      }
      go_ancova[[paste0(j,"_",i,"_ancova")]] <- gseGOResults$ancova %>% dplyr::select(ID)
      go_add[[paste0(j,"_",i,"_add")]] <- gseGOResults$add %>% dplyr::select(ID)
      t <- c(n,i,j, mgoSim(c(as.matrix(go_ancova[[paste0(j,"_",i,"_",k)]])), c(as.matrix(go_add[[paste0(j,"_",i,"_",k)]])), semData=d, measure="Wang"))
      names(t) <- c("Library","Stage","nutrient","similarity")
      model_summary <- bind_rows(model_summary,t)
    }
  }
}

write_cvs(model_summary,"./GI_quiescence/sum/reviewer/TablesS18.csv")

#run pairwise mgoSim comparison for every elements in list 
mgoSim_table <- matrix(nrow = 12, ncol = 12)
go <- append(go_add, go_ancova)
#reorder the element in list
go <- go[c(1,7,2,8,3,9,4,10,5,11,6,12)]
rownames(mgoSim_table) <- names(go)
colnames(mgoSim_table) <- names(go)
for (n in c(1:12)){
  for (m in c(1:12)){
    mgoSim_table[n,m] <- mgoSim(c(as.matrix(go[[n]])), c(as.matrix(go[[m]])), semData=d, measure="Wang")
  }
}

# Print the correlation heatmap
ggcorrplot(mgoSim_table,  method = "square", hc.method = "complete",  
           hc.order = FALSE, outline.col = "white",
           colors = c("#5959F7", "white", "#FF0000"), type = "full") +
  ggtitle("Sematic similarity among GO terms")
ggsave("./GI_quiescence/sum/reviewer/Goterms_simi_GIS_models.pdf", width = 8, height = 8)

```

##Figure 3D & FigureS3C&D
####Summary of genetic interactions quantified by ANCOVA
```{r}
YtoGene <- read.table("./GI_quiescence/sum/data/YORFtoGENE_2018")
colnames(YtoGene) <- c("Strain","Gene")

GI_VST_all_wtNormed<-read_csv("./GI_quiescence/sum/tables/TableS13.csv")[,-1]

GI_VST_all_wtNormed <- left_join(GI_VST_all_wtNormed, YtoGene, by="Strain")

GI_VST_all_wtNormed$interaction <- ifelse(GI_VST_all_wtNormed$estimate > 0,"positive", "negative")
  
##there is something wrong with the summarize function, where keep giving NA values for mean, pho85, growing samples

GI_wtNormed_sig_pro <- GI_VST_all_wtNormed %>% 
  dplyr::filter(GrowStage == "Pro", q.value<0.05) %>%
  dplyr::select(-term)

GI_wtNormed_sig_qui <- GI_VST_all_wtNormed %>% 
  dplyr::filter(GrowStage == "Qui", q.value<0.05) %>%
  dplyr::select(-term)

#write significant interacting genes in separate table: positive and negative
write_csv(GI_wtNormed_sig_pro, "./GI_quiescence/sum/GIS analysis/GI_wtNormed_sig_pro.csv")
write_csv(GI_wtNormed_sig_qui, "./GI_quiescence/sum/GIS analysis/GI_wtNormed_sig_qui.csv")

#check whether the significant ones have small or big effects
GI_VST_all_wtNormed %>%
  dplyr::filter(q.value < 0.05) %>%
  ggplot(aes(x=estimate, color = GrowStage)) +
  geom_histogram(aes(y=..density..),  position="identity", alpha = 0.1)+
  geom_density(alpha = 0.1)+#, fill="#ffffff")+
  ylab("Density") +
  ggtitle("Distribution of significantly interacting genes with each kinase")+
  xlab("Genetic interaction score") +
  scale_fill_manual(values=c("#339966", "#cc3333")) +
  scale_color_manual(values=c( "#339966","#cc3333")) +
  facet_grid(interaction ~ LibraryName)
ggsave(paste0(path,"/gis_sigs.pdf"), width = 10, height = 6)

###
pos_qui <- GI_wtNormed_sig_qui %>% dplyr::filter(interaction == "positive")
neg_qui <- GI_wtNormed_sig_qui %>% dplyr::filter(interaction == "negative")

pos_pro <- GI_wtNormed_sig_pro %>% dplyr::filter(interaction == "positive")
neg_pro <- GI_wtNormed_sig_pro %>% dplyr::filter(interaction == "negative")

print(paste0("minimum positive interaction scores in quiescent cell is ", round(min(pos_qui$estimate),4)," & maximum negatvie interaction scores in quiescent cell is ", round(max(neg_qui$estimate), 4)))

print(paste0("minimum positive interaction scores in proliferative cell is ", round(min(pos_pro$estimate),4)," & maximum negatvie interaction scores in proliferative cell is ", round(max(neg_pro$estimate), 4)))

###
summary_GI_wtNormed <- GI_VST_all_wtNormed %>%
  dplyr::group_by(nutrient, GrowStage, LibraryName, interaction) %>%
  dplyr::summarize(significant = sum(q.value <= .05)) %>%
  dplyr::arrange(-significant) %>%
  dplyr::rename(query = LibraryName, stage = GrowStage)

summary_GI_wtNormed %>%
  dplyr::group_by(query, stage, interaction) %>%
  ggplot(aes(x=query, y=significant, fill = interaction)) +
  geom_bar(stat="identity", position=position_dodge()) +
  ylab("Number of interacting gene (p.adj < 0.05)") +
  ylim(0,800) + 
  scale_fill_manual(values=c("#3399FF", "#FFCC33")) +
  scale_color_manual(values=c( "#3399FF","#FFCC33")) +
  geom_text(aes(label=significant), vjust=0, color="black",
            position = position_dodge(0.9), size=3) +
  facet_grid(nutrient ~ stage) +
  theme_classic()
ggsave(paste0(path,"FigS3C.pdf"), width =6.5, height = 6)

#reshape the dataframe for accumulatvie caculation and plot
sig_GIs <- summary_GI_wtNormed %>% 
  unite(Stage, stage, interaction) %>%
  unite(variable, query, nutrient) %>%
  spread(key = variable, value = significant)
  
tmp <- melt(sig_GIs) %>%
  dplyr::group_by(Stage) %>%
  dplyr::mutate(Sig_GIs_stage = cumsum(value)) %>%
  separate(Stage, c("stage","interactionType"), sep = "_") %>%
  separate(variable, c("query","condition"), sep = "_", remove = F) %>%
  dplyr::group_by(query, stage, interactionType) %>%
  #cqs stands for condition, query, stage
  dplyr::mutate(Sig_GIs_cqs = cumsum(value)) 
  
#adjust the order of librarys in the plot
tmp$query <- factor(tmp$query, levels = c("TOR1","RIM15","PHO85"))

ggplot() +
  geom_bar(data = tmp, aes(condition, value, colour=interactionType, group = interactionType, fill = interactionType, width=.6),stat="identity") +
  geom_point(data = tmp, aes(condition, Sig_GIs_cqs, fill=interactionType, group = interactionType,shape=interactionType)) +
  geom_line(data = tmp, aes(condition, Sig_GIs_cqs, group = interactionType, linetype=interactionType)) +
  facet_grid(query~stage, scales = "free_y") +
  ylab("Significantly interacting gene number")+
 # theme(axis.text.x=element_text(angle=90),legend.position="top") +
  scale_fill_manual(values=c("#3399FF", "#FFCC33")) +
  scale_color_manual(values=c("#3399FF", "#FFCC33")) +
  theme_classic()
ggsave(paste0(path,"Fig3D.pdf"), width =7, height = 8)

ggplot() +
  geom_point(data = tmp, aes(variable, Sig_GIs_stage, col=interactionType, group = interactionType,shape=interactionType)) +
  geom_line(data = tmp, aes(variable, Sig_GIs_stage, col=interactionType, group = interactionType)) +
  facet_grid(stage~., scales = "free_y") +
  ylab("Significantly interacting gene number")+
  theme(axis.text.x=element_text(angle=90),legend.position="top") +
  scale_fill_manual(values=c("#3399FF", "#FFCC33")) +
  scale_color_manual(values=c("#3399FF", "#FFCC33")) +
  theme_classic()
ggsave(paste0(path,"FigS3D.pdf"), width =6, height = 6)
```

##Genetic interaction profiles similarity 
##Figure S4 added. reply to reviewer 1
####Comparison of genetic interaction profiles between our phenotype signature and Costanzo's fitness signature. 
```{r}
path = "./GI_quiescence/sum/plot/"
YtoGene <- read.table("./GI_quiescence/sum/data/YORFtoGENE_2018")
colnames(YtoGene) <- c("Strain","Gene")

GI_VST_all_wtNormed<-read_csv("./GI_quiescence/sum/tables/TableS13.csv")[,-1]
GI_VST_all_wtNormed_prolong <- read_csv("./GI_quiescence/sum/tables/TableS14.csv")[,-1]
GI_VST_all_wtNormed <- left_join(GI_VST_all_wtNormed, YtoGene, by="Strain")
GI_VST_all_wtNormed_prolong <- left_join(GI_VST_all_wtNormed_prolong, YtoGene, by="Strain")
#extract the data from carbon limited conditin in proliferation stage
carbon_pro <- GI_VST_all_wtNormed %>% 
  dplyr::filter(nutrient == "carbon" & GrowStage == "Pro") %>%
  dplyr::select(Strain, estimate, std.error, statistic, p.value, q.value, LibraryName, Gene) %>%
  dplyr::rename(GI = estimate)

#extract the data from carbon limited conditin in proliferation stage
carbon_qui <- GI_VST_all_wtNormed %>% 
  dplyr::filter(nutrient == "carbon" & GrowStage == "Qui") %>%
  dplyr::select(Strain, estimate, std.error, statistic, p.value, q.value, LibraryName, Gene) %>%
  dplyr::rename(GI = estimate)

#extract the data from nitrogen limited conditin in proliferation stage
nitrogen_pro <- GI_VST_all_wtNormed %>% 
  dplyr::filter(nutrient == "nitrogen" & GrowStage == "Pro") %>%
  dplyr::select(Strain, estimate, std.error, statistic, p.value, q.value, LibraryName, Gene) %>%
  dplyr::rename(GI = estimate)

#extract the data from nitrogen limited conditin in proliferation stage
nitrogen_qui <- GI_VST_all_wtNormed %>% 
  dplyr::filter(nutrient == "nitrogen" & GrowStage == "Qui") %>%
  dplyr::select(Strain, estimate, std.error, statistic, p.value, q.value, LibraryName, Gene) %>%
  dplyr::rename(GI = estimate)

#extract the data from phosphate limited conditin in proliferation stage
phosphate_pro <- GI_VST_all_wtNormed %>% 
  dplyr::filter(nutrient == "phosphate" & GrowStage == "Pro") %>%
  dplyr::select(Strain, estimate, std.error, statistic, p.value, q.value, LibraryName, Gene) %>%
  dplyr::rename(GI = estimate)

#extract the data from nitrogen limited conditin in proliferation stage
phosphate_qui <- GI_VST_all_wtNormed %>% 
  dplyr::filter(nutrient == "phosphate" & GrowStage == "Qui") %>%
  dplyr::select(Strain, estimate, std.error, statistic, p.value, q.value, LibraryName, Gene) %>%
  dplyr::rename(GI = estimate)

#read in Costanzo's data of tor1, rim15 and pho85
Costanzo_rim15<-read_csv("./GI_quiescence/sum/data/rim15_costanzo2016.csv")
Costanzo_tor1<-read_csv("./GI_quiescence/sum/data/tor1_costanzo2016.csv")
Costanzo_pho85<-read_csv("./GI_quiescence/sum/data/pho85_costanzo2016.csv")

Costanzo_rim15 <- Costanzo_rim15 %>% 
  separate(`Array Strain ID`, c("Strain","ID"), sep = "_") %>%
  dplyr::select(`Query allele name`, Strain, `Array allele name`,`Genetic interaction score (_)`,`P-value`,`Query single mutant fitness (SMF)`,`Array SMF`,`Double mutant fitness`,`Double mutant fitness standard deviation`)

Costanzo_tor1 <- Costanzo_tor1 %>% 
  separate(`Array Strain ID`, c("Strain","ID"), sep = "_") %>%
  dplyr::select(`Query allele name`, Strain, `Array allele name`,`Genetic interaction score (_)`,`P-value`,`Query single mutant fitness (SMF)`,`Array SMF`,`Double mutant fitness`,`Double mutant fitness standard deviation`)

Costanzo_pho85 <- Costanzo_pho85 %>% 
  separate(`Array Strain ID`, c("Strain","ID"), sep = "_") %>%
  dplyr::select(`Query allele name`, Strain, `Array allele name`,`Genetic interaction score (_)`,`P-value`,`Query single mutant fitness (SMF)`,`Array SMF`,`Double mutant fitness`,`Double mutant fitness standard deviation`)

Costanzo <- bind_rows(Costanzo_rim15, Costanzo_tor1, Costanzo_pho85) %>%
  dplyr::rename(LibraryName = `Query allele name`, Gene = `Array allele name`, p_val = `P-value`) %>%
  mutate_each(funs(toupper), LibraryName, Gene)

Sun_Costanzo_c <- inner_join(inner_join(carbon_pro, carbon_qui, by = c("Strain","LibraryName","Gene"), suffix = c("_pro","_qui")), Costanzo, by = c("Strain","LibraryName","Gene")) %>%
  dplyr::rename(GIS_costanzo = `Genetic interaction score (_)`)

Sun_Costanzo_n <- inner_join(inner_join(nitrogen_pro, nitrogen_qui, by = c("Strain","LibraryName","Gene"), suffix = c("_pro","_qui")), Costanzo, by = c("Strain","LibraryName","Gene")) %>%
  dplyr::rename(GIS_costanzo = `Genetic interaction score (_)`)

Sun_Costanzo_p <- inner_join(inner_join(phosphate_pro, phosphate_qui, by = c("Strain","LibraryName","Gene"), suffix = c("_pro","_qui")), Costanzo, by = c("Strain","LibraryName","Gene")) %>%
  dplyr::rename(GIS_costanzo = `Genetic interaction score (_)`)

Sun_sig_c <- Sun_Costanzo_c %>% filter(abs(GIS_costanzo)>0.08&p_val<0.05)

ggscatter(Sun_Costanzo_c, x = "GI_pro", y = "GIS_costanzo", size=1, alpha = 0.3,  cor.coef.size = 0.3, col="#f9bd5d") +
    xlab("GI_pro - Sun et al (carbon)") +
    ylab("GI - Costanzo et al") +
    xlim(-0.5,0.5) +
    ylim(-0.5,0.5) +
    geom_point(data=Sun_Costanzo_c %>% filter(abs(GIS_costanzo) > 0.08 & p_val < 0.05), aes(x=GI_pro,y=GIS_costanzo), color='#FF3333',size=1, alpha = 0.7) +
    geom_point(data=Sun_Costanzo_c %>% filter(q.value_pro < 0.05), aes(x=GI_pro,y=GIS_costanzo), color='#3399FF',size=1, alpha = 0.7) +
    geom_point(data=Sun_Costanzo_c %>% filter(q.value_pro < 0.05 & abs(GIS_costanzo) > 0.08 & p_val < 0.05) %>% filter(GI_pro < 0 & GIS_costanzo < 0 | GI_pro > 0 & GIS_costanzo > 0), aes(x=GI_pro,y=GIS_costanzo), color='black',size=1.5) +
  geom_point(data=Sun_Costanzo_c %>% filter(q.value_pro < 0.05 & abs(GIS_costanzo) > 0.08 & p_val < 0.05) %>% filter(GI_pro < 0 & GIS_costanzo > 0 | GI_pro > 0 & GIS_costanzo < 0), aes(x=GI_pro,y=GIS_costanzo), color='black',size=1.5, shape = 4) +
    stat_cor(method = "pearson", label.x.npc = "left", label.y.npc = "top", size=5, col = "#f9bd5d") +
  facet_grid(~LibraryName) +
    theme(axis.text=element_text(size=12), axis.text.x=element_text(angle=0),
          axis.title=element_text(size=12,face="bold")) +
  theme_classic()
ggsave(paste0(path,"FigS4-1.pdf"), width = 12, height = 3.5, useDingbats=FALSE)

ggscatter(Sun_Costanzo_c, x = "GI_qui", y = "GIS_costanzo", size=1, alpha = 0.3,  cor.coef.size = 0.3, col="#f9bd5d") +
    xlab("GI_qui - Sun et al (carbon)") +
    ylab("GI - Costanzo et al") +
    #geom_smooth(method = "loess", se = FALSE, col = "#F76F87") +
    xlim(-0.5,0.5) +
    ylim(-0.5,0.5) +
    geom_point(data=Sun_Costanzo_c %>% filter(abs(GIS_costanzo) > 0.08 & p_val < 0.05), aes(x=GI_qui,y=GIS_costanzo), color='#FF3333',size=1, alpha = 0.7) +
    geom_point(data=Sun_Costanzo_c %>% filter(q.value_qui < 0.05), aes(x=GI_qui,y=GIS_costanzo), color='#3399FF',size=1, alpha = 0.7) +
    geom_point(data=Sun_Costanzo_c %>% filter(q.value_qui < 0.05 & abs(GIS_costanzo) > 0.08 & p_val < 0.05) %>% filter(GI_qui < 0 & GIS_costanzo < 0 | GI_qui > 0 & GIS_costanzo > 0), aes(x=GI_qui,y=GIS_costanzo), color='black',size=1.5) +
  geom_point(data=Sun_Costanzo_c %>% filter(q.value_qui < 0.05 & abs(GIS_costanzo) > 0.08 & p_val < 0.05) %>% filter(GI_qui < 0 & GIS_costanzo > 0 | GI_qui > 0 & GIS_costanzo < 0), aes(x=GI_qui,y=GIS_costanzo), color='black',size=1.5, shape = 4) +
    stat_cor(method = "spearman", label.x.npc = "left", label.y.npc = "top", size=5, col = "#f9bd5d") +
  facet_grid(~LibraryName) +
    theme(axis.text=element_text(size=12), axis.text.x=element_text(angle=0),
          axis.title=element_text(size=12,face="bold")) +
  theme_classic()
ggsave(paste0(path,"FigS4-2.pdf"), width = 12, height = 3.5, useDingbats=FALSE)

ggscatter(Sun_Costanzo_n, x = "GI_pro", y = "GIS_costanzo", size=1, alpha = 0.3,  cor.coef.size = 0.3, col="#7ace0d") +
    xlab("GI_pro - Sun et al (nitrogen)") +
    ylab("GI - Costanzo et al") +
    xlim(-0.5,0.5) +
    ylim(-0.5,0.5) +
    geom_point(data=Sun_Costanzo_n %>% filter(abs(GIS_costanzo) > 0.08 & p_val < 0.05), aes(x=GI_pro,y=GIS_costanzo), color='#FF3333',size=1, alpha = 0.7) +
    geom_point(data=Sun_Costanzo_n %>% filter(q.value_pro < 0.05), aes(x=GI_pro,y=GIS_costanzo), color='#3399FF',size=1, alpha = 0.7) +
    geom_point(data=Sun_Costanzo_n %>% filter(q.value_pro < 0.05 & abs(GIS_costanzo) > 0.08 & p_val < 0.05) %>% filter(GI_pro < 0 & GIS_costanzo < 0 | GI_pro > 0 & GIS_costanzo > 0), aes(x=GI_pro,y=GIS_costanzo), color='black',size=1.5) +
  geom_point(data=Sun_Costanzo_n %>% filter(q.value_pro < 0.05 & abs(GIS_costanzo) > 0.08 & p_val < 0.05) %>% filter(GI_pro < 0 & GIS_costanzo > 0 | GI_pro > 0 & GIS_costanzo < 0), aes(x=GI_pro,y=GIS_costanzo), color='black',size=1.5, shape = 4) +
    stat_cor(method = "pearson", label.x.npc = "left", label.y.npc = "top", size=5, col = "#7ace0d") +
  facet_grid(~LibraryName) +
    theme(axis.text=element_text(size=12), axis.text.x=element_text(angle=0),
          axis.title=element_text(size=12,face="bold")) +
  theme_classic()
ggsave(paste0(path,"FigS4-3.pdf"), width = 12, height = 3.5, useDingbats=FALSE)

ggscatter(Sun_Costanzo_n, x = "GI_qui", y = "GIS_costanzo", size=1, alpha = 0.3,  cor.coef.size = 0.3, col="#7ace0d") +
    xlab("GI_qui - Sun et al (nitrogen)") +
    ylab("GI - Costanzo et al") +
    #geom_smooth(method = "loess", se = FALSE, col = "#F76F87") +
    xlim(-0.5,0.5) +
    ylim(-0.5,0.5) +
    geom_point(data=Sun_Costanzo_n %>% filter(abs(GIS_costanzo) > 0.08 & p_val < 0.05), aes(x=GI_qui,y=GIS_costanzo), color='#FF3333',size=1, alpha = 0.7) +
    geom_point(data=Sun_Costanzo_n %>% filter(q.value_qui < 0.05), aes(x=GI_qui,y=GIS_costanzo), color='#3399FF',size=1, alpha = 0.7) +
    geom_point(data=Sun_Costanzo_n %>% filter(q.value_qui < 0.05 & abs(GIS_costanzo) > 0.08 & p_val < 0.05) %>% filter(GI_qui < 0 & GIS_costanzo < 0 | GI_qui > 0 & GIS_costanzo > 0), aes(x=GI_qui,y=GIS_costanzo), color='black',size=1.5) +
  geom_point(data=Sun_Costanzo_n %>% filter(q.value_qui < 0.05 & abs(GIS_costanzo) > 0.08 & p_val < 0.05) %>% filter(GI_qui < 0 & GIS_costanzo > 0 | GI_qui > 0 & GIS_costanzo < 0), aes(x=GI_qui,y=GIS_costanzo), color='black',size=1.5, shape = 4) +
    stat_cor(method = "spearman", label.x.npc = "left", label.y.npc = "top", size=5, col = "#7ace0d") +
  facet_grid(~LibraryName) +
    theme(axis.text=element_text(size=12), axis.text.x=element_text(angle=0),
          axis.title=element_text(size=12,face="bold")) +
  theme_classic()
ggsave(paste0(path,"FigS4-4.pdf"), width = 12, height = 3.5, useDingbats=FALSE)

ggscatter(Sun_Costanzo_p, x = "GI_pro", y = "GIS_costanzo", size=1, alpha = 0.3,  cor.coef.size = 0.3, col="#a564f9") +
    xlab("GI_pro - Sun et al (phosphorous)") +
    ylab("GI - Costanzo et al") +
    #geom_smooth(method = "loess", se = FALSE, col = "#F76F87") +
    xlim(-0.5,0.5) +
    ylim(-0.5,0.5) +
    geom_point(data=Sun_Costanzo_p %>% filter(abs(GIS_costanzo) > 0.08 & p_val < 0.05), aes(x=GI_pro,y=GIS_costanzo), color='#FF3333',size=1, alpha = 0.7) +
    geom_point(data=Sun_Costanzo_p %>% filter(q.value_pro < 0.05), aes(x=GI_pro,y=GIS_costanzo), color='#3399FF',size=1, alpha = 0.7) +
    geom_point(data=Sun_Costanzo_p %>% filter(q.value_pro < 0.05 & abs(GIS_costanzo) > 0.08 & p_val < 0.05) %>% filter(GI_pro < 0 & GIS_costanzo < 0 | GI_pro > 0 & GIS_costanzo > 0), aes(x=GI_pro,y=GIS_costanzo), color='black',size=1.5) +
  geom_point(data=Sun_Costanzo_p %>% filter(q.value_pro < 0.05 & abs(GIS_costanzo) > 0.08 & p_val < 0.05) %>% filter(GI_pro < 0 & GIS_costanzo > 0 | GI_pro > 0 & GIS_costanzo < 0), aes(x=GI_pro,y=GIS_costanzo), color='black',size=1.5, shape = 4) +
    stat_cor(method = "pearson", label.x.npc = "left", label.y.npc = "top", size=5, col = "#a564f9") +
  facet_grid(~LibraryName) +
 # geom_text_repel(aes(label = Gene), size = 3.5) +
    theme(axis.text=element_text(size=12), axis.text.x=element_text(angle=0),
          axis.title=element_text(size=12,face="bold")) +
  theme_classic()
ggsave(paste0(path,"FigS4-5.pdf"), width = 12, height = 3.5, useDingbats=FALSE)

ggscatter(Sun_Costanzo_p, x = "GI_qui", y = "GIS_costanzo", size=1, alpha = 0.3,  cor.coef.size = 0.3, col="#a564f9") +
    xlab("GI_qui - Sun et al (phosphorous)") +
    ylab("GI - Costanzo et al") +
    xlim(-0.5,0.5) +
    ylim(-0.5,0.5) +
    geom_point(data=Sun_Costanzo_p %>% filter(abs(GIS_costanzo) > 0.08 & p_val < 0.05), aes(x=GI_qui,y=GIS_costanzo), color='#FF3333',size=1, alpha = 0.7) +
    geom_point(data=Sun_Costanzo_p %>% filter(q.value_qui < 0.05), aes(x=GI_qui,y=GIS_costanzo), color='#3399FF',size=1, alpha = 0.7) +
    geom_point(data=Sun_Costanzo_p %>% filter(q.value_qui < 0.05 & abs(GIS_costanzo) > 0.08 & p_val < 0.05) %>% filter(GI_qui < 0 & GIS_costanzo < 0 | GI_qui > 0 & GIS_costanzo > 0), aes(x=GI_qui,y=GIS_costanzo), color='black',size=1.5) +
  geom_point(data=Sun_Costanzo_p %>% filter(q.value_qui < 0.05 & abs(GIS_costanzo) > 0.08 & p_val < 0.05) %>% filter(GI_qui < 0 & GIS_costanzo > 0 | GI_qui > 0 & GIS_costanzo < 0), aes(x=GI_qui,y=GIS_costanzo), color='black',size=1.5, shape = 4) +
    stat_cor(method = "spearman", label.x.npc = "left", label.y.npc = "top", size=4, col = "#a564f9") +
  facet_grid(~LibraryName) +
    theme(axis.text=element_text(size=12), axis.text.x=element_text(angle=0),
          axis.title=element_text(size=12,face="bold"), legend.position = "right") +
  theme_classic()
ggsave(paste0(path,"FigS4-6.pdf"), width = 12, height = 3.5, useDingbats=FALSE)

#look at the fitness estimation for double mutant in our study VS Costanzo's
# read in our data
RIM15_sun<-read_csv("./GI_quiescence/sum/tables/TableS15.csv")
TOR1_sun<-read_csv("./GI_quiescence/sum/tables/TableS16.csv")
PHO85_sun<-read_csv("./GI_quiescence/sum/tables/TableS17.csv")

RIM15_sun_fitness<-RIM15_sun %>% dplyr::select(nutrient, Strain, GrowStage, estimate.double, q.value.double, Common) %>% mutate(LibraryName = "RIM15") %>% dplyr::rename(Gene = Common)

TOR1_sun_fitness<-TOR1_sun %>% dplyr::select(nutrient, Strain, GrowStage, estimate.double, q.value.double, Common) %>% mutate(LibraryName = "TOR1") %>% dplyr::rename(Gene = Common)

PHO85_sun_fitness<-PHO85_sun %>% dplyr::select(nutrient, Strain, GrowStage, estimate.double, q.value.double, Gene) %>% mutate(LibraryName = "PHO85")

Sun_fitness <- bind_rows(RIM15_sun_fitness,TOR1_sun_fitness,PHO85_sun_fitness)

Sun_fitness_c <- inner_join(inner_join(Sun_fitness %>% filter(GrowStage == "Pro" & nutrient == "carbon"), Sun_fitness %>% filter(GrowStage == "Qui" & nutrient == "carbon"), by = c("Strain","LibraryName","Gene"), suffix = c("_pro","_qui")), Costanzo, by = c("Strain","LibraryName","Gene")) %>%
  dplyr::rename(fitness_Costanzo = `Double mutant fitness`)

Sun_fitness_n <- inner_join(inner_join(Sun_fitness %>% filter(GrowStage == "Pro" & nutrient == "nitrogen"), Sun_fitness %>% filter(GrowStage == "Qui" & nutrient == "nitrogen"), by = c("Strain","LibraryName","Gene"), suffix = c("_pro","_qui")), Costanzo, by = c("Strain","LibraryName","Gene")) %>%
  dplyr::rename(fitness_Costanzo = `Double mutant fitness`)

Sun_fitness_p <- inner_join(inner_join(Sun_fitness %>% filter(GrowStage == "Pro" & nutrient == "phosphate"), Sun_fitness %>% filter(GrowStage == "Qui" & nutrient == "phosphate"), by = c("Strain","LibraryName","Gene"), suffix = c("_pro","_qui")), Costanzo, by = c("Strain","LibraryName","Gene")) %>%
  dplyr::rename(fitness_Costanzo = `Double mutant fitness`)
```

#making comparison plots for FigureEV5
```{r}
##carbon restriction
pdf("./GI_quiescence/sum/plot/FigureEV5.pdf",width=12, height=17)
# carbon proliferation
pmain <- ggscatter(Sun_fitness_c, x = "estimate.double_pro", y = "fitness_Costanzo", alpha = 0.5, size=1, cor.coef.size = 1, col= "LibraryName")+
  stat_cor(aes(col = LibraryName), method = "spearman", label.x.npc = "left", label.y.npc = "bottom", size = 3) +
  xlab("Double mutant fitness_pro - Sun et al (carbon)") +
  ylab("Double mutant fitness - Costanzo et al") +
  coord_fixed(ratio = 0.7)+
  theme(axis.text=element_text(size=15), axis.title=element_text(size=15,face="bold"))+
  scale_color_manual(values=c("#8da0cb", "#e78ac3", "#66c2a5"))+
  scale_fill_manual(values=c("#8da0cb", "#e78ac3", "#66c2a5"))

# Marginal densities along x axis
xdens <- axis_canvas(pmain, axis = "x")+
  geom_density(data = Sun_fitness_c, aes(x = estimate.double_pro, fill = LibraryName),
              alpha = 0.7, size = 0.2)+
  scale_color_manual(values=c("#8da0cb", "#e78ac3", "#66c2a5"))+
  scale_fill_manual(values=c("#8da0cb", "#e78ac3", "#66c2a5"))

# Marginal densities along y axis
# Need to set coord_flip = TRUE, if you plan to use coord_flip()
ydens <- axis_canvas(pmain, axis = "y", coord_flip = TRUE)+
  geom_density(data = Sun_fitness_c, aes(x = fitness_Costanzo, fill = LibraryName),
                alpha = 0.7, size = 0.2)+
  coord_flip()+
  scale_color_manual(values=c("#8da0cb", "#e78ac3", "#66c2a5"))+
  scale_fill_manual(values=c("#8da0cb", "#e78ac3", "#66c2a5"))

p1 <- insert_xaxis_grob(pmain, xdens, grid::unit(.2, "null"), position = "top")
p2<- insert_yaxis_grob(p1, ydens, grid::unit(.2, "null"), position = "right")

#carbon quiescence
pmain <- ggscatter(Sun_fitness_c, x = "estimate.double_qui", y = "fitness_Costanzo", alpha = 0.5, size=1, cor.coef.size = 1, col= "LibraryName")+
  stat_cor(aes(col = LibraryName), method = "spearman", label.x.npc = "left", label.y.npc = "bottom", size = 3) +
  xlab("Double mutant fitness_qui - Sun et al (carbon)") +
  ylab("Double mutant fitness - Costanzo et al") +
  coord_fixed(ratio = 0.7)+
  theme(axis.text=element_text(size=15), axis.title=element_text(size=15,face="bold"),legend.position="none")+
  scale_color_manual(values=c("#8da0cb", "#e78ac3", "#66c2a5"))+
  scale_fill_manual(values=c("#8da0cb", "#e78ac3", "#66c2a5"))

# Marginal densities along x axis
xdens <- axis_canvas(pmain, axis = "x")+
  geom_density(data = Sun_fitness_c, aes(x = estimate.double_qui, fill = LibraryName),
              alpha = 0.7, size = 0.2)+
  scale_color_manual(values=c("#8da0cb", "#e78ac3", "#66c2a5"))+
  scale_fill_manual(values=c("#8da0cb", "#e78ac3", "#66c2a5"))

# Marginal densities along y axis
# Need to set coord_flip = TRUE, if you plan to use coord_flip()
ydens <- axis_canvas(pmain, axis = "y", coord_flip = TRUE)+
  geom_density(data = Sun_fitness_c, aes(x = fitness_Costanzo, fill = LibraryName),
                alpha = 0.7, size = 0.2)+
  coord_flip()+
  scale_color_manual(values=c("#8da0cb", "#e78ac3", "#66c2a5"))+
  scale_fill_manual(values=c("#8da0cb", "#e78ac3", "#66c2a5"))

p3 <- insert_xaxis_grob(pmain, xdens, grid::unit(.2, "null"), position = "top")
p4<- insert_yaxis_grob(p3, ydens, grid::unit(.2, "null"), position = "right")

#nitrogen proliferation
# Main plot
pmain <- ggscatter(Sun_fitness_n, x = "estimate.double_pro", y = "fitness_Costanzo", alpha = 0.5, size=1, cor.coef.size = 1, col= "LibraryName")+
  stat_cor(aes(col = LibraryName), method = "spearman", label.x.npc = "left", label.y.npc = "bottom", size = 3) +
  xlab("Double mutant fitness_pro - Sun et al (nitrogen)") +
  ylab("Double mutant fitness - Costanzo et al") +
  coord_fixed(ratio = 0.7)+
  theme(axis.text=element_text(size=15), axis.title=element_text(size=15,face="bold"),legend.position="none")+
  scale_color_manual(values=c("#8da0cb", "#e78ac3", "#66c2a5"))+
  scale_fill_manual(values=c("#8da0cb", "#e78ac3", "#66c2a5"))

# Marginal densities along x axis
xdens <- axis_canvas(pmain, axis = "x")+
  geom_density(data = Sun_fitness_n, aes(x = estimate.double_pro, fill = LibraryName),
              alpha = 0.7, size = 0.2)+
  scale_color_manual(values=c("#8da0cb", "#e78ac3", "#66c2a5"))+
  scale_fill_manual(values=c("#8da0cb", "#e78ac3", "#66c2a5"))

# Marginal densities along y axis
# Need to set coord_flip = TRUE, if you plan to use coord_flip()
ydens <- axis_canvas(pmain, axis = "y", coord_flip = TRUE)+
  geom_density(data = Sun_fitness_n, aes(x = fitness_Costanzo, fill = LibraryName),
                alpha = 0.7, size = 0.2)+
  coord_flip()+
  scale_color_manual(values=c("#8da0cb", "#e78ac3", "#66c2a5"))+
  scale_fill_manual(values=c("#8da0cb", "#e78ac3", "#66c2a5"))

p5 <- insert_xaxis_grob(pmain, xdens, grid::unit(.2, "null"), position = "top")
p6<- insert_yaxis_grob(p5, ydens, grid::unit(.2, "null"), position = "right")

# Main plot
pmain <- ggscatter(Sun_fitness_n, x = "estimate.double_qui", y = "fitness_Costanzo", alpha = 0.5, size=1, cor.coef.size = 1, col= "LibraryName")+
  stat_cor(aes(col = LibraryName), method = "spearman", label.x.npc = "left", label.y.npc = "bottom", size = 3) +
  xlab("Double mutant fitness_qui - Sun et al (nitrogen)") +
  ylab("Double mutant fitness - Costanzo et al") +
  coord_fixed(ratio = 0.7)+
  theme(axis.text=element_text(size=15), axis.title=element_text(size=15,face="bold"),legend.position="none")+
  scale_color_manual(values=c("#8da0cb", "#e78ac3", "#66c2a5"))+
  scale_fill_manual(values=c("#8da0cb", "#e78ac3", "#66c2a5"))

# Marginal densities along x axis
xdens <- axis_canvas(pmain, axis = "x")+
  geom_density(data = Sun_fitness_n, aes(x = estimate.double_qui, fill = LibraryName),
              alpha = 0.7, size = 0.2)+
  scale_color_manual(values=c("#8da0cb", "#e78ac3", "#66c2a5"))+
  scale_fill_manual(values=c("#8da0cb", "#e78ac3", "#66c2a5"))

# Marginal densities along y axis
# Need to set coord_flip = TRUE, if you plan to use coord_flip()
ydens <- axis_canvas(pmain, axis = "y", coord_flip = TRUE)+
  geom_density(data = Sun_fitness_n, aes(x = fitness_Costanzo, fill = LibraryName),
                alpha = 0.7, size = 0.2)+
  coord_flip()+
  scale_color_manual(values=c("#8da0cb", "#e78ac3", "#66c2a5"))+
  scale_fill_manual(values=c("#8da0cb", "#e78ac3", "#66c2a5"))

p7 <- insert_xaxis_grob(pmain, xdens, grid::unit(.2, "null"), position = "top")
p8<- insert_yaxis_grob(p7, ydens, grid::unit(.2, "null"), position = "right")

#phosphorus proliferation
# Main plot
pmain <- ggscatter(Sun_fitness_p, x = "estimate.double_pro", y = "fitness_Costanzo", alpha = 0.5, size=1, cor.coef.size = 1, col= "LibraryName")+
  stat_cor(aes(col = LibraryName), method = "spearman", label.x.npc = "left", label.y.npc = "bottom", size = 3) +
  xlab("Double mutant fitness_pro - Sun et al (phosphate)") +
  ylab("Double mutant fitness - Costanzo et al") +
  coord_fixed(ratio = 0.7)+
  theme(axis.text=element_text(size=15), axis.title=element_text(size=15,face="bold"),legend.position="none")+
  scale_color_manual(values=c("#8da0cb", "#e78ac3", "#66c2a5"))+
  scale_fill_manual(values=c("#8da0cb", "#e78ac3", "#66c2a5"))

# Marginal densities along x axis
xdens <- axis_canvas(pmain, axis = "x")+
  geom_density(data = Sun_fitness_p, aes(x = estimate.double_pro, fill = LibraryName),
              alpha = 0.7, size = 0.2)+
  scale_color_manual(values=c("#8da0cb", "#e78ac3", "#66c2a5"))+
  scale_fill_manual(values=c("#8da0cb", "#e78ac3", "#66c2a5"))

# Marginal densities along y axis
# Need to set coord_flip = TRUE, if you plan to use coord_flip()
ydens <- axis_canvas(pmain, axis = "y", coord_flip = TRUE)+
  geom_density(data = Sun_fitness_p, aes(x = fitness_Costanzo, fill = LibraryName),
                alpha = 0.7, size = 0.2)+
  coord_flip()+
  scale_color_manual(values=c("#8da0cb", "#e78ac3", "#66c2a5"))+
  scale_fill_manual(values=c("#8da0cb", "#e78ac3", "#66c2a5"))

p9 <- insert_xaxis_grob(pmain, xdens, grid::unit(.2, "null"), position = "top")
p10<- insert_yaxis_grob(p9, ydens, grid::unit(.2, "null"), position = "right")

#phosphorus quiescence
# Main plot
pmain <- ggscatter(Sun_fitness_p, x = "estimate.double_qui", y = "fitness_Costanzo", alpha = 0.5, size=1, cor.coef.size = 1, col= "LibraryName")+
  stat_cor(aes(col = LibraryName), method = "spearman", label.x.npc = "left", label.y.npc = "bottom", size = 3) +
  xlab("Double mutant fitness_qui - Sun et al (phosphate)") +
  ylab("Double mutant fitness - Costanzo et al") +
  coord_fixed(ratio = 0.7)+
  theme(axis.text=element_text(size=15), axis.title=element_text(size=15,face="bold"),legend.position="none")+
  scale_color_manual(values=c("#8da0cb", "#e78ac3", "#66c2a5"))+
  scale_fill_manual(values=c("#8da0cb", "#e78ac3", "#66c2a5"))

# Marginal densities along x axis
xdens <- axis_canvas(pmain, axis = "x")+
  geom_density(data = Sun_fitness_p, aes(x = estimate.double_qui, fill = LibraryName),
              alpha = 0.7, size = 0.2)+
  scale_color_manual(values=c("#8da0cb", "#e78ac3", "#66c2a5"))+
  scale_fill_manual(values=c("#8da0cb", "#e78ac3", "#66c2a5"))

# Marginal densities along y axis
# Need to set coord_flip = TRUE, if you plan to use coord_flip()
ydens <- axis_canvas(pmain, axis = "y", coord_flip = TRUE)+
  geom_density(data = Sun_fitness_p, aes(x = fitness_Costanzo, fill = LibraryName),
                alpha = 0.7, size = 0.2)+
  coord_flip()+
  scale_color_manual(values=c("#8da0cb", "#e78ac3", "#66c2a5"))+
  scale_fill_manual(values=c("#8da0cb", "#e78ac3", "#66c2a5"))

p11 <- insert_xaxis_grob(pmain, xdens, grid::unit(.2, "null"), position = "top")
p12<- insert_yaxis_grob(p11, ydens, grid::unit(.2, "null"), position = "right")

grid.arrange(p2,p4,p6,p8,p10,p12, ncol =2)

dev.off()
```

###Appendix_Figure 4
```{r}
GI_VST_all_wtNormed<-read_csv("./GI_quiescence/sum/tables/TableS13.csv")[,-1]

GI_VST_all_wtNormed <- left_join(GI_VST_all_wtNormed, YtoGene, by="Strain")

GI_VST_all_wtNormed %>% 
  filter(q.value < 0.05) %>%
  ggplot(aes(x=estimate, col= GrowStage, fill=GrowStage))+
  theme_bw(base_size=6)+
  ggtitle("Distribution of GIs (q.value < 0.05)")+
  theme(axis.text.x=element_text(angle=90, size=6), panel.grid.major = element_blank())+
  geom_histogram(aes(y=..density..),  position="identity", alpha=0.1)+
  geom_density(alpha = 0.3)+#, fill="#ffffff")+
  scale_color_manual(values=c("#1cce63", "#f95757"))+
  scale_fill_manual(values=c("#1cce63", "#f95757"))+
  labs(title="significant GIs",x="genetic interaction score", y = "Density")+
  theme_classic()+
  facet_grid(LibraryName~nutrient)

GI_VST_all_wtNormed %>% 
  ggplot(aes(x=estimate, col= GrowStage, fill=GrowStage))+
  theme_bw(base_size=6)+
    ggtitle("Distribution of GIs")+
  theme(axis.text.x=element_text(angle=90, size=6), panel.grid.major = element_blank())+
  geom_histogram(aes(y=..density..),  position="identity", alpha=0.1)+
  geom_density(alpha = 0.3)+#, fill="#ffffff")+
  scale_color_manual(values=c("#1cce63", "#f95757"))+
  scale_fill_manual(values=c("#1cce63", "#f95757"))+
  labs(title="significant GIs",x="genetic interaction score", y = "Density")+
  theme_classic()+
  facet_grid(LibraryName~nutrient)
#differential interactios between different cellular states
GI_pro <- GI_VST_all_wtNormed %>%
  dplyr::select(-term) %>%
  dplyr::filter(GrowStage == "Pro") %>%
  dplyr::select(-GrowStage)

GI_qui <- GI_VST_all_wtNormed %>%
  dplyr::select(-term) %>%
  dplyr::filter(GrowStage == "Qui") %>%
  dplyr::select(-GrowStage)

#combine the two tables horizontally, so that we will be able to compare the differential interaction
GI_stages<-left_join(GI_pro, GI_qui, by = c("nutrient", "Strain", "LibraryName", "Gene"),suffix= c(".pro",".qui")) %>%
  mutate(Diff.GI = estimate.qui - estimate.pro)

GI_stages$interaction <- ifelse(GI_stages$Diff.GI > 0,"differential positive", "differential negative")

#GI distribution in proliferation
GI_stages %>% 
  ggplot(aes(x=estimate.pro, col= LibraryName, fill=LibraryName))+
  theme_bw(base_size=6)+
  theme(axis.text.x=element_text(angle=90, size=6), panel.grid.major = element_blank())+
  geom_histogram(aes(y=..density..),  position="identity", alpha=0.1)+
  geom_density(alpha = 0.3)+#, fill="#ffffff")+
  scale_color_manual(values=c("#8DA0CB", "#E78AC3" ,"#66C2A5"))+
  scale_fill_manual(values=c("#8DA0CB", "#E78AC3", "#66C2A5"))+
  labs(title="GIS in proliferation",x="Differential interaction", y = "Density")+
  theme_classic()+
  facet_grid(LibraryName~nutrient)

#GI distribution in quiescence
GI_stages %>% 
  ggplot(aes(x=estimate.qui, col= LibraryName, fill=LibraryName))+
  theme_bw(base_size=6)+
  theme(axis.text.x=element_text(angle=90, size=6), panel.grid.major = element_blank())+
  geom_histogram(aes(y=..density..),  position="identity", alpha=0.1)+
  geom_density(alpha = 0.3)+#, fill="#ffffff")+
  scale_color_manual(values=c("#8DA0CB", "#E78AC3" ,"#66C2A5"))+
  scale_fill_manual(values=c("#8DA0CB", "#E78AC3", "#66C2A5"))+
  labs(title="GIS in quiescence",x="Differential interaction", y = "Density")+
  theme_classic()+
  facet_grid(LibraryName~nutrient)

#differential interactions between quiescent statge and proliferation distribution 
GI_stages %>% 
  ggplot(aes(x=Diff.GI, col= LibraryName, fill=LibraryName))+
  theme_bw(base_size=6)+
  #geom_vline(data=mu, aes(xintercept=mean, color=sampleNum), linetype="dashed")+
  theme(axis.text.x=element_text(angle=90, size=6), panel.grid.major = element_blank())+
  geom_histogram(aes(y=..density..),  position="identity", alpha=0.1)+
  geom_density(alpha = 0.3)+#, fill="#ffffff")+
  scale_color_manual(values=c("#8DA0CB", "#E78AC3" ,"#66C2A5"))+
  scale_fill_manual(values=c("#8DA0CB", "#E78AC3", "#66C2A5"))+
  labs(title="Differential interaction",x="Differential interaction", y = "Density")+
  theme_classic()+
  facet_grid(LibraryName~nutrient)
```

###FigureS4A & S4B & S4C
```{r}
#read in the table
GI_VST_all_wtNormed<-read_csv("./sum/tables/TableS13.csv")[,-1]

#GI_VST_all <- left_join(GI_VST_all_wtNormed, YtoGene, by ="Strain")

#reshape the dataframe for making correlation matrix
GI_reshape <- GI_VST_all_wtNormed %>% 
  unite(cond, nutrient, GrowStage, LibraryName) %>%
  dplyr::select(cond, Strain, estimate) %>%
  spread(cond, estimate)
  
GI_reshape_pro <- GI_VST_all_wtNormed %>% 
  filter(GrowStage == "Pro") %>%
  unite(cond, nutrient, GrowStage, LibraryName) %>%
  dplyr::select(cond, Strain, estimate) %>%
  spread(cond, estimate)

GI_reshape_qui <- GI_VST_all_wtNormed %>% 
  filter(GrowStage == "Qui") %>%
  unite(cond, nutrient, GrowStage, LibraryName) %>%
  dplyr::select(cond, Strain, estimate) %>%
  spread(cond, estimate)

ggpairs(GI_reshape_pro[,-1])

GI_reshape_pro_cor <- GI_VST_all_wtNormed %>% 
  filter(GrowStage == "Pro") %>%
  unite(cond, nutrient, LibraryName) %>%
  dplyr::select(cond, Strain, estimate) %>%
  spread(cond, estimate)

GI_reshape_qui_cor <- GI_VST_all_wtNormed %>% 
  filter(GrowStage == "Qui") %>%
  unite(cond, nutrient, LibraryName) %>%
  dplyr::select(cond, Strain, estimate) %>%
  spread(cond, estimate)

pdf("./GI_quiescence/sum/reviewer/Appendix_Figure1.pdf", width = 10, height = 10)
ggpairs(GI_reshape_pro_cor[, -1],
        mapping = ggplot2::aes(),
        #params=list(corSize=12),
        upper = list(continuous = wrap("cor", alpha = 1), combo = "box_no_facet"),
        lower = list(continuous = wrap("points", alpha = 0.3), combo = wrap("dot_no_facet", alpha = 0.2, size = 0.5, col = "pink")),
        title = "Proliferation")+
  theme_classic()
dev.off()

pdf("./GI_quiescence/sum/reviewer/Appendix_Figure2.pdf", width = 10, height = 10)
ggpairs(GI_reshape_qui_cor[,-1],
        mapping = ggplot2::aes(),
        #params=list(corSize=12),
        upper = list(continuous = wrap("cor", alpha = 1), combo = "box_no_facet"),
        lower = list(continuous = wrap("points", alpha = 0.3), combo = wrap("dot_no_facet", alpha = 0.2, size = 0.5, col = "pink")),
        title = "Quiescence")+
  theme_classic()
dev.off()

#Correlation matrix can be created using the R function cor() :
cormat <- round(cor(as.matrix(GI_reshape[,-1])),3)
cormat_pro <- round(cor(as.matrix(GI_reshape_pro[,-1])),3)
write.csv(cormat_pro, "./GI_quiescence/sum/tables/TableEV13a.csv")
cormat_qui <- round(cor(as.matrix(GI_reshape_qui[,-1])),3)
write.csv(cormat_qui, "./GI_quiescence/sum/tables/TableEV13b.csv")

head(cormat)

# Print the correlation heatmap
ggcorrplot(cormat,  method = "circle", hc.method = "complete",  
           hc.order = TRUE, outline.col = "white",
           colors = c("#5959F7", "white", "#FF99A6"), type = "full")
ggsave(paste0(path,"cormat_hclusted_ggcorr.pdf"), width = 8, height = 8,  useDingbats=FALSE)

ggcorrplot(cormat_pro,  method = "square", hc.method = "complete",  
           hc.order = F, outline.col = "white", 
           colors = c("#5959F7", "white", "#FF99A6"), type = "full")
ggsave(paste0(path,"cormat_hclusted_ggcorr_pro.pdf"), width = 5.5, height = 5.5)

ggcorrplot(cormat_qui,  method = "square", hc.method = "complete",  
           hc.order = F, outline.col = "white", 
           colors = c("#5959F7", "white", "#FF99A6"), type = "full")
ggsave(paste0(path,"cormat_hclusted_ggcorr_qui.pdf"), width = 5.5, height = 5.5)

#Figure S4D, RIM15 PHO85 carbon
a<-ggscatter(GI_reshape_pro, x = "carbon_Pro_PHO85", y = "nitrogen_Pro_PHO85", size=3, alpha = 0.5,  cor.coef.size = 0.3, col="#9999FF") +
    xlab("PHO85_carbon") +
    ylab("PHO85_nitrogen") +
    geom_smooth(method = "lm", se = FALSE, col = "#9999FF") +
    xlim(-0.5,0.5) +
    ylim(-0.5,0.5) +
    stat_cor(method = "pearson", label.x.npc = "left", label.y.npc = "top", size=7, col = "#9999FF") +
    theme(axis.text=element_text(size=17), axis.text.x=element_text(angle=0),
          axis.title=element_text(size=17,face="bold")) 
b<-ggscatter(GI_reshape_pro, x = "carbon_Pro_PHO85", y = "nitrogen_Pro_RIM15", size=3, alpha = 0.5,  cor.coef.size = 0.3, col="#9999FF") +
    xlab("PHO85_carbon") +
    ylab("RIM15_nitrogen") +
    geom_smooth(method = "lm", se = FALSE, col = "#9999FF") +
    xlim(-0.5,0.5) +
    ylim(-0.5,0.5) +
    stat_cor(method = "pearson", label.x.npc = "left", label.y.npc = "top", size=7, col = "#9999FF") +
    theme(axis.text=element_text(size=17), axis.text.x=element_text(angle=0),
          axis.title=element_text(size=17,face="bold")) 
c<-ggscatter(GI_reshape_pro, x = "carbon_Pro_RIM15", y = "nitrogen_Pro_PHO85", size=3, alpha = 0.5,  cor.coef.size = 0.3, col="#9999FF") +
    xlab("RIM15_carbon") +
    ylab("PHO85_nitrogen") +
    geom_smooth(method = "lm", se = FALSE, col = "#9999FF") +
    xlim(-0.5,0.5) +
    ylim(-0.5,0.5) +
    stat_cor(method = "pearson", label.x.npc = "left", label.y.npc = "top", size=7, col = "#9999FF") +
    theme(axis.text=element_text(size=17), axis.text.x=element_text(angle=0),
          axis.title=element_text(size=17,face="bold")) 
d<-ggscatter(GI_reshape_pro, x = "carbon_Pro_RIM15", y = "nitrogen_Pro_RIM15", size=3, alpha = 0.5,  cor.coef.size = 0.3, col="#9999FF") +
    xlab("RIM15_carbon") +
    ylab("RIM15_nitrogen") +
    geom_smooth(method = "lm", se = FALSE, col = "#9999FF") +
    xlim(-0.5,0.5) +
    ylim(-0.5,0.5) +
    stat_cor(method = "pearson", label.x.npc = "left", label.y.npc = "top", size=7, col = "#9999FF") +
    theme(axis.text=element_text(size=17), axis.text.x=element_text(angle=0),
          axis.title=element_text(size=17,face="bold")) 
pdf("./GI_quiescence/sum/reviewer/FigEV5B.pdf", width = 7, height = 6)
grid.arrange(a, b, c, d, ncol = 2)
dev.off()

#Figure S5C, nitrogen starved quiescent cell
e<-ggscatter(GI_reshape_qui, x = "nitrogen_Qui_RIM15", y = "nitrogen_Qui_PHO85", size=3, alpha = 0.5,  cor.coef.size = 0.3, col="#FF99A6") +
    xlab("RIM15_nitrogen") +
    ylab("PHO85_nitrogen") +
    geom_smooth(method = "lm", se = FALSE, col = "#FF99A6") +
    xlim(-0.5,0.5) +
    ylim(-0.5,0.5) +
    stat_cor(method = "pearson", label.x.npc = "left", label.y.npc = "top", size=7, col = "#FF99A6") +
    theme(axis.text=element_text(size=17), axis.text.x=element_text(angle=0),
          axis.title=element_text(size=17,face="bold")) 
f<-ggscatter(GI_reshape_qui, x = "nitrogen_Qui_RIM15", y = "nitrogen_Qui_TOR1", size=3, alpha = 0.5,  cor.coef.size = 0.3, col="#FF99A6") +
    xlab("RIM15_nitrogen") +
    ylab("TOR1_nitrogen") +
    geom_smooth(method = "lm", se = FALSE, col = "#FF99A6") +
    xlim(-0.5,0.5) +
    ylim(-0.5,0.5) +
    stat_cor(method = "pearson", label.x.npc = "left", label.y.npc = "top", size=7, col = "#FF99A6") +
    theme(axis.text=element_text(size=17), axis.text.x=element_text(angle=0),
          axis.title=element_text(size=17,face="bold")) 
g<-ggscatter(GI_reshape_qui, x = "nitrogen_Qui_PHO85", y = "nitrogen_Qui_TOR1", size=3, alpha = 0.5,  cor.coef.size = 0.3, col="#FF99A6") +
    xlab("PHO85_nitrogen") +
    ylab("TOR1_nitrogen") +
    geom_smooth(method = "lm", se = FALSE, col = "#FF99A6") +
    xlim(-0.5,0.5) +
    ylim(-0.5,0.5) +
    stat_cor(method = "pearson", label.x.npc = "left", label.y.npc = "top", size=7, col = "#FF99A6") +
    theme(axis.text=element_text(size=17), axis.text.x=element_text(angle=0),
          axis.title=element_text(size=17,face="bold")) 
pdf("./GI_quiescence/sum/reviewer/FigEV5C.pdf", width = 10, height = 3)
grid.arrange(e, f, g,ncol = 3)
dev.off()

#Figure S5D, phosphate starved quiescent cell
h<-ggscatter(GI_reshape_qui, x = "phosphate_Qui_RIM15", y = "phosphate_Qui_PHO85", size=3, alpha = 0.5,  cor.coef.size = 0.3, col="#FF99A6") +
    xlab("RIM15_phosphate") +
    ylab("PHO85_phosphate") +
    geom_smooth(method = "lm", se = FALSE, col = "#FF99A6") +
    xlim(-0.5,0.5) +
    ylim(-0.5,0.5) +
    stat_cor(method = "pearson", label.x.npc = "left", label.y.npc = "top", size=7, col = "#FF99A6") +
    theme(axis.text=element_text(size=17), axis.text.x=element_text(angle=0),
          axis.title=element_text(size=17,face="bold")) 
i<-ggscatter(GI_reshape_qui, x = "phosphate_Qui_RIM15", y = "phosphate_Qui_TOR1", size=3, alpha = 0.5,  cor.coef.size = 0.3, col="#FF99A6") +
    xlab("RIM15_phosphate") +
    ylab("TOR1_phosphate") +
    geom_smooth(method = "lm", se = FALSE, col = "#FF99A6") +
    xlim(-0.5,0.5) +
    ylim(-0.5,0.5) +
    stat_cor(method = "pearson", label.x.npc = "left", label.y.npc = "top", size=7, col = "#FF99A6") +
    theme(axis.text=element_text(size=17), axis.text.x=element_text(angle=0),
          axis.title=element_text(size=17,face="bold")) 
j<-ggscatter(GI_reshape_qui, x = "phosphate_Qui_PHO85", y = "phosphate_Qui_TOR1", size=3, alpha = 0.5,  cor.coef.size = 0.3, col="#FF99A6") +
    xlab("PHO85_phosphate") +
    ylab("TOR1_phosphate") +
    geom_smooth(method = "lm", se = FALSE, col = "#FF99A6") +
    xlim(-0.5,0.5) +
    ylim(-0.5,0.5) +
    stat_cor(method = "pearson", label.x.npc = "left", label.y.npc = "top", size=7, col = "#FF99A6") +
    theme(axis.text=element_text(size=17), axis.text.x=element_text(angle=0),
          axis.title=element_text(size=17,face="bold")) 
pdf("./GI_quiescence/sum/reviewer/FigEV5D.pdf", width = 10, height = 3)
grid.arrange(h, i, j,ncol = 3)
dev.off()

#Figure S5E, RIM15 PHO85 carbon vs phosphate
k<-ggscatter(GI_reshape_qui, x = "carbon_Qui_PHO85", y = "phosphate_Qui_PHO85", size=3, alpha = 0.5,  cor.coef.size = 0.3, col="#9999FF") +
    xlab("PHO85_carbon") +
    ylab("PHO85_phosphate") +
    geom_smooth(method = "lm", se = FALSE, col = "#9999FF") +
    xlim(-0.5,0.5) +
    ylim(-0.5,0.5) +
    stat_cor(method = "pearson", label.x.npc = "left", label.y.npc = "top", size=7, col = "#9999FF") +
    theme(axis.text=element_text(size=17), axis.text.x=element_text(angle=0),
          axis.title=element_text(size=17,face="bold")) 
l<-ggscatter(GI_reshape_qui, x = "carbon_Qui_RIM15", y = "phosphate_Qui_PHO85", size=3, alpha = 0.5,  cor.coef.size = 0.3, col="#9999FF") +
    xlab("RIM15_carbon") +
    ylab("PHO85_phosphate") +
    geom_smooth(method = "lm", se = FALSE, col = "#9999FF") +
    xlim(-0.5,0.5) +
    ylim(-0.5,0.5) +
    stat_cor(method = "pearson", label.x.npc = "left", label.y.npc = "top", size=7, col = "#9999FF") +
    theme(axis.text=element_text(size=17), axis.text.x=element_text(angle=0),
          axis.title=element_text(size=17,face="bold")) 
m<-ggscatter(GI_reshape_qui, x = "carbon_Qui_TOR1", y = "phosphate_Qui_PHO85", size=3, alpha = 0.5,  cor.coef.size = 0.3, col="#9999FF") +
    xlab("TOR1_carbon") +
    ylab("PHO85_phosphate") +
    geom_smooth(method = "lm", se = FALSE, col = "#9999FF") +
    xlim(-0.5,0.5) +
    ylim(-0.5,0.5) +
    stat_cor(method = "pearson", label.x.npc = "left", label.y.npc = "top", size=7, col = "#9999FF") +
    theme(axis.text=element_text(size=17), axis.text.x=element_text(angle=0),
          axis.title=element_text(size=17,face="bold")) 
n<-ggscatter(GI_reshape_qui, x = "carbon_Qui_PHO85", y = "phosphate_Qui_RIM15", size=3, alpha = 0.5,  cor.coef.size = 0.3, col="#9999FF") +
    xlab("PHO85_carbon") +
    ylab("RIM15_phosphate") +
    geom_smooth(method = "lm", se = FALSE, col = "#9999FF") +
    xlim(-0.5,0.5) +
    ylim(-0.5,0.5) +
    stat_cor(method = "pearson", label.x.npc = "left", label.y.npc = "top", size=7, col = "#9999FF") +
    theme(axis.text=element_text(size=17), axis.text.x=element_text(angle=0),
          axis.title=element_text(size=17,face="bold")) 
o<-ggscatter(GI_reshape_qui, x = "carbon_Qui_RIM15", y = "phosphate_Qui_RIM15", size=3, alpha = 0.5,  cor.coef.size = 0.3, col="#9999FF") +
    xlab("RIM15_carbon") +
    ylab("RIM15_phosphate") +
    geom_smooth(method = "lm", se = FALSE, col = "#9999FF") +
    xlim(-0.5,0.5) +
    ylim(-0.5,0.5) +
    stat_cor(method = "pearson", label.x.npc = "left", label.y.npc = "top", size=7, col = "#9999FF") +
    theme(axis.text=element_text(size=17), axis.text.x=element_text(angle=0),
          axis.title=element_text(size=17,face="bold")) 
p<-ggscatter(GI_reshape_qui, x = "carbon_Qui_TOR1", y = "phosphate_Qui_RIM15", size=3, alpha = 0.5,  cor.coef.size = 0.3, col="#9999FF") +
    xlab("TOR1_carbon") +
    ylab("RIM15_phosphate") +
    geom_smooth(method = "lm", se = FALSE, col = "#9999FF") +
    xlim(-0.5,0.5) +
    ylim(-0.5,0.5) +
    stat_cor(method = "pearson", label.x.npc = "left", label.y.npc = "top", size=7, col = "#9999FF") +
    theme(axis.text=element_text(size=17), axis.text.x=element_text(angle=0),
          axis.title=element_text(size=17,face="bold")) 
q<-ggscatter(GI_reshape_qui, x = "carbon_Qui_PHO85", y = "phosphate_Qui_TOR1", size=3, alpha = 0.5,  cor.coef.size = 0.3, col="#9999FF") +
    xlab("PHO85_carbon") +
    ylab("TOR1_phosphate") +
    geom_smooth(method = "lm", se = FALSE, col = "#9999FF") +
    xlim(-0.5,0.5) +
    ylim(-0.5,0.5) +
    stat_cor(method = "pearson", label.x.npc = "left", label.y.npc = "top", size=7, col = "#9999FF") +
    theme(axis.text=element_text(size=17), axis.text.x=element_text(angle=0),
          axis.title=element_text(size=17,face="bold")) 
r<-ggscatter(GI_reshape_qui, x = "carbon_Qui_RIM15", y = "phosphate_Qui_TOR1", size=3, alpha = 0.5,  cor.coef.size = 0.3, col="#9999FF") +
    xlab("RIM15_carbon") +
    ylab("TOR1_phosphate") +
    geom_smooth(method = "lm", se = FALSE, col = "#9999FF") +
    xlim(-0.5,0.5) +
    ylim(-0.5,0.5) +
    stat_cor(method = "pearson", label.x.npc = "left", label.y.npc = "top", size=7, col = "#9999FF") +
    theme(axis.text=element_text(size=17), axis.text.x=element_text(angle=0),
          axis.title=element_text(size=17,face="bold")) 
s<-ggscatter(GI_reshape_qui, x = "carbon_Qui_TOR1", y = "phosphate_Qui_TOR1", size=3, alpha = 0.5,  cor.coef.size = 0.3, col="#9999FF") +
    xlab("TOR1_carbon") +
    ylab("TOR1_phosphate") +
    geom_smooth(method = "lm", se = FALSE, col = "#9999FF") +
    xlim(-0.5,0.5) +
    ylim(-0.5,0.5) +
    stat_cor(method = "pearson", label.x.npc = "left", label.y.npc = "top", size=7, col = "#9999FF") +
    theme(axis.text=element_text(size=17), axis.text.x=element_text(angle=0),
          axis.title=element_text(size=17,face="bold")) 
pdf("./GI_quiescence/sum/reviewer/FigEV5E.pdf", width = 14, height = 13)
grid.arrange(k, l, m, n, o, p, q, r, s,ncol = 3)
dev.off()

pdf("./GI_quiescence/sum/reviewer/FigEV5F.pdf", width = 15, height = 30)
grid.arrange(k, l, m, n, o, p, q, r, s, e, f, g, h, i, j, a, b, c, d, ncol = 3)
dev.off()

#make zoom in plots for Figure EV4A
#positive correlation examples: starving nutrient is the driving force for GI profiles regardless of the genotype background
#carbon
ggscatter(GI_reshape_qui, x = "carbon_Qui_TOR1", y = "nitrogen_Qui_TOR1", size=1.5, alpha = 0.5, cor.coef.size = 0.3, col="#FF99A6") +
    xlab("GI of TOR1 (carbon limited)") +
    ylab("GI of TOR1 (nitrogen limited)") +
    geom_smooth(method = "lm", se = FALSE, col = "#F76F87") +
    xlim(-0.5,0.5)+
    ylim(-0.5,0.5)+
    stat_cor(method = "pearson", label.x.npc = "left", label.y.npc = "top", size=5, col = "#F76F87") +
    theme(axis.text=element_text(size=12), axis.text.x=element_text(angle=0), axis.title=element_text(size=12,face="bold")) 
ggsave(paste0(path,"FigS4C_right.pdf"), width = 4, height = 3.5)


pdf("./GI_quiescence/sum/reviewer/FigEV4B.pdf", width = 5, height = 4, ncol = 2)
GI_reshape_qui_cor
ggpairs(GI_reshape_qui_cor[, 2:4],
        mapping = ggplot2::aes(),
        #params=list(corSize=12),
        upper = list(continuous = wrap("cor", alpha = 1), combo = "box_no_facet"),
        lower = list(continuous = wrap("points", alpha = 0.3), combo = wrap("dot_no_facet", alpha = 0.2, size = 0.5, col = "pink")))+
  theme_classic()
dev.off()

#nitrogen
pdf("./GI_quiescence/sum/reviewer/FigEV4C.pdf", width = 5, height = 4)
ggpairs(GI_reshape_qui_cor[, 5:7],
        mapping = ggplot2::aes(),
        #params=list(corSize=12),
        upper = list(continuous = wrap("cor", alpha = 1), combo = "box_no_facet"),
        lower = list(continuous = wrap("points", alpha = 0.3), combo = wrap("dot_no_facet", alpha = 0.2, size = 0.5, col = "pink"))
       # title = "GI profile comparison for quiescent cells starved fro nitrogen"
       )+ 
  theme_classic()
dev.off()

#phosphrous
pdf("./GI_quiescence/sum/reviewer/FigEV4D.pdf", width = 5, height = 4)
ggpairs(GI_reshape_qui_cor[, 8:10],
        mapping = ggplot2::aes(),
        #params=list(corSize=12),
        upper = list(continuous = wrap("cor", alpha = 1), combo = "box_no_facet"),
        lower = list(continuous = wrap("points", alpha = 0.3), combo = wrap("dot_no_facet", alpha = 0.2, size = 0.5, col = "pink"))
        #title = "GI profile comparison for quiescent cells starved fro phosphate"
        )+
  theme_classic()
dev.off()

#####negative correlation examples
##GI profiels differ between cell types
pdf("./GI_quiescence/sum/reviewer/FigEV4E.pdf", width = 7.5, height = 7)
ggpairs(GI_reshape_qui_cor[, c(2:4,8:10)],
        mapping = ggplot2::aes(),
        #params=list(corSize=12),
        upper = list(continuous = wrap("cor", alpha = 1), combo = "box_no_facet"),
        lower = list(continuous = wrap("points", alpha = 0.3), combo = wrap("dot_no_facet", alpha = 0.2, size = 0.5, col = "pink"))
        #title = "GI profile comparison for quiescent cells starved fro phosphate"
        )+
  theme_classic()
dev.off()

##GI profiels differ between conditions

pdf("./GI_quiescence/sum/reviewer/FigEV4F.pdf", width = 6, height = 5.5)
ggpairs(GI_reshape[, c(2:3,8:9)],
        mapping = ggplot2::aes(),
        #params=list(corSize=12),
        upper = list(continuous = wrap("cor", alpha = 1), combo = "box_no_facet"),
        lower = list(continuous = wrap("points", alpha = 0.3), combo = wrap("dot_no_facet", alpha = 0.2, size = 0.5, col = "pink"))
        #title = "GI profile comparison for quiescent cells starved fro phosphate"
        )+
  theme_classic()
dev.off()

```

###Data preparation for genetic interaction profile similarity etwork construction in Cytoscape
```{r, include=F}
GI_VST_all_wtNormed<-read_csv("./GI_quiescence/sum/tables/TableS13.csv")[,-1]

#name the interaction types for each gene pair
master_GI_df <- GI_VST_all_wtNormed %>% 
  mutate(GI.type.sig = case_when(estimate > 0 & q.value < 0.05 ~ "pos.sig in ancova", 
                                 estimate < 0 & q.value < 0.05 ~ "neg.sig in ancova",
                                 q.value > 0.05 ~ "neutral in ancova")) %>%
  mutate(GI.type = case_when(estimate > 0 ~ "pos in ancova", 
                                 estimate < 0  ~ "neg in ancova")) %>%
  mutate(log_p = -log(q.value)) %>%
  dplyr::select(-c(term, std.error))

#creat a spread matrix which is good for running correlationcaculation in metscape 3 and network visualization in cytoscape 

master_GI_pro <- master_GI_df %>% 
  filter (GrowStage == "Pro") %>%
  unite (cond, nutrient, LibraryName) %>%
  dplyr::select (cond, Strain, estimate) %>%
  spread (key = cond, value = estimate)

#TableS18: genetic interaction similarity for all kinases during proliferation. Original data for Fig4A
write.csv(master_GI_pro, "./GI_quiescence/sum/tables/TableS18.csv", row.names = FALSE)

#run pairwise correlation and store the output in a separate file
# ++++++++++++++++++++++++++++
# flattenCorrMatrix
# ++++++++++++++++++++++++++++
# cormat : matrix of the correlation coefficients
# pmat : matrix of the correlation p-values
flattenCorrMatrix <- function(cormat, pmat) {
  ut <- upper.tri(cormat)
  data.frame(
    row = rownames(cormat)[row(cormat)[ut]],
    column = rownames(cormat)[col(cormat)[ut]],
    cor  =(cormat)[ut],
    p = pmat[ut]
    )
}
library(Hmisc)
pro_cor<-cor(as.matrix(master_GI_pro[,-1]))

master_GI_qui <- master_GI_df %>% 
  filter (GrowStage == "Qui") %>%
  unite (cond, nutrient, LibraryName) %>%
  dplyr::select (cond, Strain, estimate) %>%
  spread (key = cond, value = estimate)

#TableS19: genetic interaction similarity for all kinases during quiescence. Original data for Fig4B
write.csv(master_GI_qui, "./GI_quiescence/sum/tables/TableS19.csv", row.names = FALSE)

qui_cor<-cor(as.matrix(master_GI_qui[,-1]))
#qui_cor<-flattenCorrMatrix(qui_cor$r, qui_cor$P)

#visulize correlation network using igraph
library(igraph)
network_pro=graph_from_adjacency_matrix(pro_cor, weighted=TRUE, 
                                     mode="undirected", diag=FALSE)
plot(network_pro)

network_qui=graph_from_adjacency_matrix( qui_cor, weighted=TRUE, 
                                     mode="undirected", diag=FALSE)
plot(network_qui)
```

#Data preparation for SAFE annotation
```{r}
path = "./GI_quiescence/sum/safe/"
YtoGene <- read.table("./GI_quiescence/sum/data/YORFtoGENE_2018")
colnames(YtoGene) <- c("Strain","Gene")
GI_VST_all_wtNormed<-read_csv("./GI_quiescence/sum/tables/TableS13.csv")[,-1]
GI_VST_all_wtNormed_prolong<-read_csv("./GI_quiescence/sum/tables/TableS14.csv")[,-1]

GI_VST_all <- left_join(GI_VST_all_wtNormed, YtoGene, by ="Strain")
GI_VST_all_prolong <- left_join(GI_VST_all_wtNormed_prolong, YtoGene, by ="Strain")

#a loop to save all files in each catagory
for (s in c("Pro", "Qui")){
  for (n in c("carbon","nitrogen","phosphate")){
    for (q in c("TOR1","RIM15","PHO85")){ 
      GI_VST_all %>% 
        filter(nutrient == n & LibraryName == q & GrowStage == s) %>%
        dplyr::select(Strain, estimate, p.value, q.value, LibraryName) %>%
        dplyr::rename(ORF = Strain, GIS = estimate, Query = LibraryName) %>%
        write.csv(.,file = paste0(path,s,"/",n,"/",q,".csv"), row.names = FALSE)
      }
  }
}

for (n in c("carbon","nitrogen","phosphate")){
    for (q in c("TOR1","RIM15","PHO85")){ 
      GI_VST_all_prolong %>% 
        filter(nutrient == n & LibraryName == q) %>%
        dplyr::select(Strain, estimate, p.value, q.value, LibraryName) %>%
        dplyr::rename(ORF = Strain, GIS = estimate, Query = LibraryName) %>%
        write.csv(.,file = paste0(path,"prolong/",n,"/",q,".csv"), row.names = FALSE)
      }
  }
#The output table can be used at the input table for safe.py script 
```

##Functional annotation of significantly interacting genes in quiescence
```{r,dataToAnalyze,cache=T,message=F,warning=F}
GI_VST_all_wtNormed<-read_csv("./sum/tables/TableS13.csv")[,-1]

GI_VST_all <- left_join(GI_VST_all_wtNormed, YtoGene, by ="Strain")

pos_int <- GI_VST_all %>% filter (estimate > 0 & q.value < 0.05) %>%
  unite(condition, nutrient, GrowStage) %>%
  dplyr::select(condition, Strain, LibraryName, Gene, estimate) %>%
  dplyr::rename(Systematic = Strain, ancova.gis = estimate) %>% 
  spread(key = condition , value = ancova.gis)

#convert genenames
enrichGO_pos<-list()
for (var in c("RIM15","TOR1")){
  #PHO85 were removed to eliminate the warning may get by no enrichment. 
#extract the genes from each condittion and convert into entrezID in starvation
TopGIS_Entrez_carbon_s<- pos_int %>% dplyr::filter(LibraryName == var)  %>%
          dplyr::select(Systematic,carbon_Qui) %>%
          #remove NA values
          drop_na() %>%
  left_join(SystematicToSGDIDmapper, by="Systematic")%>%
  {clusterProfiler::bitr(.$SGDID, fromType="SGD", toType="ENTREZID"
    ,OrgDb=org.Sc.sgd.db::org.Sc.sgd.db,drop=T)} %>%
  pull(ENTREZID)

TopGIS_Entrez_nitrogen_s<- pos_int %>% dplyr::filter(LibraryName == var)  %>%
          dplyr::select(Systematic,nitrogen_Qui) %>%
          #remove NA values
          drop_na() %>%
  left_join(SystematicToSGDIDmapper, by="Systematic")%>%
  {clusterProfiler::bitr(.$SGDID, fromType="SGD", toType="ENTREZID"
    ,OrgDb=org.Sc.sgd.db::org.Sc.sgd.db,drop=T)} %>%
  pull(ENTREZID)

TopGIS_Entrez_phosphate_s <- pos_int %>% dplyr::filter(LibraryName == var)  %>%
          dplyr::select(Systematic,phosphate_Qui) %>%
          #remove NA values
          drop_na() %>%
  left_join(SystematicToSGDIDmapper, by="Systematic")%>%
  {clusterProfiler::bitr(.$SGDID, fromType="SGD", toType="ENTREZID"
    ,OrgDb=org.Sc.sgd.db::org.Sc.sgd.db,drop=T)} %>%
  pull(ENTREZID)

mydata_cs <- data.frame(Entrez=TopGIS_Entrez_carbon_s)
mydata_ns <- data.frame(Entrez=TopGIS_Entrez_nitrogen_s)
mydata_ps <- data.frame(Entrez=TopGIS_Entrez_phosphate_s)

mydata_cs$condtion <- "carbon_Qui"
mydata_ns$condtion <- "nitrogen_Qui"
mydata_ps$condtion <- "phosphate_Qui"

enrichGO_pos[[var]] <- rbind(mydata_cs, mydata_ns, mydata_ps)

#run compare cluser for all terms 
##########do all together
formula_res_all <- compareCluster(Entrez~condtion, data=enrichGO_pos[[var]], 
                              OrgDb=org.Sc.sgd.db::org.Sc.sgd.db,
                              ont="ALL", fun="enrichGO", pvalueCutoff=0.05)

#make a plot using clusterprofiler buildin function
dotplot(formula_res_all) + 
  ggplot2::theme(axis.text.x=element_text(angle=90),legend.position="bottom") +
  ggplot2::ggtitle(var)
ggsave(paste0("./sum/GIS analysis/",var,"/formula_res_pos.pdf"), width=10,height=8)

formula_res_all[,] %>% 
  write_csv(paste0("./sum/GIS analysis/",var,"/formula_res_all_pos.csv"))

formula_res_all_neg[,] %>% 
  write_csv(paste0("./sum/GIS analysis/",var,"/formula_res_all_neg.csv"))
}

#not the warning is indicating that no enrichment were fond in any of the gene cluster that show significant interaction with PHO85. If eliminating PHO85 in the var variable, the code should run smoothly.
```

#GO term enrichment for Significant interactions
```{r}
GI_VST_all_wtNormed<-read_csv("./sum/tables/TableS13.csv")[,-1]

pos_int <- GI_VST_all_wtNormed %>% filter (estimate > 0 & q.value < 0.05) %>%
  unite(condition, nutrient, GrowStage) %>%
  dplyr::select(condition, Strain, LibraryName, estimate) %>%
  dplyr::rename(Systematic = Strain, ancova.gis = estimate) %>% 
    spread(key = condition , value = ancova.gis) 

neg_int <- GI_VST_all_wtNormed %>% filter (estimate < 0 & q.value < 0.05) %>%
  unite(condition, nutrient, GrowStage) %>%
  dplyr::select(condition, Strain, LibraryName, estimate) %>%
  dplyr::rename(Systematic = Strain, ancova.gis = estimate) %>% 
  spread(key = condition , value = ancova.gis)

#compare GO for positive interactions
enrichGO_pos<-list()
enrichGO_neg<-list()
for (var in c("RIM15","TOR1","PHO85")){
  #Proliferating cell
  var = "RIM15"
    C_pro_list <- pos_int %>% dplyr::filter(LibraryName == var) %>%
          dplyr::select(Systematic, carbon_Pro) %>% drop_na() %>% 
  {clusterProfiler::bitr(.$Systematic, fromType="ENSEMBL", toType="ENTREZID"
    ,OrgDb=org.Sc.sgd.db::org.Sc.sgd.db,drop=T)} %>% 
      dplyr::select(ENTREZID) %>% mutate(condition = "C_Qui") #%>% pull(ENTREZID)
    
    N_pro_list <- pos_int %>% dplyr::filter(LibraryName == var) %>%
          dplyr::select(Systematic, nitrogen_Pro) %>% drop_na() %>% 
  {clusterProfiler::bitr(.$Systematic, fromType="ENSEMBL", toType="ENTREZID"
    ,OrgDb=org.Sc.sgd.db::org.Sc.sgd.db,drop=T)} %>% 
      dplyr::select(ENTREZID) %>% mutate(condition = "N_Qui") #%>% pull(ENTREZID)
    
    P_pro_list <- pos_int %>% dplyr::filter(LibraryName == var) %>%
          dplyr::select(Systematic, phosphate_Pro) %>% drop_na() %>% 
  {clusterProfiler::bitr(.$Systematic, fromType="ENSEMBL", toType="ENTREZID"
    ,OrgDb=org.Sc.sgd.db::org.Sc.sgd.db,drop=T)} %>% 
      dplyr::select(ENTREZID) %>% mutate(condition = "P_Qui") #%>% pull(ENTREZID)
        
   enrichGO_pos_pro <- bind_rows(C_pro_list,N_pro_list,P_pro_list) %>% drop_na()
  
  #Quiescent cell
    C_qui_list <- pos_int %>% dplyr::filter(LibraryName == var) %>%
          dplyr::select(Systematic, carbon_Qui) %>% drop_na() %>% 
  {clusterProfiler::bitr(.$Systematic, fromType="ENSEMBL", toType="ENTREZID"
    ,OrgDb=org.Sc.sgd.db::org.Sc.sgd.db,drop=T)} %>% 
      dplyr::select(ENTREZID) %>% mutate(condition = "C_Qui") #%>% pull(ENTREZID)
    
    N_qui_list <- pos_int %>% dplyr::filter(LibraryName == var) %>%
          dplyr::select(Systematic, nitrogen_Qui) %>% drop_na() %>% 
  {clusterProfiler::bitr(.$Systematic, fromType="ENSEMBL", toType="ENTREZID"
    ,OrgDb=org.Sc.sgd.db::org.Sc.sgd.db,drop=T)} %>% 
      dplyr::select(ENTREZID) %>% mutate(condition = "N_Qui") #%>% pull(ENTREZID)
    
    P_qui_list <- pos_int %>% dplyr::filter(LibraryName == var) %>%
          dplyr::select(Systematic, phosphate_Qui) %>% drop_na() %>% 
  {clusterProfiler::bitr(.$Systematic, fromType="ENSEMBL", toType="ENTREZID"
    ,OrgDb=org.Sc.sgd.db::org.Sc.sgd.db,drop=T)} %>% 
      dplyr::select(ENTREZID) %>% mutate(condition = "P_Qui") #%>% pull(ENTREZID)
    enrichGO_pos[[var]] <- bind_rows(C_qui_list,N_qui_list,P_qui_list,enrichGO_pos_pro) %>% drop_na()
    #tmp <- clusterProfiler::enrichGO(gene_list, 
     #                                ont ="ALL",
      #                               OrgDb = "org.Sc.sgd.db", 
       #                              keyType = "ENSEMBL", 
        #                             pvalueCutoff = 0.05, 
         #                            pAdjustMethod = "BH", 
          #                           universe, 
           #                          qvalueCutoff = 0.2, 
            #                         minGSSize = 10, 
             #                        maxGSSize = 500, 
              #                       readable = FALSE)
              
    formula_res_pos_all <- compareCluster(ENTREZID~condition, data=enrichGO_pos[[var]], 
                              OrgDb=org.Sc.sgd.db::org.Sc.sgd.db,
                              ont="ALL", fun="enrichGO", pvalueCutoff=0.05, pAdjustMethod = "fdr")
  
dotplot(formula_res_pos_all) + 
  ggplot2::theme(axis.text.x=element_text(angle=90),legend.position="bottom") +
  ggplot2::ggtitle(var)
ggsave(paste0("./sum/GIS analysis/",var,"/formula_res_pos.pdf"), width=10,height=8)

formula_res_pos_all[,] %>% 
  write_csv(paste0("./sum/GIS analysis/",var,"/formula_res_all_pos.csv"))

#compare GO for positive interactions
  #Proliferating cell
    C_pro_list <- neg_int %>% dplyr::filter(LibraryName == var) %>%
          dplyr::select(Systematic, carbon_Pro) %>% drop_na() %>% 
  {clusterProfiler::bitr(.$Systematic, fromType="ENSEMBL", toType="ENTREZID"
    ,OrgDb=org.Sc.sgd.db::org.Sc.sgd.db,drop=T)} %>% 
      dplyr::select(ENTREZID) %>% mutate(condition = "C_Qui") #%>% pull(ENTREZID)
    
    N_pro_list <- neg_int %>% dplyr::filter(LibraryName == var) %>%
          dplyr::select(Systematic, nitrogen_Pro) %>% drop_na() %>% 
  {clusterProfiler::bitr(.$Systematic, fromType="ENSEMBL", toType="ENTREZID"
    ,OrgDb=org.Sc.sgd.db::org.Sc.sgd.db,drop=T)} %>% 
      dplyr::select(ENTREZID) %>% mutate(condition = "N_Qui") #%>% pull(ENTREZID)
    
    P_pro_list <- neg_int %>% dplyr::filter(LibraryName == var) %>%
          dplyr::select(Systematic, phosphate_Pro) %>% drop_na() %>% 
  {clusterProfiler::bitr(.$Systematic, fromType="ENSEMBL", toType="ENTREZID"
    ,OrgDb=org.Sc.sgd.db::org.Sc.sgd.db,drop=T)} %>% 
      dplyr::select(ENTREZID) %>% mutate(condition = "P_Qui") #%>% pull(ENTREZID)
        
   enrichGO_neg_pro <- bind_rows(C_pro_list,N_pro_list,P_pro_list) %>% drop_na()
  
  #Quiescent cell
    C_qui_list <- neg_int %>% dplyr::filter(LibraryName == var) %>%
          dplyr::select(Systematic, carbon_Qui) %>% drop_na() %>% 
  {clusterProfiler::bitr(.$Systematic, fromType="ENSEMBL", toType="ENTREZID"
    ,OrgDb=org.Sc.sgd.db::org.Sc.sgd.db,drop=T)} %>% 
      dplyr::select(ENTREZID) %>% mutate(condition = "C_Qui") #%>% pull(ENTREZID)
    
    N_qui_list <- neg_int %>% dplyr::filter(LibraryName == var) %>%
          dplyr::select(Systematic, nitrogen_Qui) %>% drop_na() %>% 
  {clusterProfiler::bitr(.$Systematic, fromType="ENSEMBL", toType="ENTREZID"
    ,OrgDb=org.Sc.sgd.db::org.Sc.sgd.db,drop=T)} %>% 
      dplyr::select(ENTREZID) %>% mutate(condition = "N_Qui") #%>% pull(ENTREZID)
    
    P_qui_list <- neg_int %>% dplyr::filter(LibraryName == var) %>%
          dplyr::select(Systematic, phosphate_Qui) %>% drop_na() %>% 
  {clusterProfiler::bitr(.$Systematic, fromType="ENSEMBL", toType="ENTREZID"
    ,OrgDb=org.Sc.sgd.db::org.Sc.sgd.db,drop=T)} %>% 
      dplyr::select(ENTREZID) %>% mutate(condition = "P_Qui") #%>% pull(ENTREZID)
    enrichGO_neg[[var]] <- bind_rows(C_qui_list,N_qui_list,P_qui_list,enrichGO_neg_pro) %>% drop_na()
              
    formula_res_neg_all <- compareCluster(ENTREZID~condition, data=enrichGO_neg[[var]], 
                              OrgDb=org.Sc.sgd.db::org.Sc.sgd.db,
                              ont="ALL", fun="enrichGO", pvalueCutoff=0.05, pAdjustMethod = "fdr")
  
dotplot(formula_res_neg_all) + 
  ggplot2::theme(axis.text.x=element_text(angle=90),legend.position="bottom") +
  ggplot2::ggtitle(var)
ggsave(paste0("./sum/GIS analysis/",var,"/formula_res_all_neg.pdf"), width=10,height=8)

formula_res_neg_all[,] %>% 
  write_csv(paste0("./sum/GIS analysis/",var,"/formula_res_all_neg.csv"))
}
```

#GSEA for Significant interactions
```{r}
int <- GI_VST_all_wtNormed %>% filter (q.value < 0.05) %>%
  unite(condition, nutrient, GrowStage) %>%
  dplyr::select(condition, Strain, LibraryName, estimate) %>%
  dplyr::rename(Systematic = Strain, ancova.gis = estimate) %>% 
    spread(key = condition , value = ancova.gis) 

#compare GO for positive interactions
gseGOResults <- list() 
gseGOtable <- ""
for (var in c("RIM15","TOR1","PHO85")){
  for (varz in c("carbon_Pro", "carbon_Qui", "nitrogen_Pro","nitrogen_Qui", "phosphate_Pro", "phosphate_Qui")){
    # we want the fitness and suvival rate
    original_gene_list <- int %>% dplyr::filter(LibraryName == var) %>% dplyr::select(Systematic, varz) %>% drop_na() %>% pull(varz)
    # name the vector
    names(original_gene_list) <- int %>% dplyr::filter(LibraryName == var) %>% dplyr::select(Systematic, varz) %>% drop_na() %>% pull(Systematic)
    # sort the list in decreasing order (required for clusterProfiler)
    gene_list = sort(original_gene_list, decreasing = TRUE)
    tmp <- clusterProfiler::gseGO(geneList=gene_list, 
             ont ="CC", 
             keyType = "ENSEMBL", 
             nPerm = 10000, 
             minGSSize = 2, 
             maxGSSize = length(gene_list)-1, 
             pvalueCutoff = 0.05, 
             verbose = TRUE, 
             OrgDb = "org.Sc.sgd.db", 
             pAdjustMethod = "none")
    
    tmp2 <- simplify(tmp, cutoff=0.4, by="p.adjust", select_fun=min)
    
    gseGOResults[[varz]] <- tmp2@result %>% 
      as_tibble() %>% 
      mutate(Variable=varz, Library = var)
      }
  gseGOtable <- bind_rows(gseGOResults) %>% as_tibble %>% 
    # First we bind rows and make it a tibble
    dplyr::select(Variable,ID,Description, setSize, enrichmentScore, NES, p.adjust,rank, pvalue, core_enrichment) %>%
    # Then we pick the variables we want
    arrange(Variable,-enrichmentScore)
  
gseGOtable %>% write_csv(paste0("./sum/GIS analysis/",var,"/gsea_sig_CC.csv"), append=T, col_names = T)
}
```
###Figure 6A
```{r}
# read in Go term output from saved files
all_pos<-read_csv("./GI_quiescence/sum/GIS analysis/rim15/formula_res_all_pos.csv")
all_neg<-read_csv("./GI_quiescence/sum/GIS analysis/rim15/formula_res_all_neg.csv")

#remove the redundant terms for each condition manually
formula_res_pos_min <- read_csv("./GI_quiescence/sum/GIS analysis/rim15/formula_res_all_pos_min.csv")
#save TableS20: Functional annotation of gene clusters that are positively interacting with rim15 in quiescent cells. Original data for Fig6A.
write_csv(formula_res_pos_min, "./GI_quiescence/sum/tables/TableS20.csv")

formula_res_pos_min %>%
  separate(GeneRatio, c("numerator","denominator"), by = "/") %>%
  mutate(numerator = as.numeric(numerator), denominator = as.numeric(denominator)) %>%
  mutate(GeneRatio = numerator/denominator) %>%
  drop_na() %>%  
  ggplot(aes(x = condtion, y = reorder(Description,order), color = p.adjust, size =  GeneRatio)) +
  geom_point(aes(size = GeneRatio)) + 
  scale_size_continuous(range = c(7, 16)) + 
  xlab("")+
  ylab("")+
  scale_colour_gradient2(mid = "#FFFF00", high = "#FF6600") +
  theme(axis.text = element_text(color = "black", size = 12),
        panel.background = element_rect(fill = "NA", colour = "black", size = 4),
        panel.grid.major = element_line(colour="lightgrey", size = 0.3),
        panel.border = element_rect(colour = "black", fill=NA, size=5)) #+
  #theme(text = element_text(size=45),axis.text.x=element_text(angle=90),legend.position="right") +
  #theme_minimal()
ggsave(paste0(path, "Fig6A_up.pdf"), width = 10, height = 5.5)

#remove duplicated terms represented by the same gene group
formula_res_all_neg_min <- read_csv("./GI_quiescence/sum/GIS analysis/rim15/formula_res_all_neg_min.csv")

#save TableS21:Functional annotation of gene clusters that are negatively interacting with rim15 in quiescent cells. Original data for Fig6B.

write_csv(formula_res_all_neg_min, "./GI_quiescence/sum/tables/TableS21.csv")

formula_res_all_neg_min %>%
  separate(GeneRatio, c("numerator","denominator"), by = "/") %>%
  mutate(numerator = as.numeric(numerator), denominator = as.numeric(denominator)) %>%
  mutate(GeneRatio = numerator/denominator) %>%
  drop_na() %>%
  ggplot(aes(x = condtion, y = reorder(Description, order), color = p.adjust, size =  GeneRatio)) +
  geom_point(aes(size = GeneRatio)) +
  scale_size_continuous(range = c(4, 10)) + 
  ggtitle("Cellular Component")+
  xlab("")+
  ylab("")+
  scale_colour_gradient2(mid = "#99CCFF", high = "#003399") +
  theme(axis.text = element_text(color = "black", size = 12),
        panel.background = element_rect(fill = "NA", colour = "black", size = 4),
        panel.grid.major = element_line(colour="lightgrey", size = 0.3),
        panel.border = element_rect(colour = "black", fill=NA, size=5)) 
ggsave(paste0(path, "Fig6A_dn.pdf"))
```

##Figure 6B
###heatmap plot for nitrogen specific interactions with rim15 
```{r}
#read in the file
formula_res_pos_min <- read_csv("./GI_quiescence/sum/GIS analysis/rim15/formula_res_all_pos_min.csv")
N_specific_ERAD <- as.data.frame(formula_res_pos_min) %>%
  filter(condtion == "nitrogen_qui" & Description == "Hrd1p ubiquitin ligase ERAD-L complex")
N_specific_ERAD <- clusterProfiler::bitr(unlist(strsplit(N_specific_ERAD$geneID, "/")), fromType="ENTREZID", toType="COMMON", OrgDb=org.Sc.sgd.db::org.Sc.sgd.db)
N_specific_ERAD_unique <- N_specific_ERAD %>% distinct(SGD, .keep_all = TRUE)

#Read in the interaction table for those genes for heatmap plot
GI_VST_all_wtNormed<-read_csv("./GI_quiescence/sum/tables/TableS13.csv") %>%
  dplyr::rename(Systematic = Strain)

SystoSGD <- left_join(GI_VST_all_wtNormed, SystematicToSGDIDmapper,by="Systematic")
SystoCom <- clusterProfiler::bitr(SystoSGD$SGDID, fromType="SGD", toType="COMMON", OrgDb=org.Sc.sgd.db::org.Sc.sgd.db)
GI_VST_all_wtNormed_common <- left_join(SystoSGD, SystoCom %>% dplyr::rename(SGDID = SGD), by = "SGDID")

#specify mutants that is plot in the figure
#nutrient type could be carbon, nitrogen, or phosphate
GO_terms_n <- GI_VST_all_wtNormed_common %>%
      filter(nutrient == "nitrogen" & COMMON %in% N_specific_ERAD_unique$COMMON) 
#check the significants of ERAD genes 
super_sig_conds <- GO_terms_n %>%
      filter(q.value < 0.005)
View(super_sig_conds)

xl_sig_conds <- GO_terms_n %>%
      filter(q.value > 0.005 & q.value < 0.01)
View(xl_sig_conds)

sig_conds <- GO_terms_n %>%
      filter(q.value > 0.01 & q.value < 0.05)
View(sig_conds)

#heatmap for interaction changing in different nutrient and replicates
GI_VST_wtNormed_df <- GI_VST_all_wtNormed %>%
  dplyr::select(Systematic, nutrient, estimate, LibraryName, GrowStage) %>%
  unite(condition, nutrient, LibraryName, GrowStage) %>%
  spread(key = condition, value = estimate)

#overall
gr <- c("carbon_PHO85_G","carbon_RIM15_G","carbon_TOR1_G","nitrogen_PHO85_G","nitrogen_RIM15_G","nitrogen_TOR1_G", "phosphate_PHO85_G","phosphate_RIM15_G","phosphate_TOR1_G")
st <- c("carbon_PHO85_S","carbon_RIM15_S","carbon_TOR1_S","nitrogen_PHO85_S","nitrogen_RIM15_S","nitrogen_TOR1_S", "phosphate_PHO85_S","phosphate_RIM15_S","phosphate_TOR1_S")

#export ERAD genes interaction with TOR1, RIM15 and PHO85 in each condtion and generate interaction in cytoescape
colnames(YtoGene) <- c("Systematic","Gene")

ERAD_m <- left_join(GI_VST_wtNormed_df, YtoGene, by = "Systematic") %>%
  filter(Systematic %in% GO_terms_n$Systematic) %>%
  data.frame()

rownames(ERAD_m) <- ERAD_m$Gene

ERAD<-as.matrix(ERAD_m[,-c(1,ncol(ERAD_m))])

#heatmap for ERAD genes
pdf(paste0(path,"Fig6B.pdf"), width = 10, height = 5)
my_palette <- colorRampPalette(c("#003366","#3399FF","white","#FFCC33","#CC9900")) (n = 100)
 heatmap.2(ERAD[c(6,5,2,4,1,7,3),c(10,12,8,4,6,2,16,18,14,9,11,7,3,5,1,15,17,13)], col = my_palette, 
           distfun = dist, na.rm=TRUE, key = TRUE, keysize = 1.5, 
           margins = c(12,4),trace="none", hclustfun = hclust,  dendrogram = "none",
           density.info="none", srtCol=90, cexCol=0.8, cexRow = 0.7, Rowv=FALSE, Colv=FALSE) 
dev.off()
```

###FigureS6A
```{r}
# formula_res_all have been caculated in the previous chrunk
all_pos<-read_csv("./GI_quiescence/sum/GIS analysis/tor1/formula_res_all_pos.csv")
all_neg<-read_csv("./GI_quiescence/sum/GIS analysis/tor1/formula_res_all_neg.csv")

all_pos_vaculoe <- all_pos %>% 
  filter(condtion == "nitrogen_qui", Description == "lytic vacuole") %>%
  dplyr::select(geneID)

all_neg_vaculoe <- all_neg %>% 
  filter(condtion == "nitrogen_qui", Description == "lytic vacuole") %>%
  dplyr::select(geneID)

all_pos_vaculoe <- unlist(strsplit(all_pos_vaculoe$geneID,"/"))
all_neg_vaculoe <- unlist(strsplit(all_neg_vaculoe$geneID,"/"))

intersect(all_pos_vaculoe,all_neg_vaculoe)

#remove the redundant terms for each condition manually and read in the simplified files
formula_res_pos_min <- read_csv("./GI_quiescence/sum/GIS analysis/tor1/formula_res_all_pos_min.csv")

#save TableS22: gene clusters that a positively interacting with tor1 in quiescent cells. Original data for FigS6B
write_csv(formula_res_pos_min, "./GI_quiescence/sum/tables/TableS22.csv")


formula_res_pos_min %>%
  separate(GeneRatio, c("numerator","denominator"), by = "/") %>%
  mutate(numerator = as.numeric(numerator), denominator = as.numeric(denominator)) %>%
  mutate(GeneRatio = numerator/denominator) %>%
  drop_na() %>%  
  ggplot(aes(x = condtion, y = reorder(Description, order), color = p.adjust, size =  GeneRatio)) +
  geom_point(aes(size = GeneRatio)) + 
  scale_size_continuous(range = c(7, 16)) + 
  ggtitle("GO terms for genes positively interacting with TOR1")+
  xlab("")+
  ylab("")+
  scale_colour_gradient2(mid = "#FFFF00", high = "#FF6600") +
  theme(axis.text = element_text(color = "black", size = 15),
        panel.background = element_rect(fill = "NA", colour = "black", size = 4),
        panel.grid.major = element_line(colour="lightgrey", size = 0.3),
        panel.border = element_rect(colour = "black", fill=NA, size=5)) #+
  #theme(text = element_text(size=45),axis.text.x=element_text(angle=90),legend.position="right") +
  #theme_minimal()
ggsave(paste0(path, "FigS6A_up.pdf"), width = 10, height = 5.5)

#remove the redundant terms for each condition manually
formula_res_neg_min <- read_csv("./GI_quiescence/sum/GIS analysis/tor1/formula_res_all_neg_min.csv")

#save TableS23: gene clusters that a negatively interacting with tor1 in quiescent cells. Original data for FigS6B
write_csv(formula_res_neg_min, "./GI_quiescence/sum/tables/TableS23.csv")

formula_res_neg_min %>%
  separate(GeneRatio, c("numerator","denominator"), by = "/") %>%
  mutate(numerator = as.numeric(numerator), denominator = as.numeric(denominator)) %>%
  mutate(GeneRatio = numerator/denominator) %>%
  drop_na() %>%  
  ggplot(aes(x = condtion, y = reorder(Description, order), color = p.adjust, size =  GeneRatio)) +
  geom_point(aes(size = GeneRatio)) + 
  scale_size_continuous(range = c(7, 16)) + 
  ggtitle("GO terms for genes negativly interacting with TOR1")+
  xlab("")+
  ylab("")+
  scale_colour_gradient2(mid = "#99CCFF", high = "#003399") +
  theme(axis.text = element_text(color = "black", size = 12),
        panel.background = element_rect(fill = "NA", colour = "black", size = 4),
        panel.grid.major = element_line(colour="lightgrey", size = 0.3),
        panel.border = element_rect(colour = "black", fill=NA, size=5)) #+
  #theme(text = element_text(size=45),axis.text.x=element_text(angle=90),legend.position="right") +
  #theme_minimal()
ggsave(paste0(path, "FigS6A_dn.pdf"), width = 10, height = 5.5)
```

##FigureS6B
```{r}
VST_normalized_filtered <- read_csv("./GI_quiescence/sum/tables/TableS3.csv")[,-1]

#look at ERAD mutants
ERAD <- c("HRD1","HRD3","DFM1","YOS9","DER1","USA1","CUE1")
VST_normalized_filtered %>%
  filter(LibraryName %in% c("HO","RIM15"), Common %in% ERAD, nutrient == "nitrogen") %>%
  #unite(group, LibraryName, Common) %>%
  filter(Common %in% ERAD) %>%
  filter(SamplingTime %in% c("32","48","96","186","348")) %>%
  filter(!(Common == ERAD & LibraryName == ERAD)) %>%
  ggplot(aes(x=SamplingTime, y=Rela2WT, group=LibraryName, color=LibraryName)) +
  geom_point(aes(shape = LibraryName))+
  geom_smooth(method = "lm", aes(fill = LibraryName))+
  ggtitle("ERAD-L complex")+  
  ylab("Relatie frequency to wild type")+
  xlab("Hours post inoculation")+
  scale_color_manual(values=c("#C6C6C4","#EDA2CC","#EDB2DC","#98EAAC","#7DB1DB","#F2C68C"))+ #
  scale_fill_manual(values=c("#C6C6C4","#EDA2CC","#EDB2DC","#98EAAC","#7DB1DB","#F2C68C"))+ 
  facet_grid(~Common) +
  theme(legend.position="bottom")+
  theme_classic()
ggsave(paste0(path,"FigS6B.pdf"), width=9,height=5)
```

###GSEA on ranked interaction profile for each kinase
```{r, catch =F, eval = FALSE}
#note: this step requires a lot computational memory, suggest to run it on HPC
path = "./GI_quiescence/sum/plot/"
GI_VST_all_wtNormed<-read_csv("./sum/GIS analysis/TableS13.csv")[,-1]

YtoGene <- read.table("./sum/data/YORFtoGENE_2018")
colnames(YtoGene) <- c("Strain","Gene")

GI_VST_all <- left_join(GI_VST_all_wtNormed, YtoGene, by ="Strain")

datar <- GI_VST_all %>% 
  dplyr::select(nutrient, Strain, GrowStage, estimate, LibraryName, Gene) %>%
  dplyr::rename(Systematic = Strain, GI = estimate, query = LibraryName, Common = Gene) %>%
  unite(cond, nutrient, query, GrowStage, sep="_") %>%
  spread(key = cond, value = GI)

nPermutations <- 1e6

for (i in c("BP","CC","MF")) {
# A list for results holding
#  i="ALL"
  gseGO <- list()
  gseGOResults <- list() 

  for (varz in names(datar)[-c(1:2)]) {
    #varz = "carbon_PHO85_G"
    message(varz)
    message(" took ... ")
    print(system.time(
      {
      gene_list <- datar[order(datar[[varz]],decreasing=T),] %>%
        left_join(SystematicToSGDIDmapper, by="Systematic")%>%
        {clusterProfiler::bitr(.$SGDID, fromType="SGD",toType="ENTREZID"
                               ,OrgDb=org.Sc.sgd.db::org.Sc.sgd.db)}
    
      gene_data <- datar[order(datar[[varz]],decreasing=T),] %>%
        left_join(SystematicToSGDIDmapper, by="Systematic") %>%
        dplyr::select(varz, SGDID) %>%
        dplyr::rename(SGD = SGDID)
    
      this_gene_list <- left_join(gene_list, gene_data, by = "SGD") %>%
        dplyr::select(-SGD)
    
      rownames(this_gene_list) <- this_gene_list$ENTREZID
    
      gene_list<- this_gene_list %>% dplyr::select (-ENTREZID)

      gene_list<-data.matrix(gene_list, rownames.force = NA) [-1,]

      gseGO[[varz]] <- clusterProfiler::gseGO(
        geneList=gene_list, keyType = "ENTREZID",
        OrgDb = org.Sc.sgd.db::org.Sc.sgd.db,
        ont = i, 
        minGSSize=3,maxGSSize=800,
        pAdjustMethod="fdr",
        pvalueCutoff=0.05, seed="seedy",
        nPerm=nPermutations
        )
      
      gseGOResults[[varz]] <- gseGO[[varz]]@result %>% 
        as_tibble() %>% 
        mutate(Variable=varz)
      }
    ))
    }
  gseGOtable <- bind_rows(gseGOResults) %>% as_tibble %>% 
    # First we bind rows and make it a tibble
    dplyr::select(Variable,ID,Description, setSize, enrichmentScore, NES, p.adjust,rank, pvalue, core_enrichment) %>%
    # Then we pick the variables we want
    arrange(Variable,-enrichmentScore)
  gseGOtable %>% write_csv(path=paste0("./GI_quiescence/sum/GIS analysis/output_table_gseGO_GI_",i,".csv"), append=T, col_names = T)
}
```